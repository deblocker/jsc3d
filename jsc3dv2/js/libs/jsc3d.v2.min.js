var JSC3D=JSC3D||{}
JSC3D.Viewer=function(t,e){e?this.params={SceneUrl:e.SceneUrl||"",InitRotationX:e.InitRotationX||0,InitRotationY:e.InitRotationY||0,InitRotationZ:e.InitRotationZ||0,SceneRotation:e.SceneRotation||"off",InitSceneRotation:e.InitSceneRotation||0,ModelColor:e.ModelColor||"#caa618",BackgroundColor1:e.BackgroundColor1||"#ffffff",BackgroundColor2:e.BackgroundColor2||"#383840",BackgroundImageUrl:e.BackgroundImageUrl||"",Background:e.Background||"on",RenderMode:e.RenderMode||"flat",Definition:e.Definition||"standard",FaceCulling:e.FaceCulling||"on",MipMapping:e.MipMapping||"off",CreaseAngle:e.CreaseAngle||-180,SphereMapUrl:e.SphereMapUrl||"",ProgressBar:e.ProgressBar||"on",Renderer:e.Renderer||"",AutoUpdate:e.AutoUpdate||"off",AutoRotateSpeed:e.AutoRotateSpeed||0,LightingMode:e.LightingMode||"standard",LocalBuffers:e.LocalBuffers||"retain"}:this.params={SceneUrl:"",InitRotationX:0,InitRotationY:0,InitRotationZ:0,InitSceneRotation:0,SceneRotation:"off",ModelColor:"#caa618",BackgroundColor1:"#ffffff",BackgroundColor2:"#383840",BackgroundImageUrl:"",Background:"on",RenderMode:"flat",Definition:"standard",FaceCulling:"on",MipMapping:"off",CreaseAngle:-180,SphereMapUrl:"",ProgressBar:"on",Renderer:"",AutoUpdate:"off",AutoRotateSpeed:0,LightingMode:"standard",LocalBuffers:"retain"},this.canvas=t,this.ctx2d=null,this.canvasData=null,this.bkgColorBuffer=null,this.colorBuffer=null,this.zBuffer=null,this.selectionBuffer=null,this.frameWidth=null,this.frameHeight=null,this.scene=null,this.textures=[],this.materials=[],this.defaultMaterial=null,this.sphereMap=null,this.isLoaded=!1,this.isFailed=!1,this.abortUnfinishedLoadingFn=null,this.needUpdate=!1,this.needRepaint=!1,this.initRotX=0,this.initRotY=0,this.initRotZ=0,this.initSceneRotation=0,this.sceneRotation=0,this.isSceneRotationEnabled=!1,this.zoomFactor=1,this.panning=[0,0],this.rotation=[0,0,0],this.fps=0,this.frameNumber=0,this.rotMatrix=new JSC3D.Matrix3x4,this.transformMatrix=new JSC3D.Matrix3x4,this.sceneUrl="",this.modelColor=13280792,this.bkgColor1=16777215,this.bkgColor2=3684416,this.bkgImageUrl="",this.bkgImage=null,this.isBackgroundOn=!0,this.renderMode="flat",this.definition="standard",this.isCullingDisabled=!1,this.isMipMappingOn=!1,this.creaseAngle=-180,this.sphereMapUrl="",this.isAutoUpdateOn=!1,this.autoRotateSpeed=0,this.lightingMode="standard",this.showLights=!1,this.showProgressBar=!0,this.buttonStates={},this.keyStates={},this.mouseX=0,this.mouseY=0,this.mouseDownX=-1,this.mouseDownY=-1,this.isTouchHeld=!1,this.baseZoomFactor=1,this.suppressDraggingRotation=!1,this.onloadingstarted=null,this.onloadingcomplete=null,this.onloadingprogress=null,this.onloadingaborted=null,this.onloadingerror=null,this.onmousedown=null,this.onmouseup=null,this.onmousemove=null,this.onmousewheel=null,this.onmouseclick=null,this.beforeupdate=null,this.afterupdate=null,this.onscenerotation=null,this.ontick=null,this.mouseUsage="default",this.isDefaultInputHandlerEnabled=!0,this.progressFrame=null,this.progressRectangle=null,this.messagePanel=null,this.webglBackend=null
var i=this
JSC3D.PlatformInfo.isTouchCapable?JSC3D.Hammer?JSC3D.Hammer(this.canvas).on("touch release hold drag pinch transformend",function(t){i.gestureHandler(t)}):(this.canvas.addEventListener("touchstart",function(t){i.touchStartHandler(t)},!1),this.canvas.addEventListener("touchend",function(t){i.touchEndHandler(t)},!1),this.canvas.addEventListener("touchmove",function(t){i.touchMoveHandler(t)},!1),this.canvas.addEventListener("touchcancel",function(t){i.touchCancelHandler(t)},!1),this.canvas.addEventListener("touchleave",function(t){i.touchCancelHandler(t)},!1)):(this.canvas.addEventListener("mousedown",function(t){i.mouseDownHandler(t)},!1),this.canvas.addEventListener("mouseup",function(t){i.mouseUpHandler(t)},!1),this.canvas.addEventListener("mousemove",function(t){i.mouseMoveHandler(t)},!1),document.addEventListener("keydown",function(t){i.keyDownHandler(t)},!1),document.addEventListener("keyup",function(t){i.keyUpHandler(t)},!1)),this.canvas.addEventListener("onwheel"in document?"wheel":"onmousewheel"in document?"mousewheel":"DOMMouseScroll",function(t){i.mouseWheelHandler(t)})},JSC3D.Viewer.prototype.setParameter=function(t,e){this.params[t]=e},JSC3D.Viewer.prototype.setParameters=function(t){for(var e in t){var i=t[e]
this.params[e]=i}},JSC3D.Viewer.prototype.init=function(){this.sceneUrl=this.params.SceneUrl,this.initRotX=parseFloat(this.params.InitRotationX),this.initRotY=parseFloat(this.params.InitRotationY),this.initRotZ=parseFloat(this.params.InitRotationZ),this.modelColor=parseInt("0x"+this.params.ModelColor.substring(1)),this.bkgColor1=parseInt("0x"+this.params.BackgroundColor1.substring(1)),this.bkgColor2=parseInt("0x"+this.params.BackgroundColor2.substring(1)),this.bkgImageUrl=this.params.BackgroundImageUrl,this.isBackgroundOn="on"==this.params.Background.toLowerCase(),this.renderMode=this.params.RenderMode.toLowerCase(),this.definition=this.params.Definition.toLowerCase(),this.isCullingDisabled="off"==this.params.FaceCulling.toLowerCase(),this.creaseAngle=parseFloat(this.params.CreaseAngle),this.isMipMappingOn="on"==this.params.MipMapping.toLowerCase(),this.sphereMapUrl=this.params.SphereMapUrl,this.showProgressBar="on"==this.params.ProgressBar.toLowerCase(),this.useWebGL="webgl"==this.params.Renderer.toLowerCase(),this.isAutoUpdateOn="on"==this.params.AutoUpdate.toLowerCase(),this.autoRotateSpeed=parseFloat(this.params.AutoRotateSpeed),this.releaseLocalBuffers="release"==this.params.LocalBuffers.toLowerCase(),this.isSceneRotationEnabled="on"==this.params.SceneRotation.toLowerCase(),this.initSceneRotation=parseFloat(this.params.InitSceneRotation),this.lightingMode=this.params.LightingMode.toLowerCase(),"default"==this.definition&&(this.definition=JSC3D.PlatformInfo.profile)
var t=this.getInnerSize()
if(this.canvas.width=t[0],this.canvas.height=t[1],this.useWebGL&&JSC3D.PlatformInfo.supportWebGL&&JSC3D.WebGLRenderBackend)try{this.webglBackend=new JSC3D.WebGLRenderBackend(this.canvas,this.releaseLocalBuffers),this.webglBackend.isLightingOn="standard"!=this.lightingMode}catch(e){}if(!this.webglBackend){this.useWebGL&&JSC3D.console&&JSC3D.console.logWarning("WebGL is not available. Software rendering is enabled instead.")
try{this.ctx2d=this.canvas.getContext("2d"),this.canvasData=this.ctx2d.getImageData(0,0,this.canvas.width,this.canvas.height)}catch(e){this.ctx2d=null,this.canvasData=null}}switch((this.canvas.width<=2||this.canvas.height<=2)&&(this.definition="standard"),this.definition){case"low":this.frameWidth=~~((this.canvas.width+1)/2),this.frameHeight=~~((this.canvas.height+1)/2)
break
case"high":this.frameWidth=2*this.canvas.width,this.frameHeight=2*this.canvas.height
break
case"standard":default:this.frameWidth=this.canvas.width,this.frameHeight=this.canvas.height}this.zoomFactor=1,this.panning=[0,0],this.rotation=[0,0,0],this.rotMatrix.identity(),this.transformMatrix.identity(),this.isLoaded=!1,this.isFailed=!1,this.needUpdate=!1,this.needRepaint=!1,this.scene=null,this.defaultMaterial=new JSC3D.Material("default",void 0,this.modelColor),this.webglBackend||(this.colorBuffer=Array(this.frameWidth*this.frameHeight),this.zBuffer=Array(this.frameWidth*this.frameHeight),this.selectionBuffer=Array(this.frameWidth*this.frameHeight),this.bkgColorBuffer=Array(this.frameWidth*this.frameHeight)),this.generateBackground(),this.drawBackground(),this.isAutoUpdateOn||0==this.autoRotateSpeed||JSC3D.console&&JSC3D.console.logWarning("AutoRotate need to have AutoUpdate switched on!"),this.webglBackend||(this.lightingMode="standard")
var i=this,r=1*new Date
!function s(){var t=1e3/30,e=window.performance&&window.performance.now?window.performance.now():Date.now()
i.frameTargetTime&&e<i.frameTargetTime&&(e=i.frameTargetTime+.01)
var a=t-e%t
i.frameTargetTime=e+a
var o=1e3/(e-r)
e!=r&&(i.fps+=(o-i.fps)/30,r=e),(i.ctx2d||i.webglBackend)&&(i.frameNumber++,i.doUpdate(),null!=i.ontick&&"function"==typeof i.ontick&&i.ontick()),i.isAutoUpdateOn&&setTimeout(s,a)}(),this.setBackgroudImageFromUrl(this.bkgImageUrl),this.loadScene(),this.setSphereMapFromUrl(this.sphereMapUrl)},JSC3D.Viewer.prototype.update=function(t){this.isFailed||(t?this.needRepaint=!0:this.needUpdate=!0,this.isAutoUpdateOn||(this.needUpdate=!0,this.doUpdate()))},JSC3D.Viewer.prototype.createScene=function(t,e,i,r,s,a){this.abortUnfinishedLoadingFn&&this.abortUnfinishedLoadingFn(),this.scene=null,this.isLoaded=!1,this.update()
var o=new JSC3D.Scene
o.aabb=new JSC3D.AABB,o.aabb.minX=t,o.aabb.maxX=e,o.aabb.minY=i,o.aabb.maxY=r,o.aabb.minZ=s,o.aabb.maxZ=a,this.replaceScene(o)},JSC3D.Viewer.prototype.getInnerSize=function(){var t=window.getComputedStyle(this.canvas),e=parseInt(t.paddingLeft)+parseInt(t.paddingRight),i=parseInt(t.paddingTop)+parseInt(t.paddingBottom)
return[this.canvas.clientWidth-e,this.canvas.clientHeight-i]},JSC3D.Viewer.prototype.rotate=function(t,e,i){this.rotateAboutXAxis(t),this.rotateAboutYAxis(e),this.rotateAboutZAxis(i)},JSC3D.Viewer.prototype.calcRotation=function(){var t=this.rotMatrix,e=180/Math.PI,i=Math.atan2(-t.m12,t.m22),r=Math.sqrt(t.m00*t.m00+t.m01*t.m01),s=Math.atan2(t.m02,r),a=Math.sin(i),o=Math.cos(i),n=Math.atan2(-a*t.m20+o*t.m10,o*t.m11+a*t.m21),h=i*e,l=s*e,f=n*e
this.rotation[0]=h,this.rotation[1]=l,this.rotation[2]=f},JSC3D.Viewer.prototype.rotateAboutXAxis=function(t){t&&(t%=360,this.rotMatrix.rotateAboutXAxis(t))},JSC3D.Viewer.prototype.rotateAboutYAxis=function(t){t&&(t%=360,this.rotMatrix.rotateAboutYAxis(t))},JSC3D.Viewer.prototype.rotateAboutZAxis=function(t){t&&(t%=360,this.rotMatrix.rotateAboutZAxis(t))},JSC3D.Viewer.prototype.rotateScene=function(t){if(t){t%=360
var e=this.initRotX,i=this.initRotZ
this.rotMatrix.rotateAboutXAxis(-e),this.rotMatrix.rotateAboutZAxis(-i),this.rotMatrix.rotateAboutYAxis(t),this.rotMatrix.rotateAboutZAxis(i),this.rotMatrix.rotateAboutXAxis(e)}switch(this.sceneRotation+=t,!0){case this.sceneRotation>=180:this.sceneRotation-=360
break
case this.sceneRotation<=-180:this.sceneRotation+=360}if(this.calcRotation(),null!=this.onscenerotation&&"function"==typeof this.onscenerotation){var r=this
r.onscenerotation(r.sceneRotation)}},JSC3D.Viewer.prototype.autoRotateScene=function(){0!=this.autoRotateSpeed&&(this.rotateScene(this.autoRotateSpeed),this.needUpdate=!0)},JSC3D.Viewer.prototype.setRenderMode=function(t){this.params.RenderMode=t,this.renderMode=t},JSC3D.Viewer.prototype.setDefinition=function(t){if((this.canvas.width<=2||this.canvas.height<=2)&&(t="standard"),t!=this.definition){this.params.Definition=t,this.definition=t
var e=this.frameWidth
switch(this.definition){case"low":this.frameWidth=~~((this.canvas.width+1)/2),this.frameHeight=~~((this.canvas.height+1)/2)
break
case"high":this.frameWidth=2*this.canvas.width,this.frameHeight=2*this.canvas.height
break
case"standard":default:this.frameWidth=this.canvas.width,this.frameHeight=this.canvas.height}var i=this.frameWidth/e
if(this.zoomFactor*=i,this.panning[0]*=i,this.panning[1]*=i,!this.webglBackend){var r=this.frameWidth*this.frameHeight
this.colorBuffer.length<r&&(this.colorBuffer=Array(r)),this.zBuffer.length<r&&(this.zBuffer=Array(r)),this.selectionBuffer.length<r&&(this.selectionBuffer=Array(r)),this.bkgColorBuffer.length<r&&(this.bkgColorBuffer=Array(r)),this.generateBackground()}}},JSC3D.Viewer.prototype.setBackgroudImageFromUrl=function(t){if(this.params.BackgroundImageUrl=t,this.bkgImageUrl=t,""==t)return void(this.bkgImage=null)
var e=this,i=new Image
i.onload=function(){e.bkgImage=this,e.generateBackground()},i.crossOrigin="anonymous",i.src=encodeURI(t)},JSC3D.Viewer.prototype.setSphereMapFromUrl=function(t){if(this.params.SphereMapUrl=t,this.sphereMapUrl=t,""==t)return void(this.sphereMap=null)
var e=this,i=new JSC3D.Texture
i.onready=function(){e.sphereMap=i,e.update()},i.createFromUrl(this.sphereMapUrl)},JSC3D.Viewer.prototype.addTexture=function(t,e){var i=t.replace(/^.*(\\|\/|\:)/,""),r=i.substr(0,i.lastIndexOf("."))||i+"",s=new JSC3D.Texture(r)
s.createFromUrl(t),s.isLightingCast=e||!1,s.isEnvironmentCast=!1,this.textures.push(s)},JSC3D.Viewer.prototype.getTexture=function(t){if(t)for(var e=0,i=this.textures.length;i>e;e++){var r=this.textures[e]
if(r.name==t)return r}return null},JSC3D.Viewer.prototype.addMaterial=function(t,e,i,r,s,a,o,n,h,l,f){var u=new JSC3D.Material(t,e,i,r,s,a,o,n,h,l,f)
this.materials.push(u)},JSC3D.Viewer.prototype.getMaterial=function(t){if(t)for(var e=0,i=this.materials.length;i>e;e++){var r=this.materials[e]
if(r.name==t)return r}return null},JSC3D.Viewer.prototype.enableDefaultInputHandler=function(t){this.isDefaultInputHandlerEnabled=t},JSC3D.Viewer.prototype.enableSceneRotation=function(t){this.isSceneRotationEnabled=t},JSC3D.Viewer.prototype.setMouseUsage=function(t){this.mouseUsage=t},JSC3D.Viewer.prototype.isWebGLEnabled=function(){return null!=this.webglBackend},JSC3D.Viewer.prototype.replaceSceneFromUrl=function(t){this.params.SceneUrl=t,this.sceneUrl=t,this.isFailed=this.isLoaded=!1,this.loadScene()},JSC3D.Viewer.prototype.replaceScene=function(t){this.params.SceneUrl="",this.sceneUrl="",this.isFailed=!1,this.isLoaded=!0,this.setupScene(t)},JSC3D.Viewer.prototype.resetScene=function(){var t=!this.scene||this.scene.isEmpty()?0:this.scene.aabb.lengthOfDiagonal()
this.zoomFactor=0==t?1:(this.frameWidth<this.frameHeight?this.frameWidth:this.frameHeight)/t,this.panning=[0,0],this.currentMesh=null,this.rotMatrix.identity(),this.scene.isLightingOn="standard"!=this.lightingMode,this.scene.isLightingOn&&this.setup3PointLighting(this.lightingMode,this.showLights),this.sceneRotation=0,this.rotateAboutXAxis(this.initRotX),this.rotateAboutYAxis(this.initRotY),this.rotateAboutZAxis(this.initRotZ),this.rotateScene(this.initSceneRotation)},JSC3D.Viewer.prototype.getScene=function(){return this.scene},JSC3D.Viewer.prototype.pick=function(t,e){var i=new JSC3D.PickInfo,r=this.canvas.getBoundingClientRect(),s=t-r.left,a=e-r.top
i.canvasX=s,i.canvasY=a
var o=0
if(this.webglBackend)o=this.webglBackend.pick(s,a)
else{var n=s,h=a
if(null!=this.selectionBuffer&&s>=0&&s<this.canvas.width&&a>=0&&a<this.canvas.height){switch(this.definition){case"low":n=~~(n/2),h=~~(h/2)
break
case"high":n*=2,h*=2
break
case"standard":}o=this.selectionBuffer[h*this.frameWidth+n],o>0&&(i.depth=this.zBuffer[h*this.frameWidth+n])}}if(o>0)for(var l=this.scene.getChildren(),f=0;f<l.length;f++)if(l[f].internalId==o){i.mesh=l[f]
break}return i},JSC3D.Viewer.prototype.doUpdate=function(){this.autoRotateScene(),(this.needUpdate||this.needRepaint)&&(null!=this.beforeupdate&&"function"==typeof this.beforeupdate&&this.beforeupdate(),this.scene?(this.needUpdate&&(this.beginScene(),this.render(),this.endScene()),this.paint()):this.drawBackground(),this.needRepaint=!1,this.needUpdate=!1,null!=this.afterupdate&&"function"==typeof this.afterupdate&&this.afterupdate())},JSC3D.Viewer.prototype.paint=function(){!this.webglBackend&&this.ctx2d&&this.ctx2d.putImageData(this.canvasData,0,0)},JSC3D.Viewer.prototype.mouseDownHandler=function(t){if(this.isLoaded){if(this.onmousedown){var e=this.pick(t.clientX,t.clientY)
this.scene.currentMesh=e.mesh
e.mesh?e.mesh.getGroupName():null
this.onmousedown(e.canvasX,e.canvasY,t.button,e.depth,e.mesh)}t.preventDefault(),t.stopPropagation(),this.isDefaultInputHandlerEnabled&&(this.buttonStates[t.button]=!0,this.mouseX=t.clientX,this.mouseY=t.clientY,this.mouseDownX=t.clientX,this.mouseDownY=t.clientY)}},JSC3D.Viewer.prototype.mouseUpHandler=function(t){if(this.isLoaded){var e;(this.onmouseup||this.onmouseclick)&&(e=this.pick(t.clientX,t.clientY)),this.onmouseup&&this.onmouseup(e.canvasX,e.canvasY,t.button,e.depth,e.mesh),this.onmouseclick&&this.mouseDownX==t.clientX&&this.mouseDownY==t.clientY&&(this.onmouseclick(e.canvasX,e.canvasY,t.button,e.depth,e.mesh),this.mouseDownX=-1,this.mouseDownY=-1),t.preventDefault(),t.stopPropagation(),this.isTouchHeld=!1,this.suppressDraggingRotation=!1,this.isDefaultInputHandlerEnabled&&(this.buttonStates[t.button]=!1)}},JSC3D.Viewer.prototype.mouseClickHandler=function(t){if(this.isLoaded){var e
this.onmouseclick&&this.mouseDownX==t.clientX&&this.mouseDownY==t.clientY&&(e=this.pick(t.clientX,t.clientY),this.onmouseclick(e.canvasX,e.canvasY,t.button,e.depth,e.mesh),this.mouseDownX=-1,this.mouseDownY=-1),t.preventDefault(),t.stopPropagation(),this.isTouchHeld=!1,this.suppressDraggingRotation=!1,this.isDefaultInputHandlerEnabled&&(this.buttonStates[t.button]=!1)}},JSC3D.Viewer.prototype.mouseMoveHandler=function(t){if(this.isLoaded){if(this.onmousemove){var e=this.pick(t.clientX,t.clientY)
this.onmousemove(e.canvasX,e.canvasY,t.button,e.depth,e.mesh)}if(t.preventDefault(),t.stopPropagation(),this.isDefaultInputHandlerEnabled){var i=1==this.buttonStates[0],r=1==this.keyStates[16],s=1==this.keyStates[17]
if(i){if(r&&"default"==this.mouseUsage||"zoom"==this.mouseUsage)this.zoomFactor*=this.mouseY<=t.clientY?1.04:.96
else if(s&&"default"==this.mouseUsage||"pan"==this.mouseUsage){var a="low"==this.definition?.5:"high"==this.definition?2:1
this.panning[0]+=a*(t.clientX-this.mouseX),this.panning[1]+=a*(t.clientY-this.mouseY)}else if("default"==this.mouseUsage||"rotate"==this.mouseUsage){var o=360*(t.clientY-this.mouseY)/this.canvas.width,n=360*(t.clientX-this.mouseX)/this.canvas.height
this.isSceneRotationEnabled?this.rotateScene(n):(this.rotateAboutXAxis(o),this.rotateAboutYAxis(n))}this.mouseX=t.clientX,this.mouseY=t.clientY,this.mouseDownX=-1,this.mouseDownY=-1,this.update()}}}},JSC3D.Viewer.prototype.mouseWheelHandler=function(t){if(this.isLoaded){if(this.onmousewheel){var e=this.pick(t.clientX,t.clientY)
this.onmousewheel(e.canvasX,e.canvasY,t.button,e.depth,e.mesh)}t.preventDefault(),t.stopPropagation(),this.isDefaultInputHandlerEnabled&&(this.mouseDownX=-1,this.mouseDownY=-1,this.zoomFactor*=(t.wheelDelta?t.wheelDelta:t.deltaY?-t.deltaY:-t.detail)<0?1.1:.91,this.update())}},JSC3D.Viewer.prototype.touchStartHandler=function(t){if(this.isLoaded&&t.touches.length>0){var e=t.touches[0].clientX,i=t.touches[0].clientY
if(this.onmousedown){var r=this.pick(e,i)
this.scene.currentMesh=r.mesh
r.mesh?r.mesh.getGroupName():null
this.onmousedown(r.canvasX,r.canvasY,0,r.depth,r.mesh)}if(t.preventDefault(),t.stopPropagation(),!this.isDefaultInputHandlerEnabled)return
this.buttonStates[0]=!0,this.mouseX=e,this.mouseY=i,this.mouseDownX=e,this.mouseDownY=i}},JSC3D.Viewer.prototype.touchEndHandler=function(t){if(this.isLoaded){var e;(this.onmouseup||this.onmouseclick)&&(e=this.pick(this.mouseX,this.mouseY)),this.onmouseup&&this.onmouseup(e.canvasX,e.canvasY,0,e.depth,e.mesh),this.onmouseclick&&this.mouseDownX==t.touches[0].clientX&&this.mouseDownY==t.touches[0].clientY&&(this.onmouseclick(e.canvasX,e.canvasY,0,e.depth,e.mesh),this.mouseDownX=-1,this.mouseDownY=-1),t.preventDefault(),t.stopPropagation(),this.isDefaultInputHandlerEnabled&&(this.buttonStates[0]=!1)}},JSC3D.Viewer.prototype.touchMoveHandler=function(t){if(this.isLoaded&&t.touches.length>0){var e=t.touches[0].clientX,i=t.touches[0].clientY
if(this.onmousemove){var r=this.pick(e,i)
this.onmousemove(r.canvasX,r.canvasY,0,r.depth,r.mesh)}if(t.preventDefault(),t.stopPropagation(),!this.isDefaultInputHandlerEnabled)return
if("zoom"==this.mouseUsage)this.zoomFactor*=this.mouseY<=i?1.04:.96
else if("pan"==this.mouseUsage){var s="low"==this.definition?.5:"high"==this.definition?2:1
this.panning[0]+=s*(e-this.mouseX),this.panning[1]+=s*(i-this.mouseY)}else if("default"==this.mouseUsage||"rotate"==this.mouseUsage){var a=360*(i-this.mouseY)/this.canvas.width,o=360*(e-this.mouseX)/this.canvas.height
this.isSceneRotationEnabled?this.rotateScene(o):(this.rotateAboutXAxis(a),this.rotateAboutYAxis(o))}this.mouseX=e,this.mouseY=i,this.mouseDownX=-1,this.mouseDownY=-1,this.update()}},JSC3D.Viewer.prototype.touchCancelHandler=function(t){if(this.isLoaded&&t.touches.length>0){if(t.preventDefault(),t.stopPropagation(),!this.isDefaultInputHandlerEnabled)return
this.buttonStates[0]=!1,this.mouseDownX=-1,this.mouseDownY=-1,this.update()}},JSC3D.Viewer.prototype.keyDownHandler=function(t){this.isDefaultInputHandlerEnabled&&(this.keyStates[t.keyCode]=!0)},JSC3D.Viewer.prototype.keyUpHandler=function(t){this.isDefaultInputHandlerEnabled&&(this.keyStates[t.keyCode]=!1)},JSC3D.Viewer.prototype.gestureHandler=function(t){if(this.isLoaded){var e=t.gesture.center.pageX-document.body.scrollLeft,i=t.gesture.center.pageY-document.body.scrollTop,r=this.pick(e,i)
r.mesh?r.mesh.getGroupName():null
switch(t.type){case"touch":this.onmousedown&&this.onmousedown(r.canvasX,r.canvasY,0,r.depth,r.mesh),this.baseZoomFactor=this.zoomFactor,this.mouseX=e,this.mouseY=i,this.mouseDownX=e,this.mouseDownY=i
break
case"release":this.onmouseup&&this.onmouseup(r.canvasX,r.canvasY,0,r.depth,r.mesh),this.onmouseclick&&this.mouseDownX==e&&this.mouseDownY==i&&this.onmouseclick(r.canvasX,r.canvasY,0,r.depth,r.mesh),this.mouseDownX=-1,this.mouseDownY=-1,this.isTouchHeld=!1
break
case"hold":this.isTouchHeld=!0,this.mouseDownX=-1,this.mouseDownY=-1
break
case"drag":if(this.onmousemove&&this.onmousemove(r.canvasX,r.canvasY,0,r.depth,r.mesh),!this.isDefaultInputHandlerEnabled)break
if(this.isTouchHeld){var s="low"==this.definition?.5:"high"==this.definition?2:1
this.panning[0]+=s*(e-this.mouseX),this.panning[1]+=s*(i-this.mouseY)}else if(!this.suppressDraggingRotation){var a=360*(i-this.mouseY)/this.canvas.width,o=360*(e-this.mouseX)/this.canvas.height
this.isSceneRotationEnabled?this.rotateScene(o):(this.rotateAboutXAxis(a),this.rotateAboutYAxis(o))}this.mouseX=e,this.mouseY=i,this.mouseDownX=-1,this.mouseDownY=-1,this.update()
break
case"pinch":if(this.onmousewheel&&this.onmousewheel(r.canvasX,r.canvasY,0,r.depth,r.mesh),!this.isDefaultInputHandlerEnabled)break
this.suppressDraggingRotation=!0,this.zoomFactor=this.baseZoomFactor*t.gesture.scale,this.mouseDownX=-1,this.mouseDownY=-1,this.update()
break
case"transformend":var n=this
setTimeout(function(){n.suppressDraggingRotation=!1},250)}t.gesture.preventDefault(),t.gesture.stopPropagation()}},JSC3D.Viewer.prototype.resize=function(){var t=this.getInnerSize(),e=t[0],i=t[1],r=this.frameWidth,s=this.frameHeight
if(e*i!=0){var a=0,o=0
switch(this.definition){case"low":a=~~((e+1)/2),o=~~((i+1)/2)
break
case"high":a=2*e,o=2*i
break
case"standard":default:a=e,o=i}if(a!=r||o!=s){this.canvas.width=e,this.canvas.height=i
var n=a/r
if(this.zoomFactor*=n,this.panning[0]*=n,this.panning[1]*=n,this.frameWidth=a,this.frameHeight=o,this.webglBackend)this.webglBackend.resizeFrame(e,i)
else if(this.ctx2d){this.canvasData=this.ctx2d.getImageData(0,0,this.canvas.width,this.canvas.height)
var h=a*o
this.colorBuffer.length<h&&(this.colorBuffer=Array(h)),this.zBuffer.length<h&&(this.zBuffer=Array(h)),this.selectionBuffer.length<h&&(this.selectionBuffer=Array(h)),this.bkgColorBuffer.length<h&&(this.bkgColorBuffer=Array(h))}this.isLoaded&&(this.generateBackground(),this.needUpdate=!0,this.doUpdate())}}},JSC3D.Viewer.prototype.setup3PointLighting=function(t,e){var i="greyscale"==t,r=this.scene.aabb
this.scene.xformMat.identity(),this.scene.lights=[]
for(var s=[{position:[r.minX,.1*r.maxY,0],diffuse:i?4473924:16711680,enabled:!0},{position:[0,.5*r.maxY,r.maxZ],diffuse:i?6710886:65280,enabled:!0},{position:[r.maxX,r.maxY,r.minZ],diffuse:i?13355979:255,enabled:!0}],a=0,o=s.length;o>a;a++){var n=s[a].enabled&&e,h=s[a].enabled&&"standard"!=t
this.scene.addLight(s[a].position[0],s[a].position[1],s[a].position[2],s[a].ambient,s[a].diffuse,h,n)}},JSC3D.Viewer.prototype.rotateLights=function(){if(this.scene){for(var t=this.scene.getMeshes("light"),e=0,i=t.length-1;i>e;e++){var r=t[e]
switch(r.groupIndex){case 1:r.rotate([0,1,1])
break
case 2:r.rotate([1,1,0])
break
case 3:r.rotate([0,1,1])}var s=r.aabb.center()
this.scene.lights[e].position=[s[0],s[1],s[2]],this.scene.lights[e].compiled=null}this.needUpdate=!0}},JSC3D.Viewer.prototype.loadScene=function(){if(this.abortUnfinishedLoadingFn&&this.abortUnfinishedLoadingFn(),this.scene=null,this.isLoaded=!1,this.update(),""==this.sceneUrl)return!1
var t=this.sceneUrl.indexOf("?"),e=-1==t?this.sceneUrl:this.sceneUrl.substring(0,t),i=e.lastIndexOf("/");-1==i&&(i=e.lastIndexOf("\\"))
var r=e.substring(i+1),s=r.lastIndexOf(".")
if(-1==s)return JSC3D.console&&JSC3D.console.logError("Cannot get file format for the lack of file extension."),!1
var a=r.substring(s+1),o=JSC3D.LoaderSelector.getLoader(a)
if(!o)return JSC3D.console&&JSC3D.console.logError('Unsupported file format: "'+a+'".'),!1
var n=this
return o.onload=function(t){n.abortUnfinishedLoadingFn=null,n.setupScene(t),n.onloadingcomplete&&"function"==typeof n.onloadingcomplete&&n.onloadingcomplete()},o.onerror=function(t){n.scene=null,n.isLoaded=!1,n.isFailed=!0,n.abortUnfinishedLoadingFn=null,n.update(),n.reportError(t),n.onloadingerror&&"function"==typeof n.onloadingerror&&n.onloadingerror(t)},o.onprogress=function(t,e){n.showProgressBar&&n.reportProgress(t,e),n.onloadingprogress&&"function"==typeof n.onloadingprogress&&n.onloadingprogress(t,e)},o.onresource=function(t){t instanceof JSC3D.Texture&&n.isMipMappingOn&&!t.hasMipmap()&&t.generateMipmaps(),n.update()},this.abortUnfinishedLoadingFn=function(){o.abort(),n.abortUnfinishedLoadingFn=null,n.hideProgress(),n.onloadingaborted&&"function"==typeof n.onloadingaborted&&n.onloadingaborted()},o.loadFromUrl(this.sceneUrl),this.onloadingstarted&&"function"==typeof this.onloadingstarted&&this.onloadingstarted(),!0},JSC3D.Viewer.prototype.setupScene=function(t){if(this.creaseAngle>=0){var e=this.creaseAngle
t.forEachChild(function(t){t.creaseAngle=e})}if(t.init(),t.aabb){var i=t.aabb.lengthOfDiagonal(),r=this.frameWidth,s=this.frameHeight
this.zoomFactor=0==i?1:(s>r?r:s)/i,this.panning=[0,0]}this.rotMatrix.identity(),this.sceneRotation=0,this.rotateAboutXAxis(this.initRotX),this.rotateAboutYAxis(this.initRotY),this.rotateAboutZAxis(this.initRotZ),this.rotateScene(this.initSceneRotation),this.scene=t,this.scene.rotMat.copy(this.rotMatrix),this.scene.isLightingOn="standard"!=this.lightingMode,this.scene.isLightingOn&&this.setup3PointLighting(this.lightingMode,this.showLights),this.isLoaded=!0,this.isFailed=!1,this.needUpdate=!1,this.needRepaint=!1,this.update(),this.hideProgress(),this.hideError()},JSC3D.Viewer.prototype.reportProgress=function(t,e){if(!this.progressFrame){var i=this.canvas.getBoundingClientRect(),r=255-((16711680&this.bkgColor1)>>16),s=255-((65280&this.bkgColor1)>>8),a=255-(255&this.bkgColor1),o="rgb("+r+","+s+","+a+")",n=window.pageXOffset+i.left+40,h=window.pageYOffset+i.top+.38*i.height,l=i.width-2*(n-i.left),f=20
this.progressFrame=document.createElement("div"),this.progressFrame.style.position="absolute",this.progressFrame.style.left=n+"px",this.progressFrame.style.top=h+"px",this.progressFrame.style.width=l+"px",this.progressFrame.style.height=f+"px",this.progressFrame.style.border="1px solid "+o,this.progressFrame.style.pointerEvents="none",document.body.appendChild(this.progressFrame),this.progressRectangle=document.createElement("div"),this.progressRectangle.style.position="absolute",this.progressRectangle.style.left=n+3+"px",this.progressRectangle.style.top=h+3+"px",this.progressRectangle.style.width="0px",this.progressRectangle.style.height=f-4+"px",this.progressRectangle.style.background=o,this.progressRectangle.style.pointerEvents="none",document.body.appendChild(this.progressRectangle),this.messagePanel||(this.messagePanel=document.createElement("div"),this.messagePanel.style.position="absolute",this.messagePanel.style.left=n+"px",this.messagePanel.style.top=h-16+"px",this.messagePanel.style.width=l+"px",this.messagePanel.style.height="14px",this.messagePanel.style.font="bold 14px Courier New",this.messagePanel.style.color=o,this.messagePanel.style.pointerEvents="none",document.body.appendChild(this.messagePanel))}"block"!=this.progressFrame.style.display&&(this.progressFrame.style.display="block",this.progressRectangle.style.display="block"),t&&"block"!=this.messagePanel.style.display&&(this.messagePanel.style.display="block"),this.progressRectangle.style.width=(parseFloat(this.progressFrame.style.width)-4)*e+"px",this.messagePanel.innerHTML=t},JSC3D.Viewer.prototype.hideProgress=function(){this.progressFrame&&(this.messagePanel.style.display="none",this.progressFrame.style.display="none",this.progressRectangle.style.display="none")},JSC3D.Viewer.prototype.reportError=function(t){if(!this.messagePanel){var e=this.canvas.getBoundingClientRect(),i=255-((16711680&this.bkgColor1)>>16),r=255-((65280&this.bkgColor1)>>8),s=255-(255&this.bkgColor1),a="rgb("+i+","+r+","+s+")",o=window.pageXOffset+e.left+40,n=window.pageYOffset+e.top+.38*e.height,h=e.width-2*(o-e.left),l=14
this.messagePanel=document.createElement("div"),this.messagePanel.style.position="absolute",this.messagePanel.style.left=o+"px",this.messagePanel.style.top=n-16+"px",this.messagePanel.style.width=h+"px",this.messagePanel.style.height=l+"px",this.messagePanel.style.font="bold 14px Courier New",this.messagePanel.style.color=a,this.messagePanel.style.pointerEvents="none",document.body.appendChild(this.messagePanel)}"none"!=this.progressFrame.style.display&&(this.progressFrame.style.display="none",this.progressRectangle.style.display="none"),t&&"block"!=this.messagePanel.style.display&&(this.messagePanel.style.display="block"),this.messagePanel.innerHTML=t},JSC3D.Viewer.prototype.hideError=function(){this.messagePanel&&(this.messagePanel.style.display="none")},JSC3D.Viewer.prototype.generateBackground=function(){return this.webglBackend?void(this.bkgImage?this.webglBackend.setBackgroundImage(this.bkgImage):this.webglBackend.setBackgroundColors(this.bkgColor1,this.bkgColor2)):void(this.bkgImage?this.fillBackgroundWithImage():this.fillGradientBackground())},JSC3D.Viewer.prototype.fillGradientBackground=function(){for(var t=this.frameWidth,e=this.frameHeight,i=this.bkgColorBuffer,r=(16711680&this.bkgColor1)>>16,s=(65280&this.bkgColor1)>>8,a=255&this.bkgColor1,o=(16711680&this.bkgColor2)>>16,n=(65280&this.bkgColor2)>>8,h=255&this.bkgColor2,l=this.isBackgroundOn?4278190080:0,f=0,u=0;e>u;u++)for(var m=r+u*(o-r)/e&255,c=s+u*(n-s)/e&255,p=a+u*(h-a)/e&255,d=0;t>d;d++)i[f++]=l|m<<16|c<<8|p},JSC3D.Viewer.prototype.fillBackgroundWithImage=function(){var t=this.frameWidth,e=this.frameHeight
if(!(this.bkgImage.width<=0||this.bkgImage.height<=0)){var i=!1,r=JSC3D.Texture.cv
if(!r)try{r=document.createElement("canvas"),JSC3D.Texture.cv=r,i=!0}catch(s){return}(r.width!=t||r.height!=e)&&(r.width=t,r.height=e,i=!0)
var a=null
try{var o=r.getContext("2d")
i||o.clearRect(0,0,t,e),o.drawImage(this.bkgImage,0,0,t,e)
var n=o.getImageData(0,0,t,e)
a=n.data}catch(s){return}for(var h=this.bkgColorBuffer,l=t*e,f=this.isBackgroundOn?4278190080:0,u=0,m=0;l>u;u++,m+=4)h[u]=f|a[m]<<16|a[m+1]<<8|a[m+2]}},JSC3D.Viewer.prototype.drawBackground=function(){(this.webglBackend||this.ctx2d)&&(this.beginScene(),this.endScene(),this.paint())},JSC3D.Viewer.prototype.beginScene=function(){var t=this.frameWidth,e=this.frameHeight
if(this.webglBackend)return void this.webglBackend.beginFrame(this.definition,this.isBackgroundOn,t,e)
for(var i=this.colorBuffer,r=this.zBuffer,s=this.selectionBuffer,a=this.bkgColorBuffer,o=this.frameWidth*this.frameHeight,n=-(1/0),h=0;o>h;h++)i[h]=a[h],r[h]=n,s[h]=0},JSC3D.Viewer.prototype.endScene=function(){if(this.webglBackend)return void this.webglBackend.endFrame()
var t=this.canvasData.data,e=this.canvas.width,i=this.canvas.height,r=this.colorBuffer,s=this.frameWidth,a=this.frameHeight,o=s*a
switch(this.definition){case"low":for(var n=e>>1,h=s-n,l=0,f=0,u=0;i>u;u++){for(var m=0;e>m;m++){var c=r[l]
t[f]=(16711680&c)>>16,t[f+1]=(65280&c)>>8,t[f+2]=255&c,t[f+3]=c>>>24,l+=1&m,f+=4}l+=1&u?h:-n}break
case"high":for(var l=0,f=0,u=0;i>u;u++){for(var m=0;e>m;m++){var p=r[l],d=r[l+1],g=r[l+s],v=r[l+s+1]
t[f]=(16711680&p)+(16711680&d)+(16711680&g)+(16711680&v)>>18,t[f+1]=(65280&p)+(65280&d)+(65280&g)+(65280&v)>>10,t[f+2]=(255&p)+(255&d)+(255&g)+(255&v)>>2,t[f+3]=p>>>24,l+=2,f+=4}l+=s}break
case"standard":default:for(var l=0,f=0;o>l;l++,f+=4){var c=r[l]
t[f]=(16711680&c)>>16,t[f+1]=(65280&c)>>8,t[f+2]=255&c,t[f+3]=c>>>24}}},JSC3D.Viewer.prototype.render=function(){if(!this.scene.isEmpty()){var t=this.frameWidth,e=this.frameHeight,i=this.scene.aabb,r=i.lengthOfDiagonal()
this.webglBackend?(this.transformMatrix.identity(),this.transformMatrix.translate(-.5*(i.minX+i.maxX),-.5*(i.minY+i.maxY),-.5*(i.minZ+i.maxZ)),this.transformMatrix.multiply(this.rotMatrix),this.transformMatrix.scale(2*this.zoomFactor/t,2*this.zoomFactor/e,-2/r),this.transformMatrix.translate(2*this.panning[0]/t,-2*this.panning[1]/e,0)):(this.transformMatrix.identity(),this.transformMatrix.translate(-.5*(i.minX+i.maxX),-.5*(i.minY+i.maxY),-.5*(i.minZ+i.maxZ)),this.transformMatrix.multiply(this.rotMatrix),this.transformMatrix.scale(this.zoomFactor,-this.zoomFactor,this.zoomFactor),this.transformMatrix.translate(.5*t+this.panning[0],.5*e+this.panning[1],0)),this.webglBackend?(this.scene.xformMat.identity(),this.scene.xformMat.translate(-.5*(i.minX+i.maxX),-.5*(i.minY+i.maxY),-.5*(i.minZ+i.maxZ)),this.scene.xformMat.multiply(this.scene.rotMat),this.scene.xformMat.scale(2*this.zoomFactor/t,2*this.zoomFactor/e,-2/r),this.scene.xformMat.translate(2*this.panning[0]/t,-2*this.panning[1]/e,0)):(this.scene.xformMat.identity(),this.scene.xformMat.translate(-.5*(i.minX+i.maxX),-.5*(i.minY+i.maxY),-.5*(i.minZ+i.maxZ)),this.scene.xformMat.multiply(this.scene.rotMat),this.scene.xformMat.scale(this.zoomFactor,-this.zoomFactor,this.zoomFactor),this.scene.xformMat.translate(.5*t+this.panning[0],.5*e+this.panning[1],0))
for(var s=0,a=this.scene.lights.length;a>s;s++)JSC3D.Math3D.transformVectors(this.scene.xformMat,this.scene.lights[s].position,this.scene.lights[s].transformedPosition)
var o=this.sortScene(this.transformMatrix)
if(this.webglBackend)return void this.webglBackend.render(this.scene.getChildren(),this.scene.lights,this.scene.xformMat,this.scene.rotMat,this.transformMatrix,this.rotMatrix,this.renderMode,this.defaultMaterial,this.sphereMap,this.isCullingDisabled)
for(var s=0;s<o.length;s++){var n=o[s]
if(!n.isTrivial()&&(n.isPositionFixed?JSC3D.Math3D.transformVectors(this.scene.xformMat,n.vertexBuffer,n.transformedVertexBuffer):JSC3D.Math3D.transformVectors(this.transformMatrix,n.vertexBuffer,n.transformedVertexBuffer),n.visible))switch(n.renderMode||this.renderMode){case"point":this.renderPoint(n)
break
case"wireframe":this.renderWireframe(n)
break
case"flat":this.renderSolidFlat(n)
break
case"smooth":this.renderSolidSmooth(n)
break
case"texture":n.hasTexture()?this.renderSolidTexture(n):this.renderSolidFlat(n)
break
case"textureflat":n.hasTexture()?this.renderTextureFlat(n):this.renderSolidFlat(n)
break
case"texturesmooth":var h=n.material?n.material.isEnvironmentCast:!1,l=n.texture?n.texture.isEnvironmentCast:!1,f=h||l
f&&null!=this.sphereMap&&this.sphereMap.hasData()?this.renderSolidSphereMapped(n):n.hasTexture()?this.renderTextureSmooth(n):this.renderSolidSmooth(n)
break
default:this.renderSolidFlat(n)}}}},JSC3D.Viewer.prototype.sortScene=function(t){for(var e=[],i=this.scene.getChildren(),r=0;r<i.length;r++){var s=i[r]
if(!s.isTrivial()){e.push(s)
var a=s.aabb.center()
JSC3D.Math3D.transformVectors(t,a,a)
var o=s.material?s.material:this.defaultMaterial
s.sortKey={depth:a[2],isTransparnt:o.transparency>0||(s.hasTexture()?s.texture.hasTransparency:!1)}}}return e.sort(function(t,e){return!t.sortKey.isTransparnt&&e.sortKey.isTransparnt?-1:t.sortKey.isTransparnt&&!e.sortKey.isTransparnt?1:t.sortKey.isTransparnt?t.sortKey.depth-e.sortKey.depth:e.sortKey.depth-t.sortKey.depth}),e},JSC3D.Viewer.prototype.renderPoint=function(t){for(var e=this.frameWidth,i=this.frameHeight,r=e-1,s=i-1,a=t.transformedVertexBuffer,o=this.colorBuffer,n=this.zBuffer,h=this.selectionBuffer,l=a.length/3,f=t.internalId,u=4278190080|(t.material?t.material.diffuseColor:this.defaultMaterial.diffuseColor),m=0,c=0;l>m;m++,c+=3){var p=~~(a[c]+.5),d=~~(a[c+1]+.5),g=a[c+2]
if(p>=0&&r>p&&d>=0&&s>d){var v=d*e+p
g>n[v]&&(n[v]=g,o[v]=u,h[v]=f),v++,g>n[v]&&(n[v]=g,o[v]=u,h[v]=f),v+=r,g>n[v]&&(n[v]=g,o[v]=u,h[v]=f),v++,g>n[v]&&(n[v]=g,o[v]=u,h[v]=f)}}},JSC3D.Viewer.prototype.renderWireframe=function(t){var e=this.frameWidth,i=this.frameHeight,r=e-1,s=i-1,a=t.indexBuffer,o=t.transformedVertexBuffer,n=t.transformedFaceNormalZBuffer,h=this.colorBuffer,l=this.zBuffer,f=this.selectionBuffer,u=t.faceCount,m=t.internalId,c=4278190080|(t.material?t.material.diffuseColor:this.defaultMaterial.diffuseColor),p=t.isDoubleSided||this.isCullingDisabled;(!n||n.length<u)&&(t.transformedFaceNormalZBuffer=Array(u),n=t.transformedFaceNormalZBuffer),t.isPositionFixed?n=t.faceNormalBuffer:JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.faceNormalBuffer,n)
for(var d=0,g=0;u>d;){var v=n[d++]
if(p&&(v=v>0?v:-v),0>v){do;while(-1!=a[g++])}else{var x,C,D
C=3*a[g++],D=3*a[g++],x=C
for(var S=!1;!S;){var y,b,w,B,M=~~(o[C]+.5),J=~~(o[C+1]+.5),A=o[C+2],V=~~(o[D]+.5),k=~~(o[D+1]+.5),Y=o[D+2],X=V-M,I=k-J,R=Y-A
Math.abs(X)>Math.abs(I)?(y=X,b=X>0?1:-1,w=0!=X?b*I/X:0,B=0!=X?b*R/X:0):(y=I,w=I>0?1:-1,b=0!=I?w*X/I:0,B=0!=I?w*R/I:0)
var F=M,N=J,Z=A
0>y&&(F=V,N=k,Z=Y,y=-y,b=-b,w=-w,B=-B)
for(var L=0;y>L;L++){if(F>=0&&r>F&&N>=0&&s>N){var U=~~N*e+~~F
Z>l[U]&&(l[U]=Z,h[U]=c,f[U]=m)}F+=b,N+=w,Z+=B}D==x?S=!0:(C=D,D=-1!=a[g]?3*a[g++]:x)}g++}}},JSC3D.Viewer.prototype.renderSolidFlat=function(t){var e=this.frameWidth,i=this.frameHeight,r=t.indexBuffer,s=t.transformedVertexBuffer,a=t.transformedFaceNormalZBuffer,o=this.colorBuffer,n=this.zBuffer,h=this.selectionBuffer,l=t.faceCount,f=t.internalId,u=t.material?t.material:this.defaultMaterial,m=u.getPalette(),c=0==u.transparency,p=~~(255*u.transparency),d=255-p,g=t.isDoubleSided||this.isCullingDisabled
if(1!=u.transparency){(!a||a.length<l)&&(t.transformedFaceNormalZBuffer=Array(l),a=t.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.faceNormalBuffer,a)
for(var v=Array(3),x=Array(3),C=Array(3),D=0,S=0;l>D;){var y=a[D++]
if(g&&(y=y>0?y:-y),0>y){do;while(-1!=r[S++])}else{var b,w,B,M=4278190080|m[~~(255*y)]
b=3*r[S++],w=3*r[S++]
do{B=3*r[S++],v[0]=~~(s[b]+.5),x[0]=~~(s[b+1]+.5),C[0]=s[b+2],v[1]=~~(s[w]+.5),x[1]=~~(s[w+1]+.5),C[1]=s[w+2],v[2]=~~(s[B]+.5),x[2]=~~(s[B+1]+.5),C[2]=s[B+2]
var J=x[0]<x[1]?0:1
J=x[J]<x[2]?J:2
var A=x[0]>x[1]?0:1
A=x[A]>x[2]?A:2
var V=3-A-J
if(J!=A){var k=v[A],Y=C[A],X=x[A]-x[J]
X=0!=X?X:1
var I=(v[A]-v[J])/X,R=(C[A]-C[J])/X,F=v[A],N=C[A],Z=x[A]-x[V]
Z=0!=Z?Z:1
var L=(v[A]-v[V])/Z,U=(C[A]-C[V])/Z,T=v[V],P=C[V],H=x[V]-x[J]
H=0!=H?H:1
for(var E=(v[V]-v[J])/H,z=(C[V]-C[J])/H,W=x[A]*e,O=x[A];O>x[J];O--){if(O>=0&&i>O){var G,K,q=~~k,j=Y
if(O>x[V]?(G=~~F,K=N):(G=~~T,K=P),q>G){var Q
Q=q,q=G,G=Q,Q=j,j=K,K=Q}0>q&&(q=0),G>=e&&(G=e-1)
var $=q!=G?(K-j)/(G-q):1,_=W+q
if(c)for(var tt=q,et=j;G>=tt;tt++,et+=$)et>n[_]&&(n[_]=et,o[_]=M,h[_]=f),_++
else for(var tt=q,et=j;G>tt;tt++,et+=$){if(et>n[_]){var it=M,rt=o[_],st=(16711680&rt)*p+(16711680&it)*d>>8,at=(65280&rt)*p+(65280&it)*d>>8,ot=(255&rt)*p+(255&it)*d>>8,nt=4278190080&rt|d<<24
o[_]=nt|16711680&st|65280&at|255&ot,h[_]=f}_++}}k-=I,Y-=R,O>x[V]?(F-=L,N-=U):(T-=E,P-=z),W-=e}}w=B}while(-1!=r[S])
S++}}}},JSC3D.Viewer.prototype.renderSolidSmooth=function(t){var e=this.frameWidth,i=this.frameHeight,r=t.indexBuffer,s=t.transformedVertexBuffer,a=t.transformedVertexNormalZBuffer,o=t.vertexNormalIndexBuffer?t.vertexNormalIndexBuffer:t.indexBuffer,n=t.transformedFaceNormalZBuffer,h=this.colorBuffer,l=this.zBuffer,f=this.selectionBuffer,u=t.faceCount,m=(s.length/3,t.internalId),c=t.material?t.material:this.defaultMaterial,p=c.getPalette(),d=0==c.transparency,g=~~(255*c.transparency),v=255-g,x=t.isDoubleSided||this.isCullingDisabled
if(1!=c.transparency){(!a||a.length<t.vertexNormalBuffer.length/3)&&(t.transformedVertexNormalZBuffer=Array(t.vertexNormalBuffer.length/3),a=t.transformedVertexNormalZBuffer),(!n||n.length<u)&&(t.transformedFaceNormalZBuffer=Array(u),n=t.transformedFaceNormalZBuffer),t.isPositionFixed?(a=t.vertexNormalBuffer,n=t.faceNormalBuffer):(JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.vertexNormalBuffer,a),JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.faceNormalBuffer,n))
for(var C=Array(3),D=Array(3),S=Array(3),y=Array(3),b=0,w=0;u>b;){var B=n[b++]
if(x&&(B=B>0?B:-B),0>B){do;while(-1!=r[w++])}else{var M,J,A,V,k,Y,X,I,R
M=r[w],V=3*M,X=o[w],w++,J=r[w],k=3*J,I=o[w],w++
do{A=r[w],Y=3*A,R=o[w],w++,C[0]=~~(s[V]+.5),D[0]=~~(s[V+1]+.5),S[0]=s[V+2],C[1]=~~(s[k]+.5),D[1]=~~(s[k+1]+.5),S[1]=s[k+2],C[2]=~~(s[Y]+.5),D[2]=~~(s[Y+1]+.5),S[2]=s[Y+2],y[0]=a[X],y[1]=a[I],y[2]=a[R],x&&(y[0]<0&&(y[0]=-y[0]),y[1]<0&&(y[1]=-y[1]),y[2]<0&&(y[2]=-y[2]))
var F=D[0]<D[1]?0:1
F=D[F]<D[2]?F:2
var N=D[0]>D[1]?0:1
N=D[N]>D[2]?N:2
var Z=3-N-F
if(F!=N){var L=C[N],U=S[N],T=255*y[N],P=D[N]-D[F]
P=0!=P?P:1
var H=(C[N]-C[F])/P,E=(S[N]-S[F])/P,z=255*(y[N]-y[F])/P,W=C[N],O=S[N],G=255*y[N],K=D[N]-D[Z]
K=0!=K?K:1
var q=(C[N]-C[Z])/K,j=(S[N]-S[Z])/K,Q=255*(y[N]-y[Z])/K,$=C[Z],_=S[Z],tt=255*y[Z],et=D[Z]-D[F]
et=0!=et?et:1
for(var it=(C[Z]-C[F])/et,rt=(S[Z]-S[F])/et,st=255*(y[Z]-y[F])/et,at=D[N]*e,ot=D[N];ot>D[F];ot--){if(ot>=0&&i>ot){var nt,ht,lt,ft=~~L,ut=U,mt=T
if(ot>D[Z]?(nt=~~W,ht=O,lt=G):(nt=~~$,ht=_,lt=tt),ft>nt){var ct
ct=ft,ft=nt,nt=ct,ct=ut,ut=ht,ht=ct,ct=mt,mt=lt,lt=ct}var pt=ft!=nt?(ht-ut)/(nt-ft):1,dt=ft!=nt?(lt-mt)/(nt-ft):1
0>ft&&(ut-=ft*pt,mt-=ft*dt,ft=0),nt>=e&&(nt=e-1)
var gt=at+ft
if(d)for(var vt=ft,xt=ut,Ct=mt;nt>=vt;vt++,xt+=pt,Ct+=dt)xt>l[gt]&&(l[gt]=xt,h[gt]=4278190080|p[Ct>0?~~Ct:0],f[gt]=m),gt++
else for(var vt=ft,xt=ut,Ct=mt;nt>vt;vt++,xt+=pt,Ct+=dt){if(xt>l[gt]){var Dt=p[Ct>0?~~Ct:0],St=h[gt],yt=(16711680&St)*g+(16711680&Dt)*v>>8,bt=(65280&St)*g+(65280&Dt)*v>>8,wt=(255&St)*g+(255&Dt)*v>>8,Bt=4278190080&St|v<<24
h[gt]=Bt|16711680&yt|65280&bt|255&wt,f[gt]=m}gt++}}L-=H,U-=E,T-=z,ot>D[Z]?(W-=q,O-=j,G-=Q):($-=it,_-=rt,tt-=st),at-=e}}k=Y,J=A,I=R}while(-1!=r[w])
w++}}}},JSC3D.Viewer.prototype.renderSolidTexture=function(t){var e=this.frameWidth,i=this.frameHeight,r=t.indexBuffer,s=t.transformedVertexBuffer,a=t.transformedFaceNormalZBuffer,o=this.colorBuffer,n=this.zBuffer,h=this.selectionBuffer,l=t.faceCount,f=t.internalId,u=t.texture,m=!u.hasTransparency,c=t.texCoordBuffer,p=t.texCoordIndexBuffer?t.texCoordIndexBuffer:t.indexBuffer,d=u.data,g=u.width,v=g-1,x=u.hasMipmap()?u.mipmaps:null,C=x?u.mipentries:null,D=t.isDoubleSided||this.isCullingDisabled;(!a||a.length<l)&&(t.transformedFaceNormalZBuffer=Array(l),a=t.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.faceNormalBuffer,a)
for(var S=Array(3),y=Array(3),b=Array(3),w=Array(3),B=Array(3),M=0,J=0;l>M;){var A=a[M++]
if(D&&(A=A>0?A:-A),0>A){do;while(-1!=r[J++])}else{var V,k,Y,X,I,R
if(V=3*r[J],X=2*p[J],J++,k=3*r[J],I=2*p[J],J++,x){Y=3*r[J],R=2*p[J],g=u.width,S[0]=s[V],y[0]=s[V+1],S[1]=s[k],y[1]=s[k+1],S[2]=s[Y],y[2]=s[Y+1],w[0]=c[X]*g,B[0]=c[X+1]*g,w[1]=c[I]*g,B[1]=c[I+1]*g,w[2]=c[R]*g,B[2]=c[R+1]*g
var F=(S[1]-S[0])*(y[2]-y[0])-(y[1]-y[0])*(S[2]-S[0])
0>F&&(F=-F),F+=1
var N=(w[1]-w[0])*(B[2]-B[0])-(B[1]-B[0])*(w[2]-w[0])
0>N&&(N=-N)
var Z=N/F,L=0
if(Z<C[1])L=0
else if(Z>=C[C.length-1])L=C.length-1,g=1
else for(;Z>=C[L+1];)L++,g/=2
d=x[L],v=g-1}do{Y=3*r[J],R=2*p[J],J++,S[0]=~~(s[V]+.5),y[0]=~~(s[V+1]+.5),b[0]=s[V+2],S[1]=~~(s[k]+.5),y[1]=~~(s[k+1]+.5),b[1]=s[k+2],S[2]=~~(s[Y]+.5),y[2]=~~(s[Y+1]+.5),b[2]=s[Y+2],w[0]=c[X]*g,B[0]=c[X+1]*g,w[1]=c[I]*g,B[1]=c[I+1]*g,w[2]=c[R]*g,B[2]=c[R+1]*g
var U=y[0]<y[1]?0:1
U=y[U]<y[2]?U:2
var T=y[0]>y[1]?0:1
T=y[T]>y[2]?T:2
var P=3-T-U
if(U!=T){var H=S[T],E=b[T],z=w[T],W=B[T],O=y[T]-y[U]
O=0!=O?O:1
var G=(S[T]-S[U])/O,K=(b[T]-b[U])/O,q=(w[T]-w[U])/O,j=(B[T]-B[U])/O,Q=S[T],$=b[T],_=w[T],tt=B[T],et=y[T]-y[P]
et=0!=et?et:1
var it=(S[T]-S[P])/et,rt=(b[T]-b[P])/et,st=(w[T]-w[P])/et,at=(B[T]-B[P])/et,ot=S[P],nt=b[P],ht=w[P],lt=B[P],ft=y[P]-y[U]
ft=0!=ft?ft:1
for(var ut=(S[P]-S[U])/ft,mt=(b[P]-b[U])/ft,ct=(w[P]-w[U])/ft,pt=(B[P]-B[U])/ft,dt=y[T]*e,gt=y[T];gt>y[U];gt--){if(gt>=0&&i>gt){var vt,xt,Ct,Dt,St=~~H,yt=E,bt=z,wt=W
if(gt>y[P]?(vt=~~Q,xt=$,Ct=_,Dt=tt):(vt=~~ot,xt=nt,Ct=ht,Dt=lt),St>vt){var Bt
Bt=St,St=vt,vt=Bt,Bt=yt,yt=xt,xt=Bt,Bt=bt,bt=Ct,Ct=Bt,Bt=wt,wt=Dt,Dt=Bt}var Mt=St!=vt?(xt-yt)/(vt-St):1,Jt=St!=vt?(Ct-bt)/(vt-St):1,At=St!=vt?(Dt-wt)/(vt-St):1
0>St&&(yt-=St*Mt,bt-=St*Jt,wt-=St*At,St=0),vt>=e&&(vt=e-1)
var Vt=dt+St
if(m)for(var kt=St,Yt=yt,Xt=bt,It=wt;vt>=kt;kt++,Yt+=Mt,Xt+=Jt,It+=At)Yt>n[Vt]&&(n[Vt]=Yt,o[Vt]=d[(It&v)*g+(Xt&v)],h[Vt]=f),Vt++
else for(var kt=St,Yt=yt,Xt=bt,It=wt;vt>kt;kt++,Yt+=Mt,Xt+=Jt,It+=At){if(Yt>n[Vt]){var Rt=d[(It&v)*g+(Xt&v)],Ft=o[Vt],Nt=Rt>>24&255,Zt=255-Nt,Lt=(16711680&Ft)*Zt+(16711680&Rt)*Nt>>8,Ut=(65280&Ft)*Zt+(65280&Rt)*Nt>>8,Tt=(255&Ft)*Zt+(255&Rt)*Nt>>8,Pt=4278190080&Ft|Nt<<24
o[Vt]=Pt|16711680&Lt|65280&Ut|255&Tt,h[Vt]=f}Vt++}}H-=G,E-=K,z-=q,W-=j,gt>y[P]?(Q-=it,$-=rt,_-=st,tt-=at):(ot-=ut,nt-=mt,ht-=ct,lt-=pt),dt-=e}}k=Y,I=R}while(-1!=r[J])
J++}}},JSC3D.Viewer.prototype.renderTextureFlat=function(t){var e=this.frameWidth,i=this.frameHeight,r=t.indexBuffer,s=t.transformedVertexBuffer,a=t.transformedFaceNormalZBuffer,o=this.colorBuffer,n=this.zBuffer,h=this.selectionBuffer,l=t.faceCount,f=t.internalId,u=t.material?t.material:this.defaultMaterial,m=u.getPalette(),c=t.texture,p=0==u.transparency&&!c.hasTransparency,d=~~(255*(1-u.transparency)),g=t.texCoordBuffer,v=t.texCoordIndexBuffer?t.texCoordIndexBuffer:t.indexBuffer,x=c.data,C=c.width,D=C-1,S=c.hasMipmap()?c.mipmaps:null,y=S?c.mipentries:null,b=t.isDoubleSided||this.isCullingDisabled
if(1!=u.transparency){(!a||a.length<l)&&(t.transformedFaceNormalZBuffer=Array(l),a=t.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.faceNormalBuffer,a)
for(var w=Array(3),B=Array(3),M=Array(3),J=Array(3),A=Array(3),V=0,k=0;l>V;){var Y=a[V++]
if(b&&(Y=Y>0?Y:-Y),0>Y){do;while(-1!=r[k++])}else{var X,I,R,F,N,Z,L=4278190080|m[~~(255*Y)]
if(X=3*r[k],F=2*v[k],k++,I=3*r[k],N=2*v[k],k++,S){R=3*r[k],Z=2*v[k],C=c.width,w[0]=s[X],B[0]=s[X+1],w[1]=s[I],B[1]=s[I+1],w[2]=s[R],B[2]=s[R+1],J[0]=g[F]*C,A[0]=g[F+1]*C,J[1]=g[N]*C,A[1]=g[N+1]*C,J[2]=g[Z]*C,A[2]=g[Z+1]*C
var U=(w[1]-w[0])*(B[2]-B[0])-(B[1]-B[0])*(w[2]-w[0])
0>U&&(U=-U),U+=1
var T=(J[1]-J[0])*(A[2]-A[0])-(A[1]-A[0])*(J[2]-J[0])
0>T&&(T=-T)
var P=T/U,H=0
if(P<y[1])H=0
else if(P>=y[y.length-1])H=y.length-1,C=1
else for(;P>=y[H+1];)H++,C/=2
x=S[H],D=C-1}do{R=3*r[k],Z=2*v[k],k++,w[0]=~~(s[X]+.5),B[0]=~~(s[X+1]+.5),M[0]=s[X+2],w[1]=~~(s[I]+.5),B[1]=~~(s[I+1]+.5),M[1]=s[I+2],w[2]=~~(s[R]+.5),B[2]=~~(s[R+1]+.5),M[2]=s[R+2],J[0]=g[F]*C,A[0]=g[F+1]*C,J[1]=g[N]*C,A[1]=g[N+1]*C,J[2]=g[Z]*C,A[2]=g[Z+1]*C
var E=B[0]<B[1]?0:1
E=B[E]<B[2]?E:2
var z=B[0]>B[1]?0:1
z=B[z]>B[2]?z:2
var W=3-z-E
if(E!=z){var O=w[z],G=M[z],K=J[z],q=A[z],j=B[z]-B[E]
j=0!=j?j:1
var Q=(w[z]-w[E])/j,$=(M[z]-M[E])/j,_=(J[z]-J[E])/j,tt=(A[z]-A[E])/j,et=w[z],it=M[z],rt=J[z],st=A[z],at=B[z]-B[W]
at=0!=at?at:1
var ot=(w[z]-w[W])/at,nt=(M[z]-M[W])/at,ht=(J[z]-J[W])/at,lt=(A[z]-A[W])/at,ft=w[W],ut=M[W],mt=J[W],ct=A[W],pt=B[W]-B[E]
pt=0!=pt?pt:1
for(var dt=(w[W]-w[E])/pt,gt=(M[W]-M[E])/pt,vt=(J[W]-J[E])/pt,xt=(A[W]-A[E])/pt,Ct=B[z]*e,Dt=B[z];Dt>B[E];Dt--){if(Dt>=0&&i>Dt){var St,yt,bt,wt,Bt=~~O,Mt=G,Jt=K,At=q
if(Dt>B[W]?(St=~~et,yt=it,bt=rt,wt=st):(St=~~ft,yt=ut,bt=mt,wt=ct),Bt>St){var Vt
Vt=Bt,Bt=St,St=Vt,Vt=Mt,Mt=yt,yt=Vt,Vt=Jt,Jt=bt,bt=Vt,Vt=At,At=wt,wt=Vt}var kt=Bt!=St?(yt-Mt)/(St-Bt):1,Yt=Bt!=St?(bt-Jt)/(St-Bt):1,Xt=Bt!=St?(wt-At)/(St-Bt):1
0>Bt&&(Mt-=Bt*kt,Jt-=Bt*Yt,At-=Bt*Xt,Bt=0),St>=e&&(St=e-1)
var It=Ct+Bt
if(p)for(var Rt=Bt,Ft=Mt,Nt=Jt,Zt=At;St>=Rt;Rt++,Ft+=kt,Nt+=Yt,Zt+=Xt){if(Ft>n[It]){n[It]=Ft
var Lt=x[(Zt&D)*C+(Nt&D)],Ut=((16711680&L)>>16)*((16711680&Lt)>>8),Tt=((65280&L)>>8)*((65280&Lt)>>8),Pt=(255&L)*(255&Lt)>>8
o[It]=4278190080|16711680&Ut|65280&Tt|255&Pt,h[It]=f}It++}else for(var Rt=Bt,Ft=Mt,Nt=Jt,Zt=At;St>Rt;Rt++,Ft+=kt,Nt+=Yt,Zt+=Xt){if(Ft>n[It]){var Ht=x[(Zt&D)*C+(Nt&D)],Et=o[It],zt=(Ht>>24&255)*(255&d)>>8,Ut=((16711680&L)>>16)*((16711680&Ht)>>8),Tt=((65280&L)>>8)*((65280&Ht)>>8),Pt=(255&L)*(255&Ht)>>8,Wt=4278190080&Et|zt<<24
if(zt>250)n[It]=Ft
else{var Ot=255-zt
Ut=Ut*zt+(16711680&Et)*Ot>>8,Tt=Tt*zt+(65280&Et)*Ot>>8,Pt=Pt*zt+(255&Et)*Ot>>8}o[It]=Wt|16711680&Ut|65280&Tt|255&Pt,h[It]=f}It++}}O-=Q,G-=$,K-=_,q-=tt,Dt>B[W]?(et-=ot,it-=nt,rt-=ht,st-=lt):(ft-=dt,ut-=gt,mt-=vt,ct-=xt),Ct-=e}}I=R,N=Z}while(-1!=r[k])
k++}}}},JSC3D.Viewer.prototype.renderTextureSmooth=function(t){var e=this.frameWidth,i=this.frameHeight,r=t.indexBuffer,s=t.transformedVertexBuffer,a=t.transformedVertexNormalZBuffer,o=t.vertexNormalIndexBuffer?t.vertexNormalIndexBuffer:t.indexBuffer,n=t.transformedFaceNormalZBuffer,h=this.colorBuffer,l=this.zBuffer,f=this.selectionBuffer,u=t.faceCount,m=t.internalId,c=(s.length/3,t.material?t.material:this.defaultMaterial),p=c.getPalette(),d=t.texture,g=0==c.transparency&&!d.hasTransparency,v=~~(255*(1-c.transparency)),x=t.texCoordBuffer,C=t.texCoordIndexBuffer?t.texCoordIndexBuffer:t.indexBuffer,D=d.data,S=d.width,y=S-1,b=d.hasMipmap()?d.mipmaps:null,w=b?d.mipentries:null,B=t.isDoubleSided||this.isCullingDisabled
if(1!=c.transparency){(!a||a.length<t.vertexNormalBuffer.length/3)&&(t.transformedVertexNormalZBuffer=Array(t.vertexNormalBuffer.length/3),a=t.transformedVertexNormalZBuffer),(!n||n.length<u)&&(t.transformedFaceNormalZBuffer=Array(u),n=t.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.vertexNormalBuffer,a),JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.faceNormalBuffer,n)
for(var M=Array(3),J=Array(3),A=Array(3),V=Array(3),k=Array(3),Y=Array(3),X=0,I=0;u>X;){var R=n[X++]
if(B&&(R=R>0?R:-R),0>R){do;while(-1!=r[I++])}else{var F,N,Z,L,U,T,P,H,E,z,W,O
if(F=r[I],L=3*F,P=2*C[I],z=o[I],I++,N=r[I],U=3*N,H=2*C[I],W=o[I],I++,b){T=3*r[I],E=2*C[I],S=d.width,M[0]=s[L],J[0]=s[L+1],M[1]=s[U],J[1]=s[U+1],M[2]=s[T],J[2]=s[T+1],k[0]=x[P]*S,Y[0]=x[P+1]*S,k[1]=x[H]*S,Y[1]=x[H+1]*S,k[2]=x[E]*S,Y[2]=x[E+1]*S
var G=(M[1]-M[0])*(J[2]-J[0])-(J[1]-J[0])*(M[2]-M[0])
0>G&&(G=-G),G+=1
var K=(k[1]-k[0])*(Y[2]-Y[0])-(Y[1]-Y[0])*(k[2]-k[0])
0>K&&(K=-K)
var q=K/G,j=0
if(q<w[1])j=0
else if(q>=w[w.length-1])j=w.length-1,S=1
else for(;q>=w[j+1];)j++,S/=2
D=b[j],y=S-1}do{Z=r[I],T=3*Z,E=2*C[I],O=o[I],I++,M[0]=~~(s[L]+.5),J[0]=~~(s[L+1]+.5),A[0]=s[L+2],M[1]=~~(s[U]+.5),J[1]=~~(s[U+1]+.5),A[1]=s[U+2],M[2]=~~(s[T]+.5),J[2]=~~(s[T+1]+.5),A[2]=s[T+2],k[0]=x[P]*S,Y[0]=x[P+1]*S,k[1]=x[H]*S,Y[1]=x[H+1]*S,k[2]=x[E]*S,Y[2]=x[E+1]*S,V[0]=a[z],V[1]=a[W],V[2]=a[O],B&&(V[0]<0&&(V[0]=-V[0]),V[1]<0&&(V[1]=-V[1]),V[2]<0&&(V[2]=-V[2]))
var Q=J[0]<J[1]?0:1
Q=J[Q]<J[2]?Q:2
var $=J[0]>J[1]?0:1
$=J[$]>J[2]?$:2
var _=3-$-Q
if(Q!=$){var tt=M[$],et=A[$],it=k[$],rt=Y[$],st=255*V[$],at=J[$]-J[Q]
at=0!=at?at:1
var ot=(M[$]-M[Q])/at,nt=(A[$]-A[Q])/at,ht=(k[$]-k[Q])/at,lt=(Y[$]-Y[Q])/at,ft=255*(V[$]-V[Q])/at,ut=M[$],mt=A[$],ct=k[$],pt=Y[$],dt=255*V[$],gt=J[$]-J[_]
gt=0!=gt?gt:1
var vt=(M[$]-M[_])/gt,xt=(A[$]-A[_])/gt,Ct=(k[$]-k[_])/gt,Dt=(Y[$]-Y[_])/gt,St=255*(V[$]-V[_])/gt,yt=M[_],bt=A[_],wt=k[_],Bt=Y[_],Mt=255*V[_],Jt=J[_]-J[Q]
Jt=0!=Jt?Jt:1
for(var At=(M[_]-M[Q])/Jt,Vt=(A[_]-A[Q])/Jt,kt=(k[_]-k[Q])/Jt,Yt=(Y[_]-Y[Q])/Jt,Xt=255*(V[_]-V[Q])/Jt,It=J[$]*e,Rt=J[$];Rt>J[Q];Rt--){if(Rt>=0&&i>Rt){var Ft,Nt,Zt,Lt,Ut,Tt=~~tt,Pt=et,Ht=it,Et=rt,zt=st
if(Rt>J[_]?(Ft=~~ut,Nt=mt,Zt=ct,Lt=pt,Ut=dt):(Ft=~~yt,Nt=bt,Zt=wt,Lt=Bt,Ut=Mt),Tt>Ft){var Wt
Wt=Tt,Tt=Ft,Ft=Wt,Wt=Pt,Pt=Nt,Nt=Wt,Wt=Ht,Ht=Zt,Zt=Wt,Wt=Et,Et=Lt,Lt=Wt,Wt=zt,zt=Ut,Ut=Wt}var Ot=Tt!=Ft?(Nt-Pt)/(Ft-Tt):1,Gt=Tt!=Ft?(Zt-Ht)/(Ft-Tt):1,Kt=Tt!=Ft?(Lt-Et)/(Ft-Tt):1,qt=Tt!=Ft?(Ut-zt)/(Ft-Tt):0
0>Tt&&(Pt-=Tt*Ot,Ht-=Tt*Gt,Et-=Tt*Kt,zt-=Tt*qt,Tt=0),Ft>=e&&(Ft=e-1)
var jt=It+Tt
if(g)for(var Qt=Tt,$t=Pt,_t=zt,te=Ht,ee=Et;Ft>=Qt;Qt++,$t+=Ot,_t+=qt,te+=Gt,ee+=Kt){if($t>l[jt]){l[jt]=$t
var ie=p[_t>0?~~_t:0],re=D[(ee&y)*S+(te&y)],se=((16711680&ie)>>16)*((16711680&re)>>8),ae=((65280&ie)>>8)*((65280&re)>>8),oe=(255&ie)*(255&re)>>8
h[jt]=4278190080|16711680&se|65280&ae|255&oe,f[jt]=m}jt++}else for(var Qt=Tt,$t=Pt,_t=zt,te=Ht,ee=Et;Ft>Qt;Qt++,$t+=Ot,_t+=qt,te+=Gt,ee+=Kt){if($t>l[jt]){var ie=p[_t>0?~~_t:0],ne=D[(ee&y)*S+(te&y)],he=h[jt],le=(ne>>24&255)*(255&v)>>8,se=((16711680&ie)>>16)*((16711680&ne)>>8),ae=((65280&ie)>>8)*((65280&ne)>>8),oe=(255&ie)*(255&ne)>>8,fe=4278190080&he|le<<24
if(le>250)l[jt]=$t
else{var ue=255-le
se=se*le+(16711680&he)*ue>>8,ae=ae*le+(65280&he)*ue>>8,oe=oe*le+(255&he)*ue>>8}h[jt]=fe|16711680&se|65280&ae|255&oe,f[jt]=m}jt++}}tt-=ot,et-=nt,it-=ht,rt-=lt,st-=ft,Rt>J[_]?(ut-=vt,mt-=xt,ct-=Ct,pt-=Dt,dt-=St):(yt-=At,bt-=Vt,wt-=kt,Bt-=Yt,Mt-=Xt),It-=e}}N=Z,U=T,H=E,W=O}while(-1!=r[I])
I++}}}},JSC3D.Viewer.prototype.renderSolidSphereMapped=function(t){var e=this.frameWidth,i=this.frameHeight,r=t.indexBuffer,s=t.transformedVertexBuffer,a=t.transformedVertexNormalBuffer,o=t.vertexNormalIndexBuffer?t.vertexNormalIndexBuffer:t.indexBuffer,n=t.transformedFaceNormalZBuffer,h=this.colorBuffer,l=this.zBuffer,f=this.selectionBuffer,u=t.faceCount,m=(s.length/3,t.internalId),c=t.material?t.material:this.defaultMaterial,p=c.getPalette(),d=this.sphereMap,g=d.data,v=d.width,x=v-1,C=0==c.transparency,D=~~(255*c.transparency),S=255-D,y=t.isDoubleSided||this.isCullingDisabled
if(1!=c.transparency){(!a||a.length<t.vertexNormalBuffer.length)&&(t.transformedVertexNormalBuffer=Array(t.vertexNormalBuffer.length),a=t.transformedVertexNormalBuffer),(!n||n.length<u)&&(t.transformedFaceNormalZBuffer=Array(u),n=t.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectors(this.rotMatrix,t.vertexNormalBuffer,a),JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.faceNormalBuffer,n)
for(var b=Array(3),w=Array(3),B=Array(3),M=Array(3),J=Array(3),A=Array(3),V=0,k=0;u>V;){var Y=n[V++]
if(y&&(Y=Y>0?Y:-Y),0>Y){do;while(-1!=r[k++])}else{var X,I,R,F,N,Z
X=3*r[k],F=3*o[k],k++,I=3*r[k],N=3*o[k],k++
do{R=3*r[k],Z=3*o[k],k++,b[0]=~~(s[X]+.5),w[0]=~~(s[X+1]+.5),B[0]=s[X+2],b[1]=~~(s[I]+.5),w[1]=~~(s[I+1]+.5),B[1]=s[I+2],b[2]=~~(s[R]+.5),w[2]=~~(s[R+1]+.5),B[2]=s[R+2],M[0]=a[F],J[0]=a[F+1],A[0]=a[F+2],M[1]=a[N],J[1]=a[N+1],A[1]=a[N+2],M[2]=a[Z],J[2]=a[Z+1],A[2]=a[Z+2],y&&(A[0]<0&&(A[0]=-A[0]),A[1]<0&&(A[1]=-A[1]),A[2]<0&&(A[2]=-A[2]))
var L=w[0]<w[1]?0:1
L=w[L]<w[2]?L:2
var U=w[0]>w[1]?0:1
U=w[U]>w[2]?U:2
var T=3-U-L
if(L!=U){var P=b[U],H=B[U],E=255*A[U],z=(M[U]/2+.5)*v&x,W=(.5-J[U]/2)*v&x,O=w[U]-w[L]
O=0!=O?O:1
var G=(b[U]-b[L])/O,K=(B[U]-B[L])/O,q=255*(A[U]-A[L])/O,j=(M[U]-M[L])/2*v/O,Q=(J[L]-J[U])/2*v/O,$=b[U],_=B[U],tt=255*A[U],et=(M[U]/2+.5)*v&x,it=(.5-J[U]/2)*v&x,rt=w[U]-w[T]
rt=0!=rt?rt:1
var st=(b[U]-b[T])/rt,at=(B[U]-B[T])/rt,ot=255*(A[U]-A[T])/rt,nt=(M[U]-M[T])/2*v/rt,ht=(J[T]-J[U])/2*v/rt,lt=b[T],ft=B[T],ut=255*A[T],mt=(M[T]/2+.5)*v&x,ct=(.5-J[T]/2)*v&x,pt=w[T]-w[L]
pt=0!=pt?pt:1
for(var dt=(b[T]-b[L])/pt,gt=(B[T]-B[L])/pt,vt=255*(A[T]-A[L])/pt,xt=(M[T]-M[L])/2*v/pt,Ct=(J[L]-J[T])/2*v/pt,Dt=w[U]*e,St=w[U];St>w[L];St--){if(St>=0&&i>St){var yt,bt,wt,Bt,Mt,Jt=~~P,At=H,Vt=E,kt=z,Yt=W
if(St>w[T]?(yt=~~$,bt=_,wt=tt,Bt=et,Mt=it):(yt=~~lt,bt=ft,wt=ut,Bt=mt,Mt=ct),Jt>yt){var Xt
Xt=Jt,Jt=yt,yt=Xt,Xt=At,At=bt,bt=Xt,Xt=Vt,Vt=wt,wt=Xt,Xt=kt,kt=Bt,Bt=Xt,Xt=Yt,Yt=Mt,Mt=Xt}var It=Jt!=yt?(bt-At)/(yt-Jt):1,Rt=Jt!=yt?(wt-Vt)/(yt-Jt):1,Ft=Jt!=yt?(Bt-kt)/(yt-Jt):1,Nt=Jt!=yt?(Mt-Yt)/(yt-Jt):1
0>Jt&&(At-=Jt*It,Vt-=Jt*Rt,kt-=kt*Ft,Yt-=Yt*Nt,Jt=0),yt>=e&&(yt=e-1)
var Zt=Dt+Jt
if(C)for(var Lt=Jt,Ut=At,Tt=Vt,Pt=kt,Ht=Yt;yt>=Lt;Lt++,Ut+=It,Tt+=Rt,Pt+=Ft,Ht+=Nt){if(Ut>l[Zt]){l[Zt]=Ut
var Et=p[Tt>0?~~Tt:0],zt=g[(Ht&x)*v+(Pt&x)],Wt=((16711680&Et)>>16)*((16711680&zt)>>8),Ot=((65280&Et)>>8)*((65280&zt)>>8),Gt=(255&Et)*(255&zt)>>8
h[Zt]=4278190080|16711680&Wt|65280&Ot|255&Gt,f[Zt]=m}Zt++}else for(var Lt=Jt,Ut=At,Tt=Vt,Pt=kt,Ht=Yt;yt>Lt;Lt++,Ut+=It,Tt+=Rt,Pt+=Ft,Ht+=Nt){if(Ut>l[Zt]){var Et=p[Tt>0?~~Tt:0],Kt=g[(Ht&x)*v+(Pt&x)],qt=h[Zt],Wt=((16711680&Et)>>16)*((16711680&Kt)>>8),Ot=((65280&Et)>>8)*((65280&Kt)>>8),Gt=(255&Et)*(255&Kt)>>8,jt=4278190080&(qt|Et)
Wt=Wt*S+(16711680&qt)*D>>8,Ot=Ot*S+(65280&qt)*D>>8,Gt=Gt*S+(255&qt)*D>>8,h[Zt]=jt|16711680&Wt|65280&Ot|255&Gt,f[Zt]=m}Zt++}}P-=G,H-=K,E-=q,z-=j,W-=Q,St>w[T]?($-=st,_-=at,tt-=ot,et-=nt,it-=ht):(lt-=dt,ft-=gt,ut-=vt,mt-=xt,ct-=Ct),Dt-=e}}I=R,N=Z}while(-1!=r[k])
k++}}}},JSC3D.Viewer.prototype.params=null,JSC3D.Viewer.prototype.canvas=null,JSC3D.Viewer.prototype.ctx2d=null,JSC3D.Viewer.prototype.canvasData=null,JSC3D.Viewer.prototype.bkgColorBuffer=null,JSC3D.Viewer.prototype.colorBuffer=null,JSC3D.Viewer.prototype.zBuffer=null,JSC3D.Viewer.prototype.selectionBuffer=null,JSC3D.Viewer.prototype.frameWidth=0,JSC3D.Viewer.prototype.frameHeight=0,JSC3D.Viewer.prototype.scene=null,JSC3D.Viewer.prototype.textures=[],JSC3D.Viewer.prototype.materials=[],JSC3D.Viewer.prototype.defaultMaterial=null,JSC3D.Viewer.prototype.sphereMap=null,JSC3D.Viewer.prototype.isLoaded=!1,JSC3D.Viewer.prototype.isFailed=!1,JSC3D.Viewer.prototype.needUpdate=!1,JSC3D.Viewer.prototype.needRepaint=!1,JSC3D.Viewer.prototype.initRotX=0,JSC3D.Viewer.prototype.initRotY=0,JSC3D.Viewer.prototype.initRotZ=0,JSC3D.Viewer.prototype.initSceneRotation=0,JSC3D.Viewer.prototype.sceneRotation=0,JSC3D.Viewer.prototype.zoomFactor=1,JSC3D.Viewer.prototype.panning=[0,0],JSC3D.Viewer.prototype.rotation=[0,0,0],JSC3D.Viewer.prototype.fps=0,JSC3D.Viewer.prototype.frameNumber=0,JSC3D.Viewer.prototype.rotMatrix=null,JSC3D.Viewer.prototype.transformMatrix=null,JSC3D.Viewer.prototype.sceneUrl="",JSC3D.Viewer.prototype.modelColor=13280792,JSC3D.Viewer.prototype.bkgColor1=16777215,JSC3D.Viewer.prototype.bkgColor2=16777088,JSC3D.Viewer.prototype.renderMode="flat",JSC3D.Viewer.prototype.definition="standard",JSC3D.Viewer.prototype.isCullingDisabled=!1,JSC3D.Viewer.prototype.isMipMappingOn=!1,JSC3D.Viewer.prototype.creaseAngle=-180,JSC3D.Viewer.prototype.sphereMapUrl="",JSC3D.Viewer.prototype.showProgressBar=!0,JSC3D.Viewer.prototype.isAutoUpdateOn=!1,JSC3D.Viewer.prototype.autoRotateSpeed=0,JSC3D.Viewer.prototype.lightingMode="standard",JSC3D.Viewer.prototype.showLights=!1,JSC3D.Viewer.prototype.buttonStates=null,JSC3D.Viewer.prototype.keyStates=null,JSC3D.Viewer.prototype.mouseX=0,JSC3D.Viewer.prototype.mouseY=0,JSC3D.Viewer.prototype.onloadingstarted=null,JSC3D.Viewer.prototype.onloadingcomplete=null,JSC3D.Viewer.prototype.onloadingprogress=null,JSC3D.Viewer.prototype.onloadingaborted=null,JSC3D.Viewer.prototype.onloadingerror=null,JSC3D.Viewer.prototype.onmousedown=null,JSC3D.Viewer.prototype.onmouseup=null,JSC3D.Viewer.prototype.onmousemove=null,JSC3D.Viewer.prototype.onmousewheel=null,JSC3D.Viewer.prototype.onmouseclick=null,JSC3D.Viewer.prototype.beforeupdate=null,JSC3D.Viewer.prototype.afterupdate=null,JSC3D.Viewer.prototype.mouseUsage="default",JSC3D.Viewer.prototype.isDefaultInputHandlerEnabled=!1,JSC3D.Viewer.prototype.isSceneRotationEnabled=!1,JSC3D.Viewer.prototype.onscenerotation=null,JSC3D.Viewer.prototype.ontick=null,JSC3D.PickInfo=function(){this.canvasX=0,this.canvasY=0,this.depth=-(1/0),this.mesh=null},JSC3D.Scene=function(t){this.name=t||"",this.srcUrl="",this.aabb=null,this.children=[],this.maxChildId=1,this.currentMesh=null,this.isLightingOn=!1,this.rotMat=new JSC3D.Matrix3x4,this.xformMat=new JSC3D.Matrix3x4,this.lights=[]},JSC3D.Scene.prototype.init=function(){if(!this.isEmpty()){this.currentMesh=null
for(var t=0;t<this.children.length;t++)this.children[t].init()
this.aabb||(this.aabb=new JSC3D.AABB,this.calcAABB())}},JSC3D.Scene.prototype.isEmpty=function(){return 0==this.children.length},JSC3D.Scene.prototype.addChild=function(t){t.internalId=this.maxChildId++,t.axis||t.setAxis(),this.children.push(t)},JSC3D.Scene.prototype.removeChild=function(t){var e=this.children.indexOf(t)
e>=0&&this.children.splice(e,1)},JSC3D.Scene.prototype.getChildren=function(){return this.children.slice(0)},JSC3D.Scene.prototype.forEachChild=function(t){if("function"==typeof t)for(var e=0;e<this.children.length&&!t.call(null,this.children[e]);e++);},JSC3D.Scene.prototype.calcAABB=function(){this.aabb.minX=this.aabb.minY=this.aabb.minZ=1/0,this.aabb.maxX=this.aabb.maxY=this.aabb.maxZ=-(1/0)
for(var t=0;t<this.children.length;t++){var e=this.children[t]
if(!e.isTrivial()){var i=e.aabb.minX,r=e.aabb.minY,s=e.aabb.minZ,a=e.aabb.maxX,o=e.aabb.maxY,n=e.aabb.maxZ
this.aabb.minX>i&&(this.aabb.minX=i),this.aabb.minY>r&&(this.aabb.minY=r),this.aabb.minZ>s&&(this.aabb.minZ=s),this.aabb.maxX<a&&(this.aabb.maxX=a),this.aabb.maxY<o&&(this.aabb.maxY=o),this.aabb.maxZ<n&&(this.aabb.maxZ=n)}}},JSC3D.Scene.prototype.name="",JSC3D.Scene.prototype.srcUrl="",JSC3D.Scene.prototype.aabb=null,JSC3D.Scene.prototype.children=null,JSC3D.Scene.prototype.maxChildId=1,JSC3D.Scene.prototype.currentMesh=null,JSC3D.Scene.prototype.isLightingOn=!1,JSC3D.Scene.prototype.xformMat=null,JSC3D.Scene.prototype.lights=[],JSC3D.Scene.prototype.getMeshes=function(t){for(var e=[],i=0,r=this.children.length;r>i;i++){var s=this.children[i]
s.name===t&&e.push(s)}return e},JSC3D.Scene.prototype.toggleMeshes=function(t,e){for(var i=this.getMeshes(t),r=0,s=i.length;s>r;r++){var a=i[r]
a.visible=e}},JSC3D.Scene.prototype.renameMeshes=function(t,e){for(var i=this.getMeshes(t),r=0,s=i.length;s>r;r++){var a=i[r]
a.setGroupName(e)}},JSC3D.Scene.prototype.rotateMeshes=function(t,e,i){for(var r=this.getMeshes(t),s=0,a=r.length;a>s;s++){var o=r[s]
o.rotate(e,i)}},JSC3D.Scene.prototype.translateMeshes=function(t,e,i){for(var r=this.getMeshes(t),s=0,a=r.length;a>s;s++){var o=r[s]
o.translate(e,i)}},JSC3D.Scene.prototype.relocateMeshes=function(t,e,i){for(var r=this.getMeshes(t),s=0,a=r.length;a>s;s++){var o=r[s]
o.relocate(e,i)}},JSC3D.Scene.prototype.scaleMeshes=function(t,e,i){for(var r=this.getMeshes(t),s=0,a=r.length;a>s;s++){var o=r[s]
o.scale(e,i)}},JSC3D.Scene.prototype.resizeMeshes=function(t,e,i){for(var r=this.getMeshes(t),s=0,a=r.length;a>s;s++){var o=r[s]
o.resize(e,i)}},JSC3D.Scene.prototype.transformMeshes=function(t,e,i,r,s,a,o){for(var n=this.getMeshes(t),h=0,l=n.length;l>h;h++){var f=n[h]
f.transform(e,i,r,s,a,o)}},JSC3D.Scene.prototype.shiftMeshesX=function(t){for(var e=this.getMeshes(t),i=0,r=e.length;r>i;i++){var s=e[i]
s.shiftX()}},JSC3D.Scene.prototype.shiftMeshesZ=function(t){for(var e=this.getMeshes(t),i=0,r=e.length;r>i;i++){var s=e[i]
s.shiftZ()}},JSC3D.Scene.prototype.cloneMeshes=function(t,e,i,r,s,a,o,n){for(var h=this.getMeshes(t),l=0,f=h.length;f>l;l++){var u=h[l],m=u.clone(e,i,r,s,a,o,n)
this.addChild(m)}},JSC3D.Scene.prototype.makeGroundPlane=function(t,e,i){var r=i||"wireframe",s=!0,a=this.aabb,o=a.center(),n=.5*Math.max(a.maxX-a.minX,a.maxZ-a.minZ),h=o[0]-n,l=o[2]-n,f=a.minY-.001*(a.maxY-a.minY),u=new JSC3D.Mesh
if(u.name="groundplane","texture"==i||"textureflat"==i||"texturesmooth"==i)u.vertexBuffer=[l,f,-h,-l,f,-h,-l,f,h,l,f,h],u.indexBuffer=[0,1,2,-1,3,0,2,-1],u.texCoordBuffer=[1,0,0,0,0,1,1,1],u.texCoordIndexBuffer=[0,1,2,-1,3,0,2,-1]
else{var m=10,c=2*n/m
u.vertexBuffer=[]
for(var p=0;m>=p;p++)for(var d=0;m>=d;d++)u.vertexBuffer.push(h+d*c,f,l+p*c)
u.indexBuffer=[]
for(var p=0;m>p;p++)for(var d=0;m>d;d++)u.indexBuffer.push(p*(m+1)+d,(p+1)*(m+1)+d,(p+1)*(m+1)+d+1,p*(m+1)+d+1,-1)}return u.isDoubleSided=!0,("point"==i||"wireframe"==i||"flat"==i||"texture"==i)&&(s=!1),e&&(u.setTexture(e),u.texture.isLightingCast=s),t&&(u.setMaterial(new JSC3D.Material("groundplane",void 0,t)),u.material.isLightingCast=s),u.setRenderMode(r),u.init(),this.addChild(u),this.children[this.children.length-1]},JSC3D.Scene.prototype.makeLightSphere=function(t,e){var i=new JSC3D.Mesh,r=this.lights.length
i.name="light",i.groupIndex=r,i.vertexBuffer=[],i.indexBuffer=[]
for(var s=1,a=(1+Math.sqrt(5))/2,o=a/Math.sqrt(1+a*a)*s,n=1/Math.sqrt(1+a*a)*s,h={points:[[o,n,0],[-o,n,0],[-o,-n,0],[o,-n,0],[n,0,o],[n,0,-o],[-n,0,-o],[-n,0,o],[0,o,n],[0,-o,n],[0,-o,-n],[0,o,-n]],faces:[[4,8,7],[4,7,9],[5,6,11],[5,10,6],[0,4,3],[0,3,5],[2,7,1],[2,1,6],[8,0,11],[8,11,1],[9,10,3],[9,2,10],[8,4,0],[11,0,5],[4,9,3],[5,3,10],[7,8,1],[6,1,11],[7,2,9],[6,10,2]]},l=0,f=h.points.length;f>l;l++)for(var u=0;3>u;u++)i.vertexBuffer.push(h.points[l][u])
for(var l=0,f=h.faces.length;f>l;l++){for(var u=0;3>u;u++)i.indexBuffer.push(h.faces[l][u])
i.indexBuffer.push(-1)}return i.creaseAngle=41,i.init(),i.setRenderMode(e),i.setMaterial(new JSC3D.Material("light-"+r,void 0,t)),this.addChild(i),this.children[this.children.length-1]},JSC3D.Scene.prototype.addLight=function(t,e,i,r,s,a,o){var n=this.aabb,h=.01*Math.max(n.maxX-n.minX,n.maxZ-n.minZ),l=this.lights.length
6==l&&JSC3D.console&&JSC3D.console.logError("Cannot add another light. Max number of lights reached!")
var f=new JSC3D.Light("light",[t,e,i],r,s,a)
f.groupIndex=l+1,this.lights.push(f)
var u=this.makeLightSphere(s,"flat")
u.isPositionFixed=!0,u.resize([h,h,h],"center"),u.translate([t,e,i],"scene"),u.visible=this.isLightingOn?o:!1},JSC3D.Mesh=function(t,e,i,r,s,a,o,n,h,l,f){this.name=t||"",this.groupIndex=0,this.metadata="",this.visible=void 0!=e?e:!0,this.renderMode=null,this.aabb=null,this.axis=null,this.rotation=[0,0,0],this.translation=[0,0,0],this.scaling=[1,1,1],this.vertexBuffer=n||null,this.indexBuffer=h||null,this.vertexNormalBuffer=null,this.vertexNormalIndexBuffer=null,this.faceNormalBuffer=null,this.material=i||null,this.texture=r||null,this.faceCount=0,this.creaseAngle=s>=0?s:-180,this.isDoubleSided="boolean"==typeof a?a:!1,this.isPositionFixed="boolean"==typeof o?o:!1,this.internalId=0,this.texCoordBuffer=l||null,this.texCoordIndexBuffer=f||null,this.transformedVertexBuffer=null,this.transformedVertexNormalZBuffer=null,this.transformedFaceNormalZBuffer=null,this.transformedVertexNormalBuffer=null},JSC3D.Mesh.prototype.init=function(){this.isTrivial()||(0!=this.faceCount||(this.calcFaceCount(),0!=this.faceCount))&&(this.aabb||(this.aabb=new JSC3D.AABB,this.calcAABB()),this.faceNormalBuffer||(this.faceNormalBuffer=Array(3*this.faceCount),this.calcFaceNormals()),this.vertexNormalBuffer||(this.creaseAngle>=0?this.calcCreasedVertexNormals():(this.vertexNormalBuffer=Array(this.vertexBuffer.length),this.calcVertexNormals())),this.normalizeFaceNormals(),this.transformedVertexBuffer=Array(this.vertexBuffer.length))},JSC3D.Mesh.prototype.isTrivial=function(){return!this.vertexBuffer||this.vertexBuffer.length<3||!this.indexBuffer||this.indexBuffer.length<3},JSC3D.Mesh.prototype.setMaterial=function(t){t&&(this.material=t)},JSC3D.Mesh.prototype.setTexture=function(t){t&&(this.texture=t)},JSC3D.Mesh.prototype.hasTexture=function(){return null!=this.texture&&this.texture.hasData()&&null!=this.texCoordBuffer&&this.texCoordBuffer.length>=2&&(null==this.texCoordIndexBuffer||this.texCoordIndexBuffer.length>=3&&this.texCoordIndexBuffer.length>=this.indexBuffer.length)},JSC3D.Mesh.prototype.setRenderMode=function(t){this.renderMode=t},JSC3D.Mesh.prototype.calcFaceCount=function(){this.faceCount=0
var t=this.indexBuffer;-1!=t[t.length-1]&&t.push(-1)
for(var e=0;e<t.length;e++)-1==t[e]&&this.faceCount++},JSC3D.Mesh.prototype.calcAABB=function(){var t,e,i,r,s,a
t=e=i=1/0,r=s=a=-(1/0)
for(var o=this.vertexBuffer,n=0;n<o.length;n+=3){var h=o[n],l=o[n+1],f=o[n+2]
t>h&&(t=h),h>r&&(r=h),e>l&&(e=l),l>s&&(s=l),i>f&&(i=f),f>a&&(a=f)}this.aabb.minX=t,this.aabb.minY=e,this.aabb.minZ=i,this.aabb.maxX=r,this.aabb.maxY=s,this.aabb.maxZ=a},JSC3D.Mesh.prototype.getSize=function(){var t=this.aabb
return[t.maxX-t.minX,t.maxY-t.minY,t.maxZ-t.minZ]},JSC3D.Mesh.prototype.setAxis=function(){this.aabb||(this.aabb=new JSC3D.AABB,this.calcAABB()),this.axis=this.aabb.center()},JSC3D.Mesh.prototype.calcFaceNormals=function(){for(var t=this.vertexBuffer,e=this.indexBuffer,i=this.faceNormalBuffer,r=0,s=0;r<e.length;){var a=3*e[r++],o=t[a],n=t[a+1],h=t[a+2]
a=3*e[r++]
var l=t[a],f=t[a+1],u=t[a+2]
a=3*e[r++]
var m=t[a],c=t[a+1],p=t[a+2],d=l-o,g=f-n,v=u-h,x=m-o,C=c-n,D=p-h,S=g*D-v*C,y=v*x-d*D,b=d*C-g*x
i[s++]=S,i[s++]=y,i[s++]=b
do;while(-1!=e[r++])}},JSC3D.Mesh.prototype.normalizeFaceNormals=function(){JSC3D.Math3D.normalizeVectors(this.faceNormalBuffer,this.faceNormalBuffer)},JSC3D.Mesh.prototype.calcVertexNormals=function(){this.faceNormalBuffer||(this.faceNormalBuffer=Array(3*this.faceCount),this.calcFaceNormals())
for(var t=this.vertexBuffer,e=this.indexBuffer,i=this.faceNormalBuffer,r=this.vertexNormalBuffer,s=0;s<r.length;s++)r[s]=0
this.vertexNormalIndexBuffer=null
for(var s=(t.length/3,0),a=0,o=0;s<e.length;)if(o=e[s++],-1==o)a+=3
else{var n=3*o
r[n]+=i[a],r[n+1]+=i[a+1],r[n+2]+=i[a+2]}JSC3D.Math3D.normalizeVectors(r,r)},JSC3D.Mesh.prototype.calcCreasedVertexNormals=function(){this.faceNormalBuffer||(this.faceNormalBuffer=Array(3*this.faceCount),this.calcFaceNormals())
for(var t=this.indexBuffer,e=this.vertexBuffer.length/3,i=Array(e),r=0,s=0,a=0,o=0;s<t.length;s++)if(o=t[s],o>=0){r+=3
var n=i[o]
n?n.push(a):i[o]=[a]}else a++
var h=this.faceNormalBuffer,l=Array(h.length)
JSC3D.Math3D.normalizeVectors(h,l),(!this.vertexNormalBuffer||this.vertexNormalBuffer.length<r)&&(this.vertexNormalBuffer=Array(r))
for(var f=this.vertexNormalBuffer,s=0,u=f.length;u>s;s++)f[s]=0
this.vertexNormalIndexBuffer=[]
for(var m,c,p,n,d,g,v,x,C,D,S=this.vertexNormalIndexBuffer,y=Math.cos(this.creaseAngle*Math.PI/180),o=0,b=0,w=0,s=0,u=t.length;u>s;s++)if(o=t[s],o>=0){d=3*b,g=3*w,f[d]+=h[g],f[d+1]+=h[g+1],f[d+2]+=h[g+2],m=l[g],c=l[g+1],p=l[g+2],n=i[o]
for(var B=0,M=n.length;M>B;B++){var J=n[B]
w!=J&&(v=3*J,x=l[v],C=l[v+1],D=l[v+2],m*x+c*C+p*D>y&&(f[d]+=h[v],f[d+1]+=h[v+1],f[d+2]+=h[v+2]))}S.push(b++)}else w++,S.push(-1)
JSC3D.Math3D.normalizeVectors(f,f)},JSC3D.Mesh.prototype.checkValid=function(){},JSC3D.Mesh.prototype.name="",JSC3D.Mesh.prototype.groupIndex=0,JSC3D.Mesh.prototype.metadata="",JSC3D.Mesh.prototype.visible=!1,JSC3D.Mesh.prototype.renderMode="flat",JSC3D.Mesh.prototype.aabb=null,JSC3D.Mesh.prototype.axis=null,JSC3D.Mesh.prototype.rotation=null,JSC3D.Mesh.prototype.translation=null,JSC3D.Mesh.prototype.scaling=null,JSC3D.Mesh.prototype.vertexBuffer=null,JSC3D.Mesh.prototype.indexBuffer=null,JSC3D.Mesh.prototype.vertexNormalBuffer=null,JSC3D.Mesh.prototype.vertexNormalIndexBuffer=null,JSC3D.Mesh.prototype.faceNormalBuffer=null,JSC3D.Mesh.prototype.texCoordBuffer=null,JSC3D.Mesh.prototype.texCoordIndexBuffer=null,JSC3D.Mesh.prototype.material=null,JSC3D.Mesh.prototype.texture=null,JSC3D.Mesh.prototype.faceCount=0,JSC3D.Mesh.prototype.creaseAngle=-180,JSC3D.Mesh.prototype.isDoubleSided=!1,JSC3D.Mesh.prototype.isPositionFixed=!1,JSC3D.Mesh.prototype.internalId=0,JSC3D.Mesh.prototype.transformedVertexBuffer=null,JSC3D.Mesh.prototype.transformedVertexNormalZBuffer=null,JSC3D.Mesh.prototype.transformedFaceNormalZBuffer=null,JSC3D.Mesh.prototype.transformedVertexNormalBuffer=null,JSC3D.Mesh.prototype.rotate=function(t,e){var i,r=new JSC3D.Matrix3x4,s=new JSC3D.Matrix3x4,a=new JSC3D.Matrix3x4
this.aabb.center()
switch(e){case"axis":i=[this.translation[0],this.translation[1],this.translation[2]]
break
case"scene":break
case"center":i=this.aabb.center()}var o=360,n=180
t[0]%=o,t[1]%=o,t[2]%=o
var h=this.rotation[0]+t[0],l=this.rotation[1]+t[1],f=this.rotation[2]+t[2],u=t[0],m=t[1],c=t[2];-n>h&&(u+=o),h>=n&&(u-=o),-n>l&&(m+=o),l>=n&&(m-=o),-n>f&&(c+=o),f>=n&&(c-=o),this.rotation[0]+=u,this.rotation[1]+=m,this.rotation[2]+=c,u&&s.rotateAboutXAxis(u),m&&s.rotateAboutYAxis(m),c&&s.rotateAboutZAxis(c),i&&a.translate(-i[0],-i[1],-i[2]),u&&a.rotateAboutXAxis(u),m&&a.rotateAboutYAxis(m),c&&a.rotateAboutZAxis(c),i&&a.translate(i[0],i[1],i[2]),r.multiply(a),JSC3D.Math3D.transformVectors(r,this.vertexBuffer,this.vertexBuffer),JSC3D.Math3D.transformVectors(s,this.faceNormalBuffer,this.faceNormalBuffer),JSC3D.Math3D.transformVectors(s,this.vertexNormalBuffer,this.vertexNormalBuffer),this.calcAABB(),this.compiled=null},JSC3D.Mesh.prototype.translate=function(t,e){var i=new JSC3D.Matrix3x4
this.translation[0]+=t[0],this.translation[1]+=t[1],this.translation[2]+=t[2],i.translate(t[0],t[1],t[2]),JSC3D.Math3D.transformVectors(i,this.vertexBuffer,this.vertexBuffer),this.calcAABB(),this.compiled=null},JSC3D.Mesh.prototype.relocate=function(t,e){var i=new JSC3D.Matrix3x4,r=this.translation[0],s=this.translation[1],a=this.translation[2],o=t[0]-r,n=t[1]-s,h=t[2]-a
this.translation[0]+=o,this.translation[1]+=n,this.translation[2]+=h,i.translate(o,n,h),JSC3D.Math3D.transformVectors(i,this.vertexBuffer,this.vertexBuffer),this.calcAABB(),this.compiled=null},JSC3D.Mesh.prototype.scale=function(t,e){var i=new JSC3D.Matrix3x4,r=this.aabb,s=r.center(),a=1,o=1,n=1
t[0]&&(a=t[0]/this.scaling[0],this.scaling[0]*=a),t[1]&&(o=t[1]/this.scaling[1],this.scaling[1]*=o),t[2]&&(n=t[2]/this.scaling[2],this.scaling[2]*=n),i.scale(a,o,n)
var h=0,l=0,f=0
switch(e){case"plus":h=r.minX-r.minX*a,l=r.minY-r.minY*o,f=r.minZ-r.minZ*n
break
case"minus":h=r.maxX-r.maxX*a,l=r.maxY-r.maxY*o,f=r.maxZ-r.maxZ*n
break
case"center":h=s[0]-s[0]*a,l=s[1]-s[1]*o,f=s[2]-s[2]*n}i.translate(h,l,f),JSC3D.Math3D.transformVectors(i,this.vertexBuffer,this.vertexBuffer),this.calcAABB(),this.compiled=null;[r.maxX-r.minX,r.maxY-r.minY,r.maxZ-r.minZ]},JSC3D.Mesh.prototype.transform=function(t,e,i,r,s,a){var o
this.aabb.center()
switch(e){case"axis":o=[this.translation[0],this.translation[1],this.translation[2]]
break
case"scene":break
case"center":o=this.aabb.center()}var n=new JSC3D.Matrix3x4,h=new JSC3D.Matrix3x4,l=new JSC3D.Matrix3x4
if(t){var f=360,u=180
t[0]%=f,t[1]%=f,t[2]%=f
var m=this.rotation[0]+t[0],c=this.rotation[1]+t[1],p=this.rotation[2]+t[2],d=t[0],g=t[1],v=t[2];-u>m&&(d+=f),m>=u&&(d-=f),-u>c&&(g+=f),c>=u&&(g-=f),-u>p&&(v+=f),p>=u&&(v-=f),this.rotation[0]+=d,this.rotation[1]+=g,this.rotation[2]+=v,o&&l.translate(-o[0],-o[1],-o[2]),h.rotateAboutXAxis(t[0]),l.rotateAboutXAxis(t[0]),h.rotateAboutYAxis(t[1]),l.rotateAboutYAxis(t[1]),h.rotateAboutZAxis(t[2]),l.rotateAboutZAxis(t[2]),o&&l.translate(o[0],o[1],o[2])}if(n.multiply(l),i&&(this.translation[0]+=i[0],this.translation[1]+=i[1],this.translation[2]+=i[2],n.translate(i[0],i[1],i[2])),s){var x=1,C=1,D=1
s[0]&&(x=s[0]/this.scaling[0],this.scaling[0]*=x),s[1]&&(C=s[1]/this.scaling[1],this.scaling[1]*=C),s[2]&&(D=s[2]/this.scaling[2],this.scaling[2]*=D),n.scale(x,C,D)}JSC3D.Math3D.transformVectors(n,this.vertexBuffer,this.vertexBuffer),JSC3D.Math3D.transformVectors(h,this.faceNormalBuffer,this.faceNormalBuffer),JSC3D.Math3D.transformVectors(h,this.vertexNormalBuffer,this.vertexNormalBuffer)},JSC3D.Mesh.prototype.resize=function(t,e){var i=new JSC3D.Matrix3x4,r=this.aabb,s=[r.maxX-r.minX,r.maxY-r.minY,r.maxZ-r.minZ],a=r.center(),o=1,n=1,h=1
t[0]&&(o=t[0]/s[0],this.scaling[0]*=t[0]/s[0]),t[1]&&(n=t[1]/s[1],this.scaling[1]*=t[1]/s[1]),t[2]&&(h=t[2]/s[2],this.scaling[2]*=t[2]/s[2]),i.scale(o,n,h)
var l=0,f=0,u=0
switch(e){case"plus":l=r.minX-r.minX*o,f=r.minY-r.minY*n,u=r.minZ-r.minZ*h
break
case"minus":l=r.maxX-r.maxX*o,f=r.maxY-r.maxY*n,u=r.maxZ-r.maxZ*h
break
case"center":l=a[0]-a[0]*o,f=a[1]-a[1]*n,u=a[2]-a[2]*h}i.translate(l,f,u),JSC3D.Math3D.transformVectors(i,this.vertexBuffer,this.vertexBuffer),this.calcAABB(),this.compiled=null;[r.maxX-r.minX,r.maxY-r.minY,r.maxZ-r.minZ]},JSC3D.Mesh.prototype.shiftX=function(){var t=new JSC3D.Matrix3x4,e=this.axis,i=e[0]
t.translate(-2*i,0,0),JSC3D.Math3D.transformVectors(t,this.vertexBuffer,this.vertexBuffer),this.calcAABB(),this.compiled=null},JSC3D.Mesh.prototype.shiftZ=function(){var t=new JSC3D.Matrix3x4,e=this.axis,i=e[2]
t.translate(0,0,-2*i),JSC3D.Math3D.transformVectors(t,this.vertexBuffer,this.vertexBuffer),this.calcAABB(),this.compiled=null},JSC3D.Mesh.prototype.flipX=function(){var t,e,i=new JSC3D.Matrix3x4,r=new JSC3D.Matrix3x4,s=new JSC3D.Matrix3x4,a=new JSC3D.Matrix3x4,o=this.aabb.center(),n=o[0],h=o[1],l=o[2],f=180,u=90,m=0,c=this.rotation[1]
m>c&&c>=-u&&(t=-f-2*c,e=t),c>=m&&u>c&&(t=-f-2*c,e=t),c>=u&&f>c&&(t=2*(f-c)-f,e=t),-u>c&&c>=-f&&(t=f-2*(f+c),e=t),this.rotation[1]+=e,s.rotateAboutYAxis(t),a.translate(-n,-h,-l),a.rotateAboutYAxis(t),a.translate(n,h,l),i.multiply(a),JSC3D.Math3D.transformVectors(i,this.vertexBuffer,this.vertexBuffer),JSC3D.Math3D.transformVectors(s,this.faceNormalBuffer,this.faceNormalBuffer),JSC3D.Math3D.transformVectors(s,this.vertexNormalBuffer,this.vertexNormalBuffer),this.calcAABB()
var p=this.aabb.center(),d=p[0]
r.translate(-2*d,0,0),JSC3D.Math3D.transformVectors(r,this.vertexBuffer,this.vertexBuffer),this.calcAABB(),this.compiled=null},JSC3D.Mesh.prototype.flipZ=function(){var t,e,i=new JSC3D.Matrix3x4,r=new JSC3D.Matrix3x4,s=new JSC3D.Matrix3x4,a=new JSC3D.Matrix3x4,o=this.aabb.center(),n=o[0],h=o[1],l=o[2],f=360,u=180,m=90,c=0,p=this.rotation[1]
c>p&&p>=-m&&(t=-2*p,e=t),p>=c&&m>p&&(t=-2*p,e=t),p>=m&&u>p&&(t=f-2*p,e=t-f),-m>p&&p>-u&&(t=-f-2*p,e=t+f),p==-u&&(t=c,e=c),this.rotation[1]+=e,s.rotateAboutYAxis(t),a.translate(-n,-h,-l),a.rotateAboutYAxis(t),a.translate(n,h,l),i.multiply(a),JSC3D.Math3D.transformVectors(i,this.vertexBuffer,this.vertexBuffer),JSC3D.Math3D.transformVectors(s,this.faceNormalBuffer,this.faceNormalBuffer),JSC3D.Math3D.transformVectors(s,this.vertexNormalBuffer,this.vertexNormalBuffer),this.calcAABB()
var d=this.aabb.center(),g=d[2]
r.translate(0,0,-2*g),JSC3D.Math3D.transformVectors(r,this.vertexBuffer,this.vertexBuffer),this.calcAABB(),this.compiled=null},JSC3D.Mesh.prototype.clone=function(t,e,i,r,s,a,o){var n=new JSC3D.Mesh
n.name=t||this.name,n.groupIndex=this.groupIndex,n.visible=this.visible,n.creaseAngle=this.creaseAngle,n.isDoubleSided=this.isDoubleSided,n.renderMode=this.renderMode,n.axis=[this.axis[0],this.axis[1],this.axis[2]],n.mtllib=this.mtllib,n.mtl=this.mtl,n.setMaterial(this.material),n.setTexture(this.texture)
var h,l=new JSC3D.Matrix3x4,f=new JSC3D.Matrix3x4,u=new JSC3D.Matrix3x4
this.aabb.center()
switch(i){case"axis":h=[this.translation[0],this.translation[1],this.translation[2]]
break
case"scene":break
case"center":h=this.aabb.center()}if(e){var m=360,c=180
e[0]%=m,e[1]%=m,e[2]%=m
var p=this.rotation[0]+e[0],d=this.rotation[1]+e[1],g=this.rotation[2]+e[2],v=e[0],x=e[1],C=e[2];-c>p&&(v+=m),p>=c&&(v-=m),-c>d&&(x+=m),d>=c&&(x-=m),-c>g&&(C+=m),g>=c&&(C-=m),n.rotation[0]=v,n.rotation[1]=x,n.rotation[2]=C,h&&u.translate(-h[0],-h[1],-h[2]),f.rotateAboutXAxis(e[0]),u.rotateAboutXAxis(e[0]),f.rotateAboutYAxis(e[1]),u.rotateAboutYAxis(e[1]),f.rotateAboutZAxis(e[2]),u.rotateAboutZAxis(e[2]),h&&u.translate(h[0],h[1],h[2])}if(l.multiply(u),r){var D=this.translation[0]+r[0],S=this.translation[1]+r[1],y=this.translation[2]+r[2]
n.translation[0]=D,n.translation[1]=S,n.translation[2]=y,l.translate(r[0],r[1],r[2])}if(a){var b=1,w=1,B=1
a[0]&&(b=a[0]/this.scaling[0],this.scaling[0]*=b),a[1]&&(w=a[1]/this.scaling[1],this.scaling[1]*=w),a[2]&&(B=a[2]/this.scaling[2],this.scaling[2]*=B),l.scale(b,w,B)}return n.indexBuffer=this.indexBuffer,n.vertexBuffer=Array(this.vertexBuffer.length),n.faceNormalBuffer=Array(this.faceNormalBuffer.length),JSC3D.Math3D.transformVectors(l,this.vertexBuffer,n.vertexBuffer),JSC3D.Math3D.transformVectors(f,this.faceNormalBuffer,n.faceNormalBuffer),n.texCoordBuffer=[],n.texCoordIndexBuffer=[],n.init(),n},JSC3D.Mesh.prototype.getGroupName=function(){return this.name},JSC3D.Mesh.prototype.getGroupIndex=function(){return this.groupIndex},JSC3D.Mesh.prototype.setGroupName=function(t,e){var i=this.getGroupName(),r=this.getGroupIndex()
this.name=t?t:i,this.groupIndex=e?e:r},JSC3D.Material=function(t,e,i,r,s,a,o,n,h,l,f){this.name=t||"",this.diffuseColor=i||8355711,this.ambientColor="number"==typeof e?e:(16711680&this.diffuseColor)>>3&16711680|(65280&this.diffuseColor)>>3&65280|(255&this.diffuseColor)>>3,this.specularColor="number"==typeof r?r:i,this.ambientReflection="number"==typeof s?s:.2,this.diffuseReflection="number"==typeof a?a:1,this.specularReflection="number"==typeof o?o:0,this.shininess="number"==typeof n?n:1,this.simulateSpecular=this.specularReflection>0?!0:!1,this.transparency="number"==typeof h?h:0,this.isEnvironmentCast="boolean"==typeof l?l:!1,this.isLightingCast="boolean"==typeof f?f:!0,this.palette=null},JSC3D.Material.prototype.getPalette=function(){return this.palette||(this.palette=Array(256),this.generatePalette()),this.palette},JSC3D.Material.prototype.generatePalette=function(){var t,e,i,r=(16711680&this.ambientColor)>>16,s=(65280&this.ambientColor)>>8,a=255&this.ambientColor,o=(16711680&this.diffuseColor)>>16,n=(65280&this.diffuseColor)>>8,h=255&this.diffuseColor
if(this.simulateSpecular){for(var l=0;204>l;)t=Math.max(r,l*o/204),e=Math.max(s,l*n/204),i=Math.max(a,l*h/204),t>255&&(t=255),e>255&&(e=255),i>255&&(i=255),this.palette[l++]=t<<16|e<<8|i
for(;256>l;)t=Math.max(r,o+(l-204)*(255-o)/82),e=Math.max(s,n+(l-204)*(255-n)/82),i=Math.max(a,h+(l-204)*(255-h)/82),t>255&&(t=255),e>255&&(e=255),i>255&&(i=255),this.palette[l++]=t<<16|e<<8|i}else for(var l=0;256>l;){t=Math.max(r,l*o/256),e=Math.max(s,l*n/256),i=Math.max(a,l*h/256)
var f=l/256,u=0,m=1,c=1+Math.exp(-Math.pow(2*f-u,2))*m
t*=c,e*=c,i*=c,t>255&&(t=255),e>255&&(e=255),i>255&&(i=255),this.palette[l++]=t<<16|e<<8|i}},JSC3D.Material.prototype.name="",JSC3D.Material.prototype.ambientColor=0,JSC3D.Material.prototype.diffuseColor=8355711,JSC3D.Material.prototype.specularColor=8355711,JSC3D.Material.prototype.ambientReflection=.2,JSC3D.Material.prototype.diffuseReflection=1,JSC3D.Material.prototype.specularReflection=0,JSC3D.Material.prototype.shininess=50,JSC3D.Material.prototype.transparency=0,JSC3D.Material.prototype.isLightingCast=!0,JSC3D.Material.prototype.isEnvironmentCast=!1,JSC3D.Material.prototype.simulateSpecular=!1,JSC3D.Material.prototype.palette=null,JSC3D.Texture=function(t,e){this.name=t||"",this.width=0,this.height=0,this.data=null,this.mipmaps=null,this.mipentries=null,this.hasTransparency=!1,this.isLightingCast=!0,this.isEnvironmentCast=!1,this.srcUrl="",this.onready=e&&"function"==typeof e?e:null},JSC3D.Texture.prototype.createFromUrl=function(t,e){var i=this,r=new Image
r.onload=function(){i.data=null,i.mipmaps=null,i.mipentries=null,i.width=0,i.height=0,i.hasTransparency=!1,i.srcUrl="",i.createFromImage(this,e),JSC3D.console&&JSC3D.console.logInfo('Finished loading texture image file "'+this.src+'".')},r.onerror=function(){i.data=null,i.mipmaps=null,i.mipentries=null,i.width=0,i.height=0,i.hasTransparency=!1,i.srcUrl="",JSC3D.console&&JSC3D.console.logWarning('Failed to load texture image file "'+this.src+'". This texture will be discarded.')},r.crossOrigin="anonymous",r.src=encodeURI(t)},JSC3D.Texture.prototype.createFromImage=function(t,e){if(!(t.width<=0||t.height<=0)){var i=!1,r=JSC3D.Texture.cv
if(!r)try{r=document.createElement("canvas"),JSC3D.Texture.cv=r,i=!0}catch(s){return}var a=t.width>t.height?t.width:t.height
a=16>=a?16:32>=a?32:64>=a?64:128>=a?128:256>=a?256:512>=a?512:1024,(r.width!=a||r.height!=a)&&(r.width=r.height=a,i=!0)
var o
try{var n=r.getContext("2d")
i||n.clearRect(0,0,a,a),n.drawImage(t,0,0,a,a)
var h=n.getImageData(0,0,a,a)
o=h.data}catch(s){return}var l=o.length/4
this.data=Array(l)
for(var f,u=0,m=0;l>u;u++,m+=4)f=o[m+3],this.data[u]=f<<24|o[m]<<16|o[m+1]<<8|o[m+2],255>f&&(this.hasTransparency=!0)
this.width=a,this.height=a,this.mipmaps=null,e&&this.generateMipmaps(),this.srcUrl=t.src,null!=this.onready&&"function"==typeof this.onready&&this.onready()}},JSC3D.Texture.prototype.hasData=function(){return null!=this.data},JSC3D.Texture.prototype.generateMipmaps=function(){if(!(this.width<=1||null==this.data||null!=this.mipmaps)){this.mipmaps=[this.data],this.mipentries=[1]
for(var t=1+~~(.1+Math.log(this.width)*Math.LOG2E),e=this.width>>1,i=1;t>i;i++){for(var r=Array(e*e),s=this.mipmaps[i-1],a=e<<1,o=0,n=0,h=0;e>h;h++){for(var l=0;e>l;l++){var f=s[o],u=s[o+1],m=s[o+a],c=s[o+a+1],p=((4278190080&f)>>>2)+((4278190080&u)>>>2)+((4278190080&m)>>>2)+((4278190080&c)>>>2)&4278190080,d=(16711680&f)+(16711680&u)+(16711680&m)+(16711680&c)>>2&16711680,g=(65280&f)+(65280&u)+(65280&m)+(65280&c)>>2&65280,v=(255&f)+(255&u)+(255&m)+(255&c)>>2&255
r[n]=p+d+g+v,o+=2,n++}o+=a}this.mipmaps.push(r),this.mipentries.push(Math.pow(4,i)),e>>=1}}},JSC3D.Texture.prototype.hasMipmap=function(){return null!=this.mipmaps},JSC3D.Texture.prototype.name="",JSC3D.Texture.prototype.data=null,JSC3D.Texture.prototype.mipmaps=null,JSC3D.Texture.prototype.mipentries=null,JSC3D.Texture.prototype.isLightingCast=!0,JSC3D.Texture.prototype.isEnvironmentCast=!1,JSC3D.Texture.prototype.width=0,JSC3D.Texture.prototype.height=0,JSC3D.Texture.prototype.hasTransparency=!1,JSC3D.Texture.prototype.srcUrl="",JSC3D.Texture.prototype.onready=null,JSC3D.Texture.cv=null,JSC3D.Light=function(t,e,i,r,s){var a=(16711680&r)>>16,o=(65280&r)>>8,n=255&r,h="number"==typeof i?i:a>>3&16711680|o>>3&65280|n>>3
this.name=t||"light",this.position=e||[0,0,0],this.transformedPosition=[0,0,0],this.ambientColor=h,this.diffuseColor=r,this.enabled=s},JSC3D.AABB=function(){this.minX=0,this.minY=0,this.minZ=0,this.maxX=0,this.maxY=0,this.maxZ=0},JSC3D.AABB.prototype.center=function(t){return t?(t[0]=.5*(this.minX+this.maxX),t[1]=.5*(this.minY+this.maxY),t[2]=.5*(this.minZ+this.maxZ)):t=[.5*(this.minX+this.maxX),.5*(this.minY+this.maxY),.5*(this.minZ+this.maxZ)],t},JSC3D.AABB.prototype.lengthOfDiagonal=function(){var t=this.maxX-this.minX,e=this.maxY-this.minY,i=this.maxZ-this.minZ
return Math.sqrt(t*t+e*e+i*i)},JSC3D.Matrix3x4=function(){this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m10=0,this.m11=1,this.m12=0,this.m13=0,this.m20=0,this.m21=0,this.m22=1,this.m23=0},JSC3D.Matrix3x4.prototype.identity=function(){this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m10=0,this.m11=1,this.m12=0,this.m13=0,this.m20=0,this.m21=0,this.m22=1,this.m23=0},JSC3D.Matrix3x4.prototype.scale=function(t,e,i){this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m10*=e,this.m11*=e,this.m12*=e,this.m13*=e,this.m20*=i,this.m21*=i,this.m22*=i,this.m23*=i},JSC3D.Matrix3x4.prototype.translate=function(t,e,i){this.m03+=t,this.m13+=e,this.m23+=i},JSC3D.Matrix3x4.prototype.rotateAboutXAxis=function(t){if(0!=t){t*=Math.PI/180
var e=Math.cos(t),i=Math.sin(t),r=e*this.m10-i*this.m20,s=e*this.m11-i*this.m21,a=e*this.m12-i*this.m22,o=e*this.m13-i*this.m23,n=e*this.m20+i*this.m10,h=e*this.m21+i*this.m11,l=e*this.m22+i*this.m12,f=e*this.m23+i*this.m13
this.m10=r,this.m11=s,this.m12=a,this.m13=o,this.m20=n,this.m21=h,this.m22=l,this.m23=f}},JSC3D.Matrix3x4.prototype.rotateAboutYAxis=function(t){if(0!=t){t*=Math.PI/180
var e=Math.cos(t),i=Math.sin(t),r=e*this.m00+i*this.m20,s=e*this.m01+i*this.m21,a=e*this.m02+i*this.m22,o=e*this.m03+i*this.m23,n=e*this.m20-i*this.m00,h=e*this.m21-i*this.m01,l=e*this.m22-i*this.m02,f=e*this.m23-i*this.m03
this.m00=r,this.m01=s,this.m02=a,this.m03=o,this.m20=n,this.m21=h,this.m22=l,this.m23=f}},JSC3D.Matrix3x4.prototype.rotateAboutZAxis=function(t){if(0!=t){t*=Math.PI/180
var e=Math.cos(t),i=Math.sin(t),r=e*this.m10+i*this.m00,s=e*this.m11+i*this.m01,a=e*this.m12+i*this.m02,o=e*this.m13+i*this.m03,n=e*this.m00-i*this.m10,h=e*this.m01-i*this.m11,l=e*this.m02-i*this.m12,f=e*this.m03-i*this.m13
this.m00=n,this.m01=h,this.m02=l,this.m03=f,this.m10=r,this.m11=s,this.m12=a,this.m13=o}},JSC3D.Matrix3x4.prototype.multiply=function(t){var e=t.m00*this.m00+t.m01*this.m10+t.m02*this.m20,i=t.m00*this.m01+t.m01*this.m11+t.m02*this.m21,r=t.m00*this.m02+t.m01*this.m12+t.m02*this.m22,s=t.m00*this.m03+t.m01*this.m13+t.m02*this.m23+t.m03,a=t.m10*this.m00+t.m11*this.m10+t.m12*this.m20,o=t.m10*this.m01+t.m11*this.m11+t.m12*this.m21,n=t.m10*this.m02+t.m11*this.m12+t.m12*this.m22,h=t.m10*this.m03+t.m11*this.m13+t.m12*this.m23+t.m13,l=t.m20*this.m00+t.m21*this.m10+t.m22*this.m20,f=t.m20*this.m01+t.m21*this.m11+t.m22*this.m21,u=t.m20*this.m02+t.m21*this.m12+t.m22*this.m22,m=t.m20*this.m03+t.m21*this.m13+t.m22*this.m23+t.m23
this.m00=e,this.m01=i,this.m02=r,this.m03=s,this.m10=a,this.m11=o,this.m12=n,this.m13=h,this.m20=l,this.m21=f,this.m22=u,this.m23=m},JSC3D.Matrix3x4.prototype.copy=function(t){var e=t.m00,i=t.m01,r=t.m02,s=t.m03,a=t.m10,o=t.m11,n=t.m12,h=t.m13,l=t.m20,f=t.m21,u=t.m22,m=t.m23
this.m00=e,this.m01=i,this.m02=r,this.m03=s,this.m10=a,this.m11=o,this.m12=n,this.m13=h,this.m20=l,this.m21=f,this.m22=u,this.m23=m},JSC3D.Math3D={transformVectors:function(t,e,i){for(var r,s,a,o=0;o<e.length;o+=3)r=e[o],s=e[o+1],a=e[o+2],i[o]=t.m00*r+t.m01*s+t.m02*a+t.m03,i[o+1]=t.m10*r+t.m11*s+t.m12*a+t.m13,i[o+2]=t.m20*r+t.m21*s+t.m22*a+t.m23},transformVectorZs:function(t,e,i){for(var r,s,a,o=e.length/3,n=0,h=0;o>n;)r=e[h],s=e[h+1],a=e[h+2],i[n]=t.m20*r+t.m21*s+t.m22*a+t.m23,n++,h+=3},normalizeVectors:function(t,e){for(var i,r,s,a,o=t.length,n=0;o>n;n+=3)i=t[n],r=t[n+1],s=t[n+2],a=Math.sqrt(i*i+r*r+s*s),a>0&&(a=1/a,i*=a,r*=a,s*=a),e[n]=i,e[n+1]=r,e[n+2]=s}},JSC3D.LoaderSelector={registerLoader:function(t,e){"function"==typeof e&&(JSC3D.LoaderSelector.loaderTable[t]=e)},getLoader:function(t){var e=JSC3D.LoaderSelector.loaderTable[t.toLowerCase()]
if(!e)return null
var i
try{i=new e}catch(r){i=null}return i},loaderTable:{}},JSC3D.Util={ieXHRResponseBodyToString:function(t){for(var e=new VBArray(t).toArray(),i="",r=0;r<e.length-65536;r+=65536)i+=String.fromCharCode.apply(null,e.slice(r,r+65536))
return i+String.fromCharCode.apply(null,e.slice(r))},debounce:function(t,e){var i,r,s,a
return function(){s=this,r=[].slice.call(arguments,0),a=new Date
var o=function(){var n=new Date-a
e>n?i=setTimeout(o,e-n):(i=null,t.apply(s,r))}
i||(i=setTimeout(o,e))}}},JSC3D.PlatformInfo=function(){for(var t,e=({browser:"other",version:"n/a",profile:"default",isTouchDevice:void 0!=document.createTouch,isTouchCapable:"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch||navigator.maxTouchPoints>0||window.navigator.msMaxTouchPoints>0,supportTypedArrays:void 0!=window.Uint32Array,supportWebGL:void 0!=window.WebGLRenderingContext}),i=[["firefox",/Firefox[\/\s](\d+(?:\.\d+)*)/],["chrome",/Chrome[\/\s](\d+(?:\.\d+)*)/],["opera",/Opera[\/\s](\d+(?:\.\d+)*)/],["safari",/Safari[\/\s](\d+(?:\.\d+)*)/],["webkit",/AppleWebKit[\/\s](\d+(?:\.\d+)*)/],["ie",/MSIE[\/\s](\d+(?:\.\d+)*)/],["ie",/Trident\/\d+\.\d+;\s.*rv:(\d+(?:\.\d+)*)/]],r=0;r<i.length;r++)if(t=i[r][1].exec(window.navigator.userAgent)){e.browser=i[r][0],e.version=t[1]
break}for(var s=0,a=new Date,o=200;(new Date).getTime()-a<o;){for(var n=[],h=-180;180>h;h++)n.push(Math.cos(h*Math.PI/180))
n=null,s++}return s/=o,3>s&&(e.profile="low"),s>30&&(e.profile="high"),e}()