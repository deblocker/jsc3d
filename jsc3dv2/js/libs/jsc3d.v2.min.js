var JSC3D=JSC3D||{}
JSC3D.Viewer=function(t,e){e?this.params={SceneUrl:e.SceneUrl||"",InitRotationX:e.InitRotationX||0,InitRotationY:e.InitRotationY||0,InitRotationZ:e.InitRotationZ||0,SceneRotation:e.SceneRotation||"off",InitSceneRotation:e.InitSceneRotation||0,ModelColor:e.ModelColor||"#caa618",BackgroundColor1:e.BackgroundColor1||"#ffffff",BackgroundColor2:e.BackgroundColor2||"#383840",BackgroundImageUrl:e.BackgroundImageUrl||"",Background:e.Background||"on",RenderMode:e.RenderMode||"flat",Definition:e.Definition||"standard",FaceCulling:e.FaceCulling||"on",MipMapping:e.MipMapping||"off",CreaseAngle:e.CreaseAngle||-180,SphereMapUrl:e.SphereMapUrl||"",ProgressBar:e.ProgressBar||"on",Renderer:e.Renderer||"",AutoUpdate:e.AutoUpdate||"off",AutoRotateSpeed:e.AutoRotateSpeed||0,LightingMode:e.LightingMode||"standard",LocalBuffers:e.LocalBuffers||"retain"}:this.params={SceneUrl:"",InitRotationX:0,InitRotationY:0,InitRotationZ:0,InitSceneRotation:0,SceneRotation:"off",ModelColor:"#caa618",BackgroundColor1:"#ffffff",BackgroundColor2:"#383840",BackgroundImageUrl:"",Background:"on",RenderMode:"flat",Definition:"standard",FaceCulling:"on",MipMapping:"off",CreaseAngle:-180,SphereMapUrl:"",ProgressBar:"on",Renderer:"",AutoUpdate:"off",AutoRotateSpeed:0,LightingMode:"standard",LocalBuffers:"retain"},this.canvas=t,this.ctx2d=null,this.canvasData=null,this.bkgColorBuffer=null,this.colorBuffer=null,this.zBuffer=null,this.selectionBuffer=null,this.frameWidth=null,this.frameHeight=null,this.scene=null,this.textures=[],this.materials=[],this.defaultMaterial=null,this.sphereMap=null,this.isLoaded=!1,this.isFailed=!1,this.abortUnfinishedLoadingFn=null,this.needUpdate=!1,this.needRepaint=!1,this.initRotX=0,this.initRotY=0,this.initRotZ=0,this.initSceneRotation=0,this.sceneRotation=0,this.isSceneRotationEnabled=!1,this.zoomFactor=1,this.panning=[0,0],this.rotation=[0,0,0],this.fps=0,this.frameNumber=0,this.rotMatrix=new JSC3D.Matrix3x4,this.transformMatrix=new JSC3D.Matrix3x4,this.sceneUrl="",this.modelColor=13280792,this.bkgColor1=16777215,this.bkgColor2=3684416,this.bkgImageUrl="",this.bkgImage=null,this.isBackgroundOn=!0,this.renderMode="flat",this.definition="standard",this.isCullingDisabled=!1,this.isMipMappingOn=!1,this.creaseAngle=-180,this.sphereMapUrl="",this.isAutoUpdateOn=!1,this.autoRotateSpeed=0,this.lightingMode="standard",this.showLights=!1,this.showProgressBar=!0,this.buttonStates={},this.keyStates={},this.mouseX=0,this.mouseY=0,this.mouseDownX=-1,this.mouseDownY=-1,this.isTouchHeld=!1,this.baseZoomFactor=1,this.suppressDraggingRotation=!1,this.onloadingstarted=null,this.onloadingcomplete=null,this.onloadingprogress=null,this.onloadingaborted=null,this.onloadingerror=null,this.onmousedown=null,this.onmouseup=null,this.onmousemove=null,this.onmousewheel=null,this.onmouseclick=null,this.beforeupdate=null,this.afterupdate=null,this.onscenerotation=null,this.ontick=null,this.mouseUsage="default",this.isDefaultInputHandlerEnabled=!0,this.progressFrame=null,this.progressRectangle=null,this.messagePanel=null,this.webglBackend=null
var i=this
JSC3D.PlatformInfo.isTouchDevice?JSC3D.Hammer?JSC3D.Hammer(this.canvas).on("touch release hold drag pinch transformend",function(t){i.gestureHandler(t)}):(this.canvas.addEventListener("touchstart",function(t){i.touchStartHandler(t)},!1),this.canvas.addEventListener("touchend",function(t){i.touchEndHandler(t)},!1),this.canvas.addEventListener("touchmove",function(t){i.touchMoveHandler(t)},!1),this.canvas.addEventListener("touchcancel",function(t){i.touchCancelHandler(t)},!1),this.canvas.addEventListener("touchleave",function(t){i.touchCancelHandler(t)},!1)):(this.canvas.addEventListener("mousedown",function(t){i.mouseDownHandler(t)},!1),this.canvas.addEventListener("mouseup",function(t){i.mouseUpHandler(t)},!1),this.canvas.addEventListener("mousemove",function(t){i.mouseMoveHandler(t)},!1),document.addEventListener("keydown",function(t){i.keyDownHandler(t)},!1),document.addEventListener("keyup",function(t){i.keyUpHandler(t)},!1)),this.canvas.addEventListener("onwheel"in document?"wheel":"onmousewheel"in document?"mousewheel":"DOMMouseScroll",function(t){i.mouseWheelHandler(t)})},JSC3D.Viewer.prototype.setParameter=function(t,e){this.params[t]=e},JSC3D.Viewer.prototype.setParameters=function(t){for(var e in t){var i=t[e]
this.params[e]=i}},JSC3D.Viewer.prototype.init=function(){this.sceneUrl=this.params.SceneUrl,this.initRotX=parseFloat(this.params.InitRotationX),this.initRotY=parseFloat(this.params.InitRotationY),this.initRotZ=parseFloat(this.params.InitRotationZ),this.modelColor=parseInt("0x"+this.params.ModelColor.substring(1)),this.bkgColor1=parseInt("0x"+this.params.BackgroundColor1.substring(1)),this.bkgColor2=parseInt("0x"+this.params.BackgroundColor2.substring(1)),this.bkgImageUrl=this.params.BackgroundImageUrl,this.isBackgroundOn="on"==this.params.Background.toLowerCase(),this.renderMode=this.params.RenderMode.toLowerCase(),this.definition=this.params.Definition.toLowerCase(),this.isCullingDisabled="off"==this.params.FaceCulling.toLowerCase(),this.creaseAngle=parseFloat(this.params.CreaseAngle),this.isMipMappingOn="on"==this.params.MipMapping.toLowerCase(),this.sphereMapUrl=this.params.SphereMapUrl,this.showProgressBar="on"==this.params.ProgressBar.toLowerCase(),this.useWebGL="webgl"==this.params.Renderer.toLowerCase(),this.isAutoUpdateOn="on"==this.params.AutoUpdate.toLowerCase(),this.autoRotateSpeed=parseFloat(this.params.AutoRotateSpeed),this.releaseLocalBuffers="release"==this.params.LocalBuffers.toLowerCase(),this.isSceneRotationEnabled="on"==this.params.SceneRotation.toLowerCase(),this.initSceneRotation=parseFloat(this.params.InitSceneRotation),this.lightingMode=this.params.LightingMode.toLowerCase(),"default"==this.definition&&(this.definition=JSC3D.PlatformInfo.profile)
var t=this.getInnerSize()
if(this.canvas.width=t[0],this.canvas.height=t[1],this.useWebGL&&JSC3D.PlatformInfo.supportWebGL&&JSC3D.WebGLRenderBackend)try{this.webglBackend=new JSC3D.WebGLRenderBackend(this.canvas,this.releaseLocalBuffers),this.webglBackend.isLightingOn="standard"!=this.lightingMode}catch(e){}if(JSC3D.console&&JSC3D.console.logInfo("viewer.useWebGL: "+this.useWebGL),JSC3D.console&&JSC3D.console.logInfo("PlatformInfo.supportWebGL: "+JSC3D.PlatformInfo.supportWebGL),!this.webglBackend){this.useWebGL&&JSC3D.console&&JSC3D.console.logWarning("WebGL is not available. Software rendering is enabled instead.")
try{this.ctx2d=this.canvas.getContext("2d"),this.canvasData=this.ctx2d.getImageData(0,0,this.canvas.width,this.canvas.height)}catch(e){this.ctx2d=null,this.canvasData=null}}switch((this.canvas.width<=2||this.canvas.height<=2)&&(this.definition="standard"),this.definition){case"low":this.frameWidth=~~((this.canvas.width+1)/2),this.frameHeight=~~((this.canvas.height+1)/2)
break
case"high":this.frameWidth=2*this.canvas.width,this.frameHeight=2*this.canvas.height
break
case"standard":default:this.frameWidth=this.canvas.width,this.frameHeight=this.canvas.height}this.zoomFactor=1,this.panning=[0,0],this.rotation=[0,0,0],this.rotMatrix.identity(),this.transformMatrix.identity(),this.isLoaded=!1,this.isFailed=!1,this.needUpdate=!1,this.needRepaint=!1,this.scene=null,this.defaultMaterial=new JSC3D.Material("default",void 0,this.modelColor),this.webglBackend||(this.colorBuffer=new Array(this.frameWidth*this.frameHeight),this.zBuffer=new Array(this.frameWidth*this.frameHeight),this.selectionBuffer=new Array(this.frameWidth*this.frameHeight),this.bkgColorBuffer=new Array(this.frameWidth*this.frameHeight)),this.generateBackground(),this.drawBackground(),this.isAutoUpdateOn||0==this.autoRotateSpeed||JSC3D.console&&JSC3D.console.logWarning("AutoRotate need to have AutoUpdate switched on!"),this.webglBackend||(this.lightingMode="standard")
var i=this,r=1*new Date
!function a(){var t=1e3/30,e=window.performance&&window.performance.now?window.performance.now():Date.now()
i.frameTargetTime&&e<i.frameTargetTime&&(e=i.frameTargetTime+.01)
var s=t-e%t
i.frameTargetTime=e+s
var o=1e3/(e-r)
e!=r&&(i.fps+=(o-i.fps)/30,r=e),(i.ctx2d||i.webglBackend)&&(i.frameNumber++,i.doUpdate(),null!=i.ontick&&"function"==typeof i.ontick&&i.ontick()),i.isAutoUpdateOn&&setTimeout(a,s)}(),this.setBackgroudImageFromUrl(this.bkgImageUrl),this.loadScene(),this.setSphereMapFromUrl(this.sphereMapUrl)},JSC3D.Viewer.prototype.update=function(t){this.isFailed||(t?this.needRepaint=!0:this.needUpdate=!0,this.isAutoUpdateOn||(this.needUpdate=!0,this.doUpdate()))},JSC3D.Viewer.prototype.createScene=function(t,e,i,r,a,s){this.abortUnfinishedLoadingFn&&this.abortUnfinishedLoadingFn(),this.scene=null,this.isLoaded=!1,this.update()
var o=new JSC3D.Scene
o.aabb=new JSC3D.AABB,o.aabb.minX=t,o.aabb.maxX=e,o.aabb.minY=i,o.aabb.maxY=r,o.aabb.minZ=a,o.aabb.maxZ=s,this.replaceScene(o)},JSC3D.Viewer.prototype.getInnerSize=function(){var t=window.getComputedStyle(this.canvas),e=parseInt(t.paddingLeft)+parseInt(t.paddingRight),i=parseInt(t.paddingTop)+parseInt(t.paddingBottom)
return[this.canvas.clientWidth-e,this.canvas.clientHeight-i]},JSC3D.Viewer.prototype.rotate=function(t,e,i){this.rotateAboutXAxis(t),this.rotateAboutYAxis(e),this.rotateAboutZAxis(i)},JSC3D.Viewer.prototype.calcRotation=function(){var t=this.rotMatrix,e=180/Math.PI,i=Math.atan2(-t.m12,t.m22),r=Math.sqrt(t.m00*t.m00+t.m01*t.m01),a=Math.atan2(t.m02,r),s=Math.sin(i),o=Math.cos(i),n=Math.atan2(-s*t.m20+o*t.m10,o*t.m11+s*t.m21),h=i*e,l=a*e,f=n*e
this.rotation[0]=h,this.rotation[1]=l,this.rotation[2]=f},JSC3D.Viewer.prototype.rotateAboutXAxis=function(t){t&&(t%=360,this.rotMatrix.rotateAboutXAxis(t))},JSC3D.Viewer.prototype.rotateAboutYAxis=function(t){t&&(t%=360,this.rotMatrix.rotateAboutYAxis(t))},JSC3D.Viewer.prototype.rotateAboutZAxis=function(t){t&&(t%=360,this.rotMatrix.rotateAboutZAxis(t))},JSC3D.Viewer.prototype.rotateScene=function(t){if(t){t%=360
var e=this.initRotX,i=this.initRotZ
this.rotMatrix.rotateAboutXAxis(-e),this.rotMatrix.rotateAboutZAxis(-i),this.rotMatrix.rotateAboutYAxis(t),this.rotMatrix.rotateAboutZAxis(i),this.rotMatrix.rotateAboutXAxis(e)}switch(this.sceneRotation+=t,!0){case this.sceneRotation>=180:this.sceneRotation-=360
break
case this.sceneRotation<=-180:this.sceneRotation+=360}if(this.calcRotation(),null!=this.onscenerotation&&"function"==typeof this.onscenerotation){var r=this
r.onscenerotation(r.sceneRotation)}},JSC3D.Viewer.prototype.autoRotateScene=function(){0!=this.autoRotateSpeed&&(this.rotateScene(this.autoRotateSpeed),this.needUpdate=!0)},JSC3D.Viewer.prototype.setRenderMode=function(t){this.params.RenderMode=t,this.renderMode=t},JSC3D.Viewer.prototype.setDefinition=function(t){if((this.canvas.width<=2||this.canvas.height<=2)&&(t="standard"),t!=this.definition){this.params.Definition=t,this.definition=t
var e=this.frameWidth
switch(this.definition){case"low":this.frameWidth=~~((this.canvas.width+1)/2),this.frameHeight=~~((this.canvas.height+1)/2)
break
case"high":this.frameWidth=2*this.canvas.width,this.frameHeight=2*this.canvas.height
break
case"standard":default:this.frameWidth=this.canvas.width,this.frameHeight=this.canvas.height}var i=this.frameWidth/e
if(this.zoomFactor*=i,this.panning[0]*=i,this.panning[1]*=i,!this.webglBackend){var r=this.frameWidth*this.frameHeight
this.colorBuffer.length<r&&(this.colorBuffer=new Array(r)),this.zBuffer.length<r&&(this.zBuffer=new Array(r)),this.selectionBuffer.length<r&&(this.selectionBuffer=new Array(r)),this.bkgColorBuffer.length<r&&(this.bkgColorBuffer=new Array(r)),this.generateBackground()}}},JSC3D.Viewer.prototype.setBackgroudImageFromUrl=function(t){if(this.params.BackgroundImageUrl=t,this.bkgImageUrl=t,""==t)return void(this.bkgImage=null)
var e=this,i=new Image
i.onload=function(){e.bkgImage=this,e.generateBackground()},i.crossOrigin="anonymous",i.src=encodeURI(t)},JSC3D.Viewer.prototype.setSphereMapFromUrl=function(t){if(this.params.SphereMapUrl=t,this.sphereMapUrl=t,""==t)return void(this.sphereMap=null)
var e=this,i=new JSC3D.Texture
i.onready=function(){e.sphereMap=i,e.update()},i.createFromUrl(this.sphereMapUrl)},JSC3D.Viewer.prototype.addTexture=function(t){var e=t.replace(/^.*(\\|\/|\:)/,""),i=e.substr(0,e.lastIndexOf("."))||e+"",r=new JSC3D.Texture(i)
r.createFromUrl(t),this.textures.push(r)},JSC3D.Viewer.prototype.getTexture=function(t){for(var e=0,i=this.textures.length;i>e;e++){var r=this.textures[e]
if(r.name==t)return r}return null},JSC3D.Viewer.prototype.addMaterial=function(t,e,i,r,a,s,o,n,h,l,f){var u=new JSC3D.Material(t,e,i,r,a,s,o,n,h,l,f)
this.materials.push(u)},JSC3D.Viewer.prototype.getMaterial=function(t){for(var e=0,i=this.materials.length;i>e;e++){var r=this.materials[e]
if(r.name==t)return r}return null},JSC3D.Viewer.prototype.enableDefaultInputHandler=function(t){this.isDefaultInputHandlerEnabled=t},JSC3D.Viewer.prototype.enableSceneRotation=function(t){this.isSceneRotationEnabled=t},JSC3D.Viewer.prototype.setMouseUsage=function(t){this.mouseUsage=t},JSC3D.Viewer.prototype.isWebGLEnabled=function(){return null!=this.webglBackend},JSC3D.Viewer.prototype.replaceSceneFromUrl=function(t){this.params.SceneUrl=t,this.sceneUrl=t,this.isFailed=this.isLoaded=!1,this.loadScene()},JSC3D.Viewer.prototype.replaceScene=function(t){this.params.SceneUrl="",this.sceneUrl="",this.isFailed=!1,this.isLoaded=!0,this.setupScene(t)},JSC3D.Viewer.prototype.resetScene=function(){var t=!this.scene||this.scene.isEmpty()?0:this.scene.aabb.lengthOfDiagonal()
this.zoomFactor=0==t?1:(this.frameWidth<this.frameHeight?this.frameWidth:this.frameHeight)/t,this.panning=[0,0],this.currentMesh=null,this.rotMatrix.identity(),this.scene.isLightingOn="standard"!=this.lightingMode,this.setup3PointLighting(this.lightingMode,this.showLights),this.sceneRotation=0,this.rotateAboutXAxis(this.initRotX),this.rotateAboutYAxis(this.initRotY),this.rotateAboutZAxis(this.initRotZ),this.rotateScene(this.initSceneRotation)},JSC3D.Viewer.prototype.getScene=function(){return this.scene},JSC3D.Viewer.prototype.pick=function(t,e){var i=new JSC3D.PickInfo,r=this.canvas.getBoundingClientRect(),a=t-r.left,s=e-r.top
i.canvasX=a,i.canvasY=s
var o=0
if(this.webglBackend)o=this.webglBackend.pick(a,s)
else{var n=a,h=s
if(null!=this.selectionBuffer&&a>=0&&a<this.canvas.width&&s>=0&&s<this.canvas.height){switch(this.definition){case"low":n=~~(n/2),h=~~(h/2)
break
case"high":n*=2,h*=2
break
case"standard":}o=this.selectionBuffer[h*this.frameWidth+n],o>0&&(i.depth=this.zBuffer[h*this.frameWidth+n])}}if(o>0)for(var l=this.scene.getChildren(),f=0;f<l.length;f++)if(l[f].internalId==o){i.mesh=l[f]
break}return i},JSC3D.Viewer.prototype.doUpdate=function(){this.autoRotateScene(),(this.needUpdate||this.needRepaint)&&(null!=this.beforeupdate&&"function"==typeof this.beforeupdate&&this.beforeupdate(),this.scene?(this.needUpdate&&(this.beginScene(),this.render(),this.endScene()),this.paint()):this.drawBackground(),this.needRepaint=!1,this.needUpdate=!1,null!=this.afterupdate&&"function"==typeof this.afterupdate&&this.afterupdate())},JSC3D.Viewer.prototype.paint=function(){!this.webglBackend&&this.ctx2d&&this.ctx2d.putImageData(this.canvasData,0,0)},JSC3D.Viewer.prototype.mouseDownHandler=function(t){if(this.isLoaded){if(this.onmousedown){var e=this.pick(t.clientX,t.clientY)
this.scene.currentMesh=e.mesh
var i=e.mesh?e.mesh.getGroupName():null
this.onmousedown(e.canvasX,e.canvasY,t.button,e.depth,e.mesh)}t.preventDefault(),t.stopPropagation(),this.isDefaultInputHandlerEnabled&&(this.buttonStates[t.button]=!0,this.mouseX=t.clientX,this.mouseY=t.clientY,this.mouseDownX=t.clientX,this.mouseDownY=t.clientY)}},JSC3D.Viewer.prototype.mouseUpHandler=function(t){if(this.isLoaded){var e;(this.onmouseup||this.onmouseclick)&&(e=this.pick(t.clientX,t.clientY)),this.onmouseup&&this.onmouseup(e.canvasX,e.canvasY,t.button,e.depth,e.mesh),this.onmouseclick&&this.mouseDownX==t.clientX&&this.mouseDownY==t.clientY&&(this.onmouseclick(e.canvasX,e.canvasY,t.button,e.depth,e.mesh),this.mouseDownX=-1,this.mouseDownY=-1),t.preventDefault(),t.stopPropagation(),this.isTouchHeld=!1,this.suppressDraggingRotation=!1,this.isDefaultInputHandlerEnabled&&(this.buttonStates[t.button]=!1)}},JSC3D.Viewer.prototype.mouseClickHandler=function(t){if(this.isLoaded){var e
this.onmouseclick&&this.mouseDownX==t.clientX&&this.mouseDownY==t.clientY&&(e=this.pick(t.clientX,t.clientY),this.onmouseclick(e.canvasX,e.canvasY,t.button,e.depth,e.mesh),this.mouseDownX=-1,this.mouseDownY=-1),t.preventDefault(),t.stopPropagation(),this.isTouchHeld=!1,this.suppressDraggingRotation=!1,this.isDefaultInputHandlerEnabled&&(this.buttonStates[t.button]=!1)}},JSC3D.Viewer.prototype.mouseMoveHandler=function(t){if(this.isLoaded){if(this.onmousemove){var e=this.pick(t.clientX,t.clientY)
this.onmousemove(e.canvasX,e.canvasY,t.button,e.depth,e.mesh)}if(t.preventDefault(),t.stopPropagation(),this.isDefaultInputHandlerEnabled){var i=1==this.buttonStates[0],r=1==this.keyStates[16],a=1==this.keyStates[17]
if(i){if(r&&"default"==this.mouseUsage||"zoom"==this.mouseUsage)this.zoomFactor*=this.mouseY<=t.clientY?1.04:.96
else if(a&&"default"==this.mouseUsage||"pan"==this.mouseUsage){var s="low"==this.definition?.5:"high"==this.definition?2:1
this.panning[0]+=s*(t.clientX-this.mouseX),this.panning[1]+=s*(t.clientY-this.mouseY)}else if("default"==this.mouseUsage||"rotate"==this.mouseUsage){var o=360*(t.clientY-this.mouseY)/this.canvas.width,n=360*(t.clientX-this.mouseX)/this.canvas.height
this.isSceneRotationEnabled?this.rotateScene(n):(this.rotateAboutXAxis(o),this.rotateAboutYAxis(n))}this.mouseX=t.clientX,this.mouseY=t.clientY,this.mouseDownX=-1,this.mouseDownY=-1,this.update()}}}},JSC3D.Viewer.prototype.mouseWheelHandler=function(t){if(this.isLoaded){if(this.onmousewheel){var e=this.pick(t.clientX,t.clientY)
this.onmousewheel(e.canvasX,e.canvasY,t.button,e.depth,e.mesh)}t.preventDefault(),t.stopPropagation(),this.isDefaultInputHandlerEnabled&&(this.mouseDownX=-1,this.mouseDownY=-1,this.zoomFactor*=(t.wheelDelta?t.wheelDelta:t.deltaY?-t.deltaY:-t.detail)<0?1.1:.91,this.update())}},JSC3D.Viewer.prototype.touchStartHandler=function(t){if(this.isLoaded&&t.touches.length>0){var e=t.touches[0].clientX,i=t.touches[0].clientY
if(this.onmousedown){var r=this.pick(e,i)
this.scene.currentMesh=r.mesh
var a=r.mesh?r.mesh.getGroupName():null
this.onmousedown(r.canvasX,r.canvasY,0,r.depth,r.mesh)}if(t.preventDefault(),t.stopPropagation(),!this.isDefaultInputHandlerEnabled)return
this.buttonStates[0]=!0,this.mouseX=e,this.mouseY=i,this.mouseDownX=e,this.mouseDownY=i}},JSC3D.Viewer.prototype.touchEndHandler=function(t){if(this.isLoaded){var e;(this.onmouseup||this.onmouseclick)&&(e=this.pick(this.mouseX,this.mouseY)),this.onmouseup&&this.onmouseup(e.canvasX,e.canvasY,0,e.depth,e.mesh),this.onmouseclick&&this.mouseDownX==t.touches[0].clientX&&this.mouseDownY==t.touches[0].clientY&&(this.onmouseclick(e.canvasX,e.canvasY,0,e.depth,e.mesh),this.mouseDownX=-1,this.mouseDownY=-1),t.preventDefault(),t.stopPropagation(),this.isDefaultInputHandlerEnabled&&(this.buttonStates[0]=!1)}},JSC3D.Viewer.prototype.touchMoveHandler=function(t){if(this.isLoaded&&t.touches.length>0){var e=t.touches[0].clientX,i=t.touches[0].clientY
if(this.onmousemove){var r=this.pick(e,i)
this.onmousemove(r.canvasX,r.canvasY,0,r.depth,r.mesh)}if(t.preventDefault(),t.stopPropagation(),!this.isDefaultInputHandlerEnabled)return
if("zoom"==this.mouseUsage)this.zoomFactor*=this.mouseY<=i?1.04:.96
else if("pan"==this.mouseUsage){var a="low"==this.definition?.5:"high"==this.definition?2:1
this.panning[0]+=a*(e-this.mouseX),this.panning[1]+=a*(i-this.mouseY)}else if("default"==this.mouseUsage||"rotate"==this.mouseUsage){var s=360*(i-this.mouseY)/this.canvas.width,o=360*(e-this.mouseX)/this.canvas.height
this.isSceneRotationEnabled?this.rotateScene(o):(this.rotateAboutXAxis(s),this.rotateAboutYAxis(o))}this.mouseX=e,this.mouseY=i,this.mouseDownX=-1,this.mouseDownY=-1,this.update()}},JSC3D.Viewer.prototype.touchCancelHandler=function(t){if(this.isLoaded&&t.touches.length>0){if(t.preventDefault(),t.stopPropagation(),!this.isDefaultInputHandlerEnabled)return
this.buttonStates[0]=!1,this.mouseDownX=-1,this.mouseDownY=-1,this.update()}},JSC3D.Viewer.prototype.keyDownHandler=function(t){this.isDefaultInputHandlerEnabled&&(this.keyStates[t.keyCode]=!0)},JSC3D.Viewer.prototype.keyUpHandler=function(t){this.isDefaultInputHandlerEnabled&&(this.keyStates[t.keyCode]=!1)},JSC3D.Viewer.prototype.gestureHandler=function(t){if(this.isLoaded){var e=t.gesture.center.pageX-document.body.scrollLeft,i=t.gesture.center.pageY-document.body.scrollTop,r=this.pick(e,i),a=r.mesh?r.mesh.getGroupName():null
switch(t.type){case"touch":this.onmousedown&&this.onmousedown(r.canvasX,r.canvasY,0,r.depth,r.mesh),this.baseZoomFactor=this.zoomFactor,this.mouseX=e,this.mouseY=i,this.mouseDownX=e,this.mouseDownY=i
break
case"release":this.onmouseup&&this.onmouseup(r.canvasX,r.canvasY,0,r.depth,r.mesh),this.onmouseclick&&this.mouseDownX==e&&this.mouseDownY==i&&this.onmouseclick(r.canvasX,r.canvasY,0,r.depth,r.mesh),this.mouseDownX=-1,this.mouseDownY=-1,this.isTouchHeld=!1
break
case"hold":this.isTouchHeld=!0,this.mouseDownX=-1,this.mouseDownY=-1
break
case"drag":if(this.onmousemove&&this.onmousemove(r.canvasX,r.canvasY,0,r.depth,r.mesh),!this.isDefaultInputHandlerEnabled)break
if(this.isTouchHeld){var s="low"==this.definition?.5:"high"==this.definition?2:1
this.panning[0]+=s*(e-this.mouseX),this.panning[1]+=s*(i-this.mouseY)}else if(!this.suppressDraggingRotation){var o=360*(i-this.mouseY)/this.canvas.width,n=360*(e-this.mouseX)/this.canvas.height
this.isSceneRotationEnabled?this.rotateScene(n):(this.rotateAboutXAxis(o),this.rotateAboutYAxis(n))}this.mouseX=e,this.mouseY=i,this.mouseDownX=-1,this.mouseDownY=-1,this.update()
break
case"pinch":if(this.onmousewheel&&this.onmousewheel(r.canvasX,r.canvasY,0,r.depth,r.mesh),!this.isDefaultInputHandlerEnabled)break
this.suppressDraggingRotation=!0,this.zoomFactor=this.baseZoomFactor*t.gesture.scale,this.mouseDownX=-1,this.mouseDownY=-1,this.update()
break
case"transformend":var h=this
setTimeout(function(){h.suppressDraggingRotation=!1},250)}t.gesture.preventDefault(),t.gesture.stopPropagation()}},JSC3D.Viewer.prototype.resize=function(){var t=this.getInnerSize(),e=t[0],i=t[1],r=this.frameWidth,a=this.frameHeight,s=0,o=0
switch(this.definition){case"low":s=~~((e+1)/2),o=~~((i+1)/2)
break
case"high":s=2*e,o=2*i
break
case"standard":default:s=e,o=i}if(s!=r||o!=a){JSC3D.console&&JSC3D.console.logInfo("Resize Canvas from :"+r+"x"+a+" to: "+s+"x"+o),this.canvas.width=e,this.canvas.height=i
var n=s/r
if(this.zoomFactor*=n,this.panning[0]*=n,this.panning[1]*=n,this.frameWidth=s,this.frameHeight=o,this.webglBackend)this.webglBackend.resizeFrame(e,i)
else if(this.ctx2d){this.canvasData=this.ctx2d.getImageData(0,0,this.canvas.width,this.canvas.height)
var h=s*o
this.colorBuffer.length<h&&(this.colorBuffer=new Array(h)),this.zBuffer.length<h&&(this.zBuffer=new Array(h)),this.selectionBuffer.length<h&&(this.selectionBuffer=new Array(h)),this.bkgColorBuffer.length<h&&(this.bkgColorBuffer=new Array(h))}this.isLoaded&&(this.generateBackground(),this.needUpdate=!0,this.doUpdate())}},JSC3D.Viewer.prototype.setup3PointLighting=function(t,e){var i="greyscale"==t,r=this.scene.aabb
this.scene.xformMat.identity(),this.scene.lights=[]
for(var a=[{position:[r.minX,.1*r.maxY,0],diffuse:i?4473924:16711680,enabled:!0},{position:[0,.5*r.maxY,r.maxZ],diffuse:i?6710886:65280,enabled:!0},{position:[r.maxX,r.maxY,r.minZ],diffuse:i?13355979:255,enabled:!0}],s=0,o=a.length;o>s;s++){var n=a[s].enabled&&e,h=a[s].enabled&&"standard"!=t
this.scene.addLight(a[s].position[0],a[s].position[1],a[s].position[2],a[s].ambient,a[s].diffuse,h,n)}},JSC3D.Viewer.prototype.rotateLights=function(){if(this.scene){var t=this.scene.getMeshes("light-1")[0]
t.rotate([0,1,0])
var e=t.aabb.center()
this.scene.lights[0].position=[e[0],e[1],e[2]],this.scene.lights[0].compiled=null
var t=this.scene.getMeshes("light-2")[0]
t.rotate([0,1,0])
var e=t.aabb.center()
this.scene.lights[1].position=[e[0],e[1],e[2]],this.scene.lights[1].compiled=null
var t=this.scene.getMeshes("light-3")[0]
t.rotate([0,0,1])
var e=t.aabb.center()
this.scene.lights[2].position=[e[0],e[1],e[2]],this.scene.lights[2].compiled=null,this.needUpdate=!0}},JSC3D.Viewer.prototype.loadScene=function(){if(this.abortUnfinishedLoadingFn&&this.abortUnfinishedLoadingFn(),this.scene=null,this.isLoaded=!1,this.update(),""==this.sceneUrl)return!1
var t=this.sceneUrl.indexOf("?"),e=-1==t?this.sceneUrl:this.sceneUrl.substring(0,t),i=e.lastIndexOf("/");-1==i&&(i=e.lastIndexOf("\\"))
var r=e.substring(i+1),a=r.lastIndexOf(".")
if(-1==a)return JSC3D.console&&JSC3D.console.logError("Cannot get file format for the lack of file extension."),!1
var s=r.substring(a+1),o=JSC3D.LoaderSelector.getLoader(s)
if(!o)return JSC3D.console&&JSC3D.console.logError('Unsupported file format: "'+s+'".'),!1
var n=this
return o.onload=function(t){n.abortUnfinishedLoadingFn=null,n.setupScene(t),n.onloadingcomplete&&"function"==typeof n.onloadingcomplete&&n.onloadingcomplete()},o.onerror=function(t){n.scene=null,n.isLoaded=!1,n.isFailed=!0,n.abortUnfinishedLoadingFn=null,n.update(),n.reportError(t),n.onloadingerror&&"function"==typeof n.onloadingerror&&n.onloadingerror(t)},o.onprogress=function(t,e){n.showProgressBar&&n.reportProgress(t,e),n.onloadingprogress&&"function"==typeof n.onloadingprogress&&n.onloadingprogress(t,e)},o.onresource=function(t){t instanceof JSC3D.Texture&&n.isMipMappingOn&&!t.hasMipmap()&&t.generateMipmaps(),n.update()},this.abortUnfinishedLoadingFn=function(){o.abort(),n.abortUnfinishedLoadingFn=null,n.hideProgress(),n.onloadingaborted&&"function"==typeof n.onloadingaborted&&n.onloadingaborted()},o.loadFromUrl(this.sceneUrl),this.onloadingstarted&&"function"==typeof this.onloadingstarted&&this.onloadingstarted(),!0},JSC3D.Viewer.prototype.setupScene=function(t){if(this.creaseAngle>=0){var e=this.creaseAngle
t.forEachChild(function(t){t.creaseAngle=e})}if(t.init(),t.aabb){var i=t.aabb.lengthOfDiagonal(),r=this.frameWidth,a=this.frameHeight
this.zoomFactor=0==i?1:(a>r?r:a)/i,this.panning=[0,0]}this.rotMatrix.identity(),this.sceneRotation=0,this.rotateAboutXAxis(this.initRotX),this.rotateAboutYAxis(this.initRotY),this.rotateAboutZAxis(this.initRotZ),this.rotateScene(this.initSceneRotation),this.scene=t,this.scene.rotMat.copy(this.rotMatrix),this.scene.isLightingOn="standard"!=this.lightingMode,this.setup3PointLighting(this.lightingMode,this.showLights),this.isLoaded=!0,this.isFailed=!1,this.needUpdate=!1,this.needRepaint=!1,this.update(),this.hideProgress(),this.hideError()},JSC3D.Viewer.prototype.reportProgress=function(t,e){if(!this.progressFrame){var i=this.canvas.getBoundingClientRect(),r=255-((16711680&this.bkgColor1)>>16),a=255-((65280&this.bkgColor1)>>8),s=255-(255&this.bkgColor1),o="rgb("+r+","+a+","+s+")",n=window.pageXOffset+i.left+40,h=window.pageYOffset+i.top+.38*i.height,l=i.width-2*(n-i.left),f=20
this.progressFrame=document.createElement("div"),this.progressFrame.style.position="absolute",this.progressFrame.style.left=n+"px",this.progressFrame.style.top=h+"px",this.progressFrame.style.width=l+"px",this.progressFrame.style.height=f+"px",this.progressFrame.style.border="1px solid "+o,this.progressFrame.style.pointerEvents="none",document.body.appendChild(this.progressFrame),this.progressRectangle=document.createElement("div"),this.progressRectangle.style.position="absolute",this.progressRectangle.style.left=n+3+"px",this.progressRectangle.style.top=h+3+"px",this.progressRectangle.style.width="0px",this.progressRectangle.style.height=f-4+"px",this.progressRectangle.style.background=o,this.progressRectangle.style.pointerEvents="none",document.body.appendChild(this.progressRectangle),this.messagePanel||(this.messagePanel=document.createElement("div"),this.messagePanel.style.position="absolute",this.messagePanel.style.left=n+"px",this.messagePanel.style.top=h-16+"px",this.messagePanel.style.width=l+"px",this.messagePanel.style.height="14px",this.messagePanel.style.font="bold 14px Courier New",this.messagePanel.style.color=o,this.messagePanel.style.pointerEvents="none",document.body.appendChild(this.messagePanel))}"block"!=this.progressFrame.style.display&&(this.progressFrame.style.display="block",this.progressRectangle.style.display="block"),t&&"block"!=this.messagePanel.style.display&&(this.messagePanel.style.display="block"),this.progressRectangle.style.width=(parseFloat(this.progressFrame.style.width)-4)*e+"px",this.messagePanel.innerHTML=t},JSC3D.Viewer.prototype.hideProgress=function(){this.progressFrame&&(this.messagePanel.style.display="none",this.progressFrame.style.display="none",this.progressRectangle.style.display="none")},JSC3D.Viewer.prototype.reportError=function(t){if(!this.messagePanel){var e=this.canvas.getBoundingClientRect(),i=255-((16711680&this.bkgColor1)>>16),r=255-((65280&this.bkgColor1)>>8),a=255-(255&this.bkgColor1),s="rgb("+i+","+r+","+a+")",o=window.pageXOffset+e.left+40,n=window.pageYOffset+e.top+.38*e.height,h=e.width-2*(o-e.left),l=14
this.messagePanel=document.createElement("div"),this.messagePanel.style.position="absolute",this.messagePanel.style.left=o+"px",this.messagePanel.style.top=n-16+"px",this.messagePanel.style.width=h+"px",this.messagePanel.style.height=l+"px",this.messagePanel.style.font="bold 14px Courier New",this.messagePanel.style.color=s,this.messagePanel.style.pointerEvents="none",document.body.appendChild(this.messagePanel)}"none"!=this.progressFrame.style.display&&(this.progressFrame.style.display="none",this.progressRectangle.style.display="none"),t&&"block"!=this.messagePanel.style.display&&(this.messagePanel.style.display="block"),this.messagePanel.innerHTML=t},JSC3D.Viewer.prototype.hideError=function(){this.messagePanel&&(this.messagePanel.style.display="none")},JSC3D.Viewer.prototype.generateBackground=function(){return this.webglBackend?void(this.bkgImage?this.webglBackend.setBackgroundImage(this.bkgImage):this.webglBackend.setBackgroundColors(this.bkgColor1,this.bkgColor2)):void(this.bkgImage?this.fillBackgroundWithImage():this.fillGradientBackground())},JSC3D.Viewer.prototype.fillGradientBackground=function(){for(var t=this.frameWidth,e=this.frameHeight,i=this.bkgColorBuffer,r=(16711680&this.bkgColor1)>>16,a=(65280&this.bkgColor1)>>8,s=255&this.bkgColor1,o=(16711680&this.bkgColor2)>>16,n=(65280&this.bkgColor2)>>8,h=255&this.bkgColor2,l=this.isBackgroundOn?4278190080:0,f=0,u=0;e>u;u++)for(var m=r+u*(o-r)/e&255,c=a+u*(n-a)/e&255,p=s+u*(h-s)/e&255,d=0;t>d;d++)i[f++]=l|m<<16|c<<8|p},JSC3D.Viewer.prototype.fillBackgroundWithImage=function(){var t=this.frameWidth,e=this.frameHeight
if(!(this.bkgImage.width<=0||this.bkgImage.height<=0)){var i=!1,r=JSC3D.Texture.cv
if(!r)try{r=document.createElement("canvas"),JSC3D.Texture.cv=r,i=!0}catch(a){return}(r.width!=t||r.height!=e)&&(r.width=t,r.height=e,i=!0)
var s=null
try{var o=r.getContext("2d")
i||o.clearRect(0,0,t,e),o.drawImage(this.bkgImage,0,0,t,e)
var n=o.getImageData(0,0,t,e)
s=n.data}catch(a){return}for(var h=this.bkgColorBuffer,l=t*e,f=this.isBackgroundOn?4278190080:0,u=0,m=0;l>u;u++,m+=4)h[u]=f|s[m]<<16|s[m+1]<<8|s[m+2]}},JSC3D.Viewer.prototype.drawBackground=function(){(this.webglBackend||this.ctx2d)&&(this.beginScene(),this.endScene(),this.paint())},JSC3D.Viewer.prototype.beginScene=function(){var t=this.frameWidth,e=this.frameHeight
if(this.webglBackend)return void this.webglBackend.beginFrame(this.definition,this.isBackgroundOn,t,e)
for(var i=this.colorBuffer,r=this.zBuffer,a=this.selectionBuffer,s=this.bkgColorBuffer,o=this.frameWidth*this.frameHeight,n=-(1/0),h=0;o>h;h++)i[h]=s[h],r[h]=n,a[h]=0},JSC3D.Viewer.prototype.endScene=function(){if(this.webglBackend)return void this.webglBackend.endFrame()
var t=this.canvasData.data,e=this.canvas.width,i=this.canvas.height,r=this.colorBuffer,a=this.frameWidth,s=this.frameHeight,o=a*s
switch(this.definition){case"low":for(var n=e>>1,h=a-n,l=0,f=0,u=0;i>u;u++){for(var m=0;e>m;m++){var c=r[l]
t[f]=(16711680&c)>>16,t[f+1]=(65280&c)>>8,t[f+2]=255&c,t[f+3]=c>>>24,l+=1&m,f+=4}l+=1&u?h:-n}break
case"high":for(var l=0,f=0,u=0;i>u;u++){for(var m=0;e>m;m++){var p=r[l],d=r[l+1],v=r[l+a],g=r[l+a+1]
t[f]=(16711680&p)+(16711680&d)+(16711680&v)+(16711680&g)>>18,t[f+1]=(65280&p)+(65280&d)+(65280&v)+(65280&g)>>10,t[f+2]=(255&p)+(255&d)+(255&v)+(255&g)>>2,t[f+3]=p>>>24,l+=2,f+=4}l+=a}break
case"standard":default:for(var l=0,f=0;o>l;l++,f+=4){var c=r[l]
t[f]=(16711680&c)>>16,t[f+1]=(65280&c)>>8,t[f+2]=255&c,t[f+3]=c>>>24}}},JSC3D.Viewer.prototype.render=function(){if(!this.scene.isEmpty()){var t=this.frameWidth,e=this.frameHeight,i=this.scene.aabb,r=i.lengthOfDiagonal()
this.webglBackend?(this.transformMatrix.identity(),this.transformMatrix.translate(-.5*(i.minX+i.maxX),-.5*(i.minY+i.maxY),-.5*(i.minZ+i.maxZ)),this.transformMatrix.multiply(this.rotMatrix),this.transformMatrix.scale(2*this.zoomFactor/t,2*this.zoomFactor/e,-2/r),this.transformMatrix.translate(2*this.panning[0]/t,-2*this.panning[1]/e,0)):(this.transformMatrix.identity(),this.transformMatrix.translate(-.5*(i.minX+i.maxX),-.5*(i.minY+i.maxY),-.5*(i.minZ+i.maxZ)),this.transformMatrix.multiply(this.rotMatrix),this.transformMatrix.scale(this.zoomFactor,-this.zoomFactor,this.zoomFactor),this.transformMatrix.translate(.5*t+this.panning[0],.5*e+this.panning[1],0)),this.webglBackend?(this.scene.xformMat.identity(),this.scene.xformMat.translate(-.5*(i.minX+i.maxX),-.5*(i.minY+i.maxY),-.5*(i.minZ+i.maxZ)),this.scene.xformMat.multiply(this.scene.rotMat),this.scene.xformMat.scale(2*this.zoomFactor/t,2*this.zoomFactor/e,-2/r),this.scene.xformMat.translate(2*this.panning[0]/t,-2*this.panning[1]/e,0)):(this.scene.xformMat.identity(),this.scene.xformMat.translate(-.5*(i.minX+i.maxX),-.5*(i.minY+i.maxY),-.5*(i.minZ+i.maxZ)),this.scene.xformMat.multiply(this.scene.rotMat),this.scene.xformMat.scale(this.zoomFactor,-this.zoomFactor,this.zoomFactor),this.scene.xformMat.translate(.5*t+this.panning[0],.5*e+this.panning[1],0))
for(var a=0,s=this.scene.lights.length;s>a;a++)JSC3D.Math3D.transformVectors(this.scene.xformMat,this.scene.lights[a].position,this.scene.lights[a].transformedPosition)
var o=this.sortScene(this.transformMatrix)
if(this.webglBackend)return void this.webglBackend.render(this.scene.getChildren(),this.scene.lights,this.scene.xformMat,this.scene.rotMat,this.transformMatrix,this.rotMatrix,this.renderMode,this.defaultMaterial,this.sphereMap,this.isCullingDisabled)
for(var a=0;a<o.length;a++){var n=o[a]
if(!n.isTrivial()&&(n.isPositionFixed?JSC3D.Math3D.transformVectors(this.scene.xformMat,n.vertexBuffer,n.transformedVertexBuffer):JSC3D.Math3D.transformVectors(this.transformMatrix,n.vertexBuffer,n.transformedVertexBuffer),n.visible))switch(n.renderMode||this.renderMode){case"point":this.renderPoint(n)
break
case"wireframe":this.renderWireframe(n)
break
case"flat":this.renderSolidFlat(n)
break
case"smooth":this.renderSolidSmooth(n)
break
case"texture":n.hasTexture()?this.renderSolidTexture(n):this.renderSolidFlat(n)
break
case"textureflat":n.hasTexture()?this.renderTextureFlat(n):this.renderSolidFlat(n)
break
case"texturesmooth":var h=n.material?n.material.isEnvironmentCast:!1,l=n.texture?n.texture.isEnvironmentCast:!1,f=h||l
f&&null!=this.sphereMap&&this.sphereMap.hasData()?this.renderSolidSphereMapped(n):n.hasTexture()?this.renderTextureSmooth(n):this.renderSolidSmooth(n)
break
default:this.renderSolidFlat(n)}}}},JSC3D.Viewer.prototype.sortScene=function(t){for(var e=[],i=this.scene.getChildren(),r=0;r<i.length;r++){var a=i[r]
if(!a.isTrivial()){e.push(a)
var s=a.aabb.center()
JSC3D.Math3D.transformVectors(t,s,s)
var o=a.material?a.material:this.defaultMaterial
a.sortKey={depth:s[2],isTransparnt:o.transparency>0||(a.hasTexture()?a.texture.hasTransparency:!1)}}}return e.sort(function(t,e){return!t.sortKey.isTransparnt&&e.sortKey.isTransparnt?-1:t.sortKey.isTransparnt&&!e.sortKey.isTransparnt?1:t.sortKey.isTransparnt?t.sortKey.depth-e.sortKey.depth:e.sortKey.depth-t.sortKey.depth}),e},JSC3D.Viewer.prototype.renderPoint=function(t){for(var e=this.frameWidth,i=this.frameHeight,r=e-1,a=i-1,s=t.transformedVertexBuffer,o=this.colorBuffer,n=this.zBuffer,h=this.selectionBuffer,l=s.length/3,f=t.internalId,u=4278190080|(t.material?t.material.diffuseColor:this.defaultMaterial.diffuseColor),m=0,c=0;l>m;m++,c+=3){var p=~~(s[c]+.5),d=~~(s[c+1]+.5),v=s[c+2]
if(p>=0&&r>p&&d>=0&&a>d){var g=d*e+p
v>n[g]&&(n[g]=v,o[g]=u,h[g]=f),g++,v>n[g]&&(n[g]=v,o[g]=u,h[g]=f),g+=r,v>n[g]&&(n[g]=v,o[g]=u,h[g]=f),g++,v>n[g]&&(n[g]=v,o[g]=u,h[g]=f)}}},JSC3D.Viewer.prototype.renderWireframe=function(t){var e=this.frameWidth,i=this.frameHeight,r=e-1,a=i-1,s=t.indexBuffer,o=t.transformedVertexBuffer,n=t.transformedFaceNormalZBuffer,h=this.colorBuffer,l=this.zBuffer,f=this.selectionBuffer,u=t.faceCount,m=t.internalId,c=4278190080|(t.material?t.material.diffuseColor:this.defaultMaterial.diffuseColor),p=t.isDoubleSided||this.isCullingDisabled;(!n||n.length<u)&&(t.transformedFaceNormalZBuffer=new Array(u),n=t.transformedFaceNormalZBuffer),t.isPositionFixed?n=t.faceNormalBuffer:JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.faceNormalBuffer,n)
for(var d=0,v=0;u>d;){var g=n[d++]
if(p&&(g=g>0?g:-g),0>g){do;while(-1!=s[v++])}else{var x,C,D
C=3*s[v++],D=3*s[v++],x=C
for(var S=!1;!S;){var y=~~(o[C]+.5),b=~~(o[C+1]+.5),w=o[C+2],B=~~(o[D]+.5),M=~~(o[D+1]+.5),J=o[D+2],A=B-y,V=M-b,k=J-w,Y,I,X,R
Math.abs(A)>Math.abs(V)?(Y=A,I=A>0?1:-1,X=0!=A?I*V/A:0,R=0!=A?I*k/A:0):(Y=V,X=V>0?1:-1,I=0!=V?X*A/V:0,R=0!=V?X*k/V:0)
var F=y,N=b,Z=w
0>Y&&(F=B,N=M,Z=J,Y=-Y,I=-I,X=-X,R=-R)
for(var L=0;Y>L;L++){if(F>=0&&r>F&&N>=0&&a>N){var U=~~N*e+~~F
Z>l[U]&&(l[U]=Z,h[U]=c,f[U]=m)}F+=I,N+=X,Z+=R}D==x?S=!0:(C=D,D=-1!=s[v]?3*s[v++]:x)}v++}}},JSC3D.Viewer.prototype.renderSolidFlat=function(t){var e=this.frameWidth,i=this.frameHeight,r=t.indexBuffer,a=t.transformedVertexBuffer,s=t.transformedFaceNormalZBuffer,o=this.colorBuffer,n=this.zBuffer,h=this.selectionBuffer,l=t.faceCount,f=t.internalId,u=t.material?t.material:this.defaultMaterial,m=u.getPalette(),c=0==u.transparency,p=~~(255*u.transparency),d=255-p,v=t.isDoubleSided||this.isCullingDisabled,g=0
if(1!=u.transparency){(!s||s.length<l)&&(t.transformedFaceNormalZBuffer=new Array(l),s=t.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.faceNormalBuffer,s)
for(var x=new Array(3),C=new Array(3),D=new Array(3),S=0,y=0;l>S;){var b=s[S++]
if(v&&(b=b>0?b:-b),0>b){do;while(-1!=r[y++])}else{var w=4278190080|m[~~(255*b)],B,M,J
B=3*r[y++],M=3*r[y++]
do{J=3*r[y++],x[0]=~~(a[B]+.5),C[0]=~~(a[B+1]+.5),D[0]=a[B+2],x[1]=~~(a[M]+.5),C[1]=~~(a[M+1]+.5),D[1]=a[M+2],x[2]=~~(a[J]+.5),C[2]=~~(a[J+1]+.5),D[2]=a[J+2]
var A=C[0]<C[1]?0:1
A=C[A]<C[2]?A:2
var V=C[0]>C[1]?0:1
V=C[V]>C[2]?V:2
var k=3-V-A
if(A!=V){var Y=x[V],I=D[V],X=C[V]-C[A]
X=0!=X?X:1
var R=(x[V]-x[A])/X,F=(D[V]-D[A])/X,N=x[V],Z=D[V],L=C[V]-C[k]
L=0!=L?L:1
var U=(x[V]-x[k])/L,T=(D[V]-D[k])/L,P=x[k],H=D[k],E=C[k]-C[A]
E=0!=E?E:1
for(var W=(x[k]-x[A])/E,z=(D[k]-D[A])/E,O=C[V]*e,G=C[V];G>C[A];G--){if(G>=0&&i>G){var K=~~Y,q=I,j,Q
if(G>C[k]?(j=~~N,Q=Z):(j=~~P,Q=H),K>j){var $
$=K,K=j,j=$,$=q,q=Q,Q=$}0>K&&(K=0),j>=e&&(j=e-1)
var _=K!=j?(Q-q)/(j-K):1,tt=O+K
if(c)for(var et=K,it=q;j>=et;et++,it+=_)it>n[tt]&&(n[tt]=it,o[tt]=w,h[tt]=f),tt++
else for(var et=K,it=q;j>et;et++,it+=_){if(it>n[tt]){var rt=w,at=o[tt],st=(16711680&at)*p+(16711680&rt)*d>>8,ot=(65280&at)*p+(65280&rt)*d>>8,nt=(255&at)*p+(255&rt)*d>>8,ht=4278190080&at|d<<24
o[tt]=ht|16711680&st|65280&ot|255&nt,h[tt]=f}tt++}}Y-=R,I-=F,G>C[k]?(N-=U,Z-=T):(P-=W,H-=z),O-=e}}M=J}while(-1!=r[y])
y++}}}},JSC3D.Viewer.prototype.renderSolidSmooth=function(t){var e=this.frameWidth,i=this.frameHeight,r=t.indexBuffer,a=t.transformedVertexBuffer,s=t.transformedVertexNormalZBuffer,o=t.vertexNormalIndexBuffer?t.vertexNormalIndexBuffer:t.indexBuffer,n=t.transformedFaceNormalZBuffer,h=this.colorBuffer,l=this.zBuffer,f=this.selectionBuffer,u=t.faceCount,m=a.length/3,c=t.internalId,p=t.material?t.material:this.defaultMaterial,d=p.getPalette(),v=0==p.transparency,g=~~(255*p.transparency),x=255-g,C=t.isDoubleSided||this.isCullingDisabled,D=0
if(1!=p.transparency){(!s||s.length<t.vertexNormalBuffer.length/3)&&(t.transformedVertexNormalZBuffer=new Array(t.vertexNormalBuffer.length/3),s=t.transformedVertexNormalZBuffer),(!n||n.length<u)&&(t.transformedFaceNormalZBuffer=new Array(u),n=t.transformedFaceNormalZBuffer),t.isPositionFixed?(s=t.vertexNormalBuffer,n=t.faceNormalBuffer):(JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.vertexNormalBuffer,s),JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.faceNormalBuffer,n))
for(var S=new Array(3),y=new Array(3),b=new Array(3),w=new Array(3),B=0,M=0;u>B;){var J=n[B++]
if(C&&(J=J>0?J:-J),0>J){do;while(-1!=r[M++])}else{var A,V,k,Y,I,X,R,F,N
A=r[M],Y=3*A,R=o[M],M++,V=r[M],I=3*V,F=o[M],M++
do{k=r[M],X=3*k,N=o[M],M++,S[0]=~~(a[Y]+.5),y[0]=~~(a[Y+1]+.5),b[0]=a[Y+2],S[1]=~~(a[I]+.5),y[1]=~~(a[I+1]+.5),b[1]=a[I+2],S[2]=~~(a[X]+.5),y[2]=~~(a[X+1]+.5),b[2]=a[X+2],w[0]=s[R],w[1]=s[F],w[2]=s[N],C&&(w[0]<0&&(w[0]=-w[0]),w[1]<0&&(w[1]=-w[1]),w[2]<0&&(w[2]=-w[2]))
var Z=y[0]<y[1]?0:1
Z=y[Z]<y[2]?Z:2
var L=y[0]>y[1]?0:1
L=y[L]>y[2]?L:2
var U=3-L-Z
if(Z!=L){var T=S[L],P=b[L],H=255*w[L],E=y[L]-y[Z]
E=0!=E?E:1
var W=(S[L]-S[Z])/E,z=(b[L]-b[Z])/E,O=255*(w[L]-w[Z])/E,G=S[L],K=b[L],q=255*w[L],j=y[L]-y[U]
j=0!=j?j:1
var Q=(S[L]-S[U])/j,$=(b[L]-b[U])/j,_=255*(w[L]-w[U])/j,tt=S[U],et=b[U],it=255*w[U],rt=y[U]-y[Z]
rt=0!=rt?rt:1
for(var at=(S[U]-S[Z])/rt,st=(b[U]-b[Z])/rt,ot=255*(w[U]-w[Z])/rt,nt=y[L]*e,ht=y[L];ht>y[Z];ht--){if(ht>=0&&i>ht){var lt=~~T,ft=P,ut=H,mt,ct,pt
if(ht>y[U]?(mt=~~G,ct=K,pt=q):(mt=~~tt,ct=et,pt=it),lt>mt){var dt
dt=lt,lt=mt,mt=dt,dt=ft,ft=ct,ct=dt,dt=ut,ut=pt,pt=dt}var vt=lt!=mt?(ct-ft)/(mt-lt):1,gt=lt!=mt?(pt-ut)/(mt-lt):1
0>lt&&(ft-=lt*vt,ut-=lt*gt,lt=0),mt>=e&&(mt=e-1)
var xt=nt+lt
if(v)for(var Ct=lt,Dt=ft,St=ut;mt>=Ct;Ct++,Dt+=vt,St+=gt)Dt>l[xt]&&(l[xt]=Dt,h[xt]=4278190080|d[St>0?~~St:0],f[xt]=c),xt++
else for(var Ct=lt,Dt=ft,St=ut;mt>Ct;Ct++,Dt+=vt,St+=gt){if(Dt>l[xt]){var yt=d[St>0?~~St:0],bt=h[xt],wt=(16711680&bt)*g+(16711680&yt)*x>>8,Bt=(65280&bt)*g+(65280&yt)*x>>8,Mt=(255&bt)*g+(255&yt)*x>>8,Jt=4278190080&bt|x<<24
h[xt]=Jt|16711680&wt|65280&Bt|255&Mt,f[xt]=c}xt++}}T-=W,P-=z,H-=O,ht>y[U]?(G-=Q,K-=$,q-=_):(tt-=at,et-=st,it-=ot),nt-=e}}I=X,V=k,F=N}while(-1!=r[M])
M++}}}},JSC3D.Viewer.prototype.renderSolidTexture=function(t){var e=this.frameWidth,i=this.frameHeight,r=t.indexBuffer,a=t.transformedVertexBuffer,s=t.transformedFaceNormalZBuffer,o=this.colorBuffer,n=this.zBuffer,h=this.selectionBuffer,l=t.faceCount,f=t.internalId,u=t.texture,m=!u.hasTransparency,c=t.texCoordBuffer,p=t.texCoordIndexBuffer?t.texCoordIndexBuffer:t.indexBuffer,d=u.data,v=u.width,g=v-1,x=u.hasMipmap()?u.mipmaps:null,C=x?u.mipentries:null,D=t.isDoubleSided||this.isCullingDisabled,S=0;(!s||s.length<l)&&(t.transformedFaceNormalZBuffer=new Array(l),s=t.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.faceNormalBuffer,s)
for(var y=new Array(3),b=new Array(3),w=new Array(3),B=new Array(3),M=new Array(3),J=0,A=0;l>J;){var V=s[J++]
if(D&&(V=V>0?V:-V),0>V){do;while(-1!=r[A++])}else{var k,Y,I,X,R,F
if(k=3*r[A],X=2*p[A],A++,Y=3*r[A],R=2*p[A],A++,x){I=3*r[A],F=2*p[A],v=u.width,y[0]=a[k],b[0]=a[k+1],y[1]=a[Y],b[1]=a[Y+1],y[2]=a[I],b[2]=a[I+1],B[0]=c[X]*v,M[0]=c[X+1]*v,B[1]=c[R]*v,M[1]=c[R+1]*v,B[2]=c[F]*v,M[2]=c[F+1]*v
var N=(y[1]-y[0])*(b[2]-b[0])-(b[1]-b[0])*(y[2]-y[0])
0>N&&(N=-N),N+=1
var Z=(B[1]-B[0])*(M[2]-M[0])-(M[1]-M[0])*(B[2]-B[0])
0>Z&&(Z=-Z)
var L=Z/N,U=0
if(L<C[1])U=0
else if(L>=C[C.length-1])U=C.length-1,v=1
else for(;L>=C[U+1];)U++,v/=2
d=x[U],g=v-1}do{I=3*r[A],F=2*p[A],A++,y[0]=~~(a[k]+.5),b[0]=~~(a[k+1]+.5),w[0]=a[k+2],y[1]=~~(a[Y]+.5),b[1]=~~(a[Y+1]+.5),w[1]=a[Y+2],y[2]=~~(a[I]+.5),b[2]=~~(a[I+1]+.5),w[2]=a[I+2],B[0]=c[X]*v,M[0]=c[X+1]*v,B[1]=c[R]*v,M[1]=c[R+1]*v,B[2]=c[F]*v,M[2]=c[F+1]*v
var T=b[0]<b[1]?0:1
T=b[T]<b[2]?T:2
var P=b[0]>b[1]?0:1
P=b[P]>b[2]?P:2
var H=3-P-T
if(T!=P){var E=y[P],W=w[P],z=B[P],O=M[P],G=b[P]-b[T]
G=0!=G?G:1
var K=(y[P]-y[T])/G,q=(w[P]-w[T])/G,j=(B[P]-B[T])/G,Q=(M[P]-M[T])/G,$=y[P],_=w[P],tt=B[P],et=M[P],it=b[P]-b[H]
it=0!=it?it:1
var rt=(y[P]-y[H])/it,at=(w[P]-w[H])/it,st=(B[P]-B[H])/it,ot=(M[P]-M[H])/it,nt=y[H],ht=w[H],lt=B[H],ft=M[H],ut=b[H]-b[T]
ut=0!=ut?ut:1
for(var mt=(y[H]-y[T])/ut,ct=(w[H]-w[T])/ut,pt=(B[H]-B[T])/ut,dt=(M[H]-M[T])/ut,vt=b[P]*e,gt=b[P];gt>b[T];gt--){if(gt>=0&&i>gt){var xt=~~E,Ct=W,Dt=z,St=O,yt,bt,wt,Bt
if(gt>b[H]?(yt=~~$,bt=_,wt=tt,Bt=et):(yt=~~nt,bt=ht,wt=lt,Bt=ft),xt>yt){var Mt
Mt=xt,xt=yt,yt=Mt,Mt=Ct,Ct=bt,bt=Mt,Mt=Dt,Dt=wt,wt=Mt,Mt=St,St=Bt,Bt=Mt}var Jt=xt!=yt?(bt-Ct)/(yt-xt):1,At=xt!=yt?(wt-Dt)/(yt-xt):1,Vt=xt!=yt?(Bt-St)/(yt-xt):1
0>xt&&(Ct-=xt*Jt,Dt-=xt*At,St-=xt*Vt,xt=0),yt>=e&&(yt=e-1)
var kt=vt+xt
if(m)for(var Yt=xt,It=Ct,Xt=Dt,Rt=St;yt>=Yt;Yt++,It+=Jt,Xt+=At,Rt+=Vt)It>n[kt]&&(n[kt]=It,o[kt]=d[(Rt&g)*v+(Xt&g)],h[kt]=f),kt++
else for(var Yt=xt,It=Ct,Xt=Dt,Rt=St;yt>Yt;Yt++,It+=Jt,Xt+=At,Rt+=Vt){if(It>n[kt]){var Ft=d[(Rt&g)*v+(Xt&g)],Nt=o[kt],Zt=Ft>>24&255,Lt=255-Zt,Ut=(16711680&Nt)*Lt+(16711680&Ft)*Zt>>8,Tt=(65280&Nt)*Lt+(65280&Ft)*Zt>>8,Pt=(255&Nt)*Lt+(255&Ft)*Zt>>8,Ht=4278190080&Nt|Zt<<24
o[kt]=Ht|16711680&Ut|65280&Tt|255&Pt,h[kt]=f}kt++}}E-=K,W-=q,z-=j,O-=Q,gt>b[H]?($-=rt,_-=at,tt-=st,et-=ot):(nt-=mt,ht-=ct,lt-=pt,ft-=dt),vt-=e}}Y=I,R=F}while(-1!=r[A])
A++}}},JSC3D.Viewer.prototype.renderTextureFlat=function(t){var e=this.frameWidth,i=this.frameHeight,r=t.indexBuffer,a=t.transformedVertexBuffer,s=t.transformedFaceNormalZBuffer,o=this.colorBuffer,n=this.zBuffer,h=this.selectionBuffer,l=t.faceCount,f=t.internalId,u=t.material?t.material:this.defaultMaterial,m=u.getPalette(),c=t.texture,p=0==u.transparency&&!c.hasTransparency,d=~~(255*(1-u.transparency)),v=t.texCoordBuffer,g=t.texCoordIndexBuffer?t.texCoordIndexBuffer:t.indexBuffer,x=c.data,C=c.width,D=C-1,S=c.hasMipmap()?c.mipmaps:null,y=S?c.mipentries:null,b=t.isDoubleSided||this.isCullingDisabled,w=0
if(1!=u.transparency){(!s||s.length<l)&&(t.transformedFaceNormalZBuffer=new Array(l),s=t.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.faceNormalBuffer,s)
for(var B=new Array(3),M=new Array(3),J=new Array(3),A=new Array(3),V=new Array(3),k=0,Y=0;l>k;){var I=s[k++]
if(b&&(I=I>0?I:-I),0>I){do;while(-1!=r[Y++])}else{var X=4278190080|m[~~(255*I)],R,F,N,Z,L,U
if(R=3*r[Y],Z=2*g[Y],Y++,F=3*r[Y],L=2*g[Y],Y++,S){N=3*r[Y],U=2*g[Y],C=c.width,B[0]=a[R],M[0]=a[R+1],B[1]=a[F],M[1]=a[F+1],B[2]=a[N],M[2]=a[N+1],A[0]=v[Z]*C,V[0]=v[Z+1]*C,A[1]=v[L]*C,V[1]=v[L+1]*C,A[2]=v[U]*C,V[2]=v[U+1]*C
var T=(B[1]-B[0])*(M[2]-M[0])-(M[1]-M[0])*(B[2]-B[0])
0>T&&(T=-T),T+=1
var P=(A[1]-A[0])*(V[2]-V[0])-(V[1]-V[0])*(A[2]-A[0])
0>P&&(P=-P)
var H=P/T,E=0
if(H<y[1])E=0
else if(H>=y[y.length-1])E=y.length-1,C=1
else for(;H>=y[E+1];)E++,C/=2
x=S[E],D=C-1}do{N=3*r[Y],U=2*g[Y],Y++,B[0]=~~(a[R]+.5),M[0]=~~(a[R+1]+.5),J[0]=a[R+2],B[1]=~~(a[F]+.5),M[1]=~~(a[F+1]+.5),J[1]=a[F+2],B[2]=~~(a[N]+.5),M[2]=~~(a[N+1]+.5),J[2]=a[N+2],A[0]=v[Z]*C,V[0]=v[Z+1]*C,A[1]=v[L]*C,V[1]=v[L+1]*C,A[2]=v[U]*C,V[2]=v[U+1]*C
var W=M[0]<M[1]?0:1
W=M[W]<M[2]?W:2
var z=M[0]>M[1]?0:1
z=M[z]>M[2]?z:2
var O=3-z-W
if(W!=z){var G=B[z],K=J[z],q=A[z],j=V[z],Q=M[z]-M[W]
Q=0!=Q?Q:1
var $=(B[z]-B[W])/Q,_=(J[z]-J[W])/Q,tt=(A[z]-A[W])/Q,et=(V[z]-V[W])/Q,it=B[z],rt=J[z],at=A[z],st=V[z],ot=M[z]-M[O]
ot=0!=ot?ot:1
var nt=(B[z]-B[O])/ot,ht=(J[z]-J[O])/ot,lt=(A[z]-A[O])/ot,ft=(V[z]-V[O])/ot,ut=B[O],mt=J[O],ct=A[O],pt=V[O],dt=M[O]-M[W]
dt=0!=dt?dt:1
for(var vt=(B[O]-B[W])/dt,gt=(J[O]-J[W])/dt,xt=(A[O]-A[W])/dt,Ct=(V[O]-V[W])/dt,Dt=M[z]*e,St=M[z];St>M[W];St--){if(St>=0&&i>St){var yt=~~G,bt=K,wt=q,Bt=j,Mt,Jt,At,Vt
if(St>M[O]?(Mt=~~it,Jt=rt,At=at,Vt=st):(Mt=~~ut,Jt=mt,At=ct,Vt=pt),yt>Mt){var kt
kt=yt,yt=Mt,Mt=kt,kt=bt,bt=Jt,Jt=kt,kt=wt,wt=At,At=kt,kt=Bt,Bt=Vt,Vt=kt}var Yt=yt!=Mt?(Jt-bt)/(Mt-yt):1,It=yt!=Mt?(At-wt)/(Mt-yt):1,Xt=yt!=Mt?(Vt-Bt)/(Mt-yt):1
0>yt&&(bt-=yt*Yt,wt-=yt*It,Bt-=yt*Xt,yt=0),Mt>=e&&(Mt=e-1)
var Rt=Dt+yt
if(p)for(var Ft=yt,Nt=bt,Zt=wt,Lt=Bt;Mt>=Ft;Ft++,Nt+=Yt,Zt+=It,Lt+=Xt){if(Nt>n[Rt]){n[Rt]=Nt
var Ut=x[(Lt&D)*C+(Zt&D)],Tt=((16711680&X)>>16)*((16711680&Ut)>>8),Pt=((65280&X)>>8)*((65280&Ut)>>8),Ht=(255&X)*(255&Ut)>>8
o[Rt]=4278190080|16711680&Tt|65280&Pt|255&Ht,h[Rt]=f}Rt++}else for(var Ft=yt,Nt=bt,Zt=wt,Lt=Bt;Mt>Ft;Ft++,Nt+=Yt,Zt+=It,Lt+=Xt){if(Nt>n[Rt]){var Et=x[(Lt&D)*C+(Zt&D)],Wt=o[Rt],zt=(Et>>24&255)*(255&d)>>8,Tt=((16711680&X)>>16)*((16711680&Et)>>8),Pt=((65280&X)>>8)*((65280&Et)>>8),Ht=(255&X)*(255&Et)>>8,Ot=4278190080&Wt|zt<<24
if(zt>250)n[Rt]=Nt
else{var Gt=255-zt
Tt=Tt*zt+(16711680&Wt)*Gt>>8,Pt=Pt*zt+(65280&Wt)*Gt>>8,Ht=Ht*zt+(255&Wt)*Gt>>8}o[Rt]=Ot|16711680&Tt|65280&Pt|255&Ht,h[Rt]=f}Rt++}}G-=$,K-=_,q-=tt,j-=et,St>M[O]?(it-=nt,rt-=ht,at-=lt,st-=ft):(ut-=vt,mt-=gt,ct-=xt,pt-=Ct),Dt-=e}}F=N,L=U}while(-1!=r[Y])
Y++}}}},JSC3D.Viewer.prototype.renderTextureSmooth=function(t){var e=this.frameWidth,i=this.frameHeight,r=t.indexBuffer,a=t.transformedVertexBuffer,s=t.transformedVertexNormalZBuffer,o=t.vertexNormalIndexBuffer?t.vertexNormalIndexBuffer:t.indexBuffer,n=t.transformedFaceNormalZBuffer,h=this.colorBuffer,l=this.zBuffer,f=this.selectionBuffer,u=t.faceCount,m=t.internalId,c=a.length/3,p=t.material?t.material:this.defaultMaterial,d=p.getPalette(),v=t.texture,g=0==p.transparency&&!v.hasTransparency,x=~~(255*(1-p.transparency)),C=t.texCoordBuffer,D=t.texCoordIndexBuffer?t.texCoordIndexBuffer:t.indexBuffer,S=v.data,y=v.width,b=y-1,w=v.hasMipmap()?v.mipmaps:null,B=w?v.mipentries:null,M=t.isDoubleSided||this.isCullingDisabled,J=0
if(1!=p.transparency){(!s||s.length<t.vertexNormalBuffer.length/3)&&(t.transformedVertexNormalZBuffer=new Array(t.vertexNormalBuffer.length/3),s=t.transformedVertexNormalZBuffer),(!n||n.length<u)&&(t.transformedFaceNormalZBuffer=new Array(u),n=t.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.vertexNormalBuffer,s),JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.faceNormalBuffer,n)
for(var A=new Array(3),V=new Array(3),k=new Array(3),Y=new Array(3),I=new Array(3),X=new Array(3),R=0,F=0;u>R;){var N=n[R++]
if(M&&(N=N>0?N:-N),0>N){do;while(-1!=r[F++])}else{var Z,L,U,T,P,H,E,W,z,O,G,K
if(Z=r[F],T=3*Z,E=2*D[F],O=o[F],F++,L=r[F],P=3*L,W=2*D[F],G=o[F],F++,w){H=3*r[F],z=2*D[F],y=v.width,A[0]=a[T],V[0]=a[T+1],A[1]=a[P],V[1]=a[P+1],A[2]=a[H],V[2]=a[H+1],I[0]=C[E]*y,X[0]=C[E+1]*y,I[1]=C[W]*y,X[1]=C[W+1]*y,I[2]=C[z]*y,X[2]=C[z+1]*y
var q=(A[1]-A[0])*(V[2]-V[0])-(V[1]-V[0])*(A[2]-A[0])
0>q&&(q=-q),q+=1
var j=(I[1]-I[0])*(X[2]-X[0])-(X[1]-X[0])*(I[2]-I[0])
0>j&&(j=-j)
var Q=j/q,$=0
if(Q<B[1])$=0
else if(Q>=B[B.length-1])$=B.length-1,y=1
else for(;Q>=B[$+1];)$++,y/=2
S=w[$],b=y-1}do{U=r[F],H=3*U,z=2*D[F],K=o[F],F++,A[0]=~~(a[T]+.5),V[0]=~~(a[T+1]+.5),k[0]=a[T+2],A[1]=~~(a[P]+.5),V[1]=~~(a[P+1]+.5),k[1]=a[P+2],A[2]=~~(a[H]+.5),V[2]=~~(a[H+1]+.5),k[2]=a[H+2],I[0]=C[E]*y,X[0]=C[E+1]*y,I[1]=C[W]*y,X[1]=C[W+1]*y,I[2]=C[z]*y,X[2]=C[z+1]*y,Y[0]=s[O],Y[1]=s[G],Y[2]=s[K],M&&(Y[0]<0&&(Y[0]=-Y[0]),Y[1]<0&&(Y[1]=-Y[1]),Y[2]<0&&(Y[2]=-Y[2]))
var _=V[0]<V[1]?0:1
_=V[_]<V[2]?_:2
var tt=V[0]>V[1]?0:1
tt=V[tt]>V[2]?tt:2
var et=3-tt-_
if(_!=tt){var it=A[tt],rt=k[tt],at=I[tt],st=X[tt],ot=255*Y[tt],nt=V[tt]-V[_]
nt=0!=nt?nt:1
var ht=(A[tt]-A[_])/nt,lt=(k[tt]-k[_])/nt,ft=(I[tt]-I[_])/nt,ut=(X[tt]-X[_])/nt,mt=255*(Y[tt]-Y[_])/nt,ct=A[tt],pt=k[tt],dt=I[tt],vt=X[tt],gt=255*Y[tt],xt=V[tt]-V[et]
xt=0!=xt?xt:1
var Ct=(A[tt]-A[et])/xt,Dt=(k[tt]-k[et])/xt,St=(I[tt]-I[et])/xt,yt=(X[tt]-X[et])/xt,bt=255*(Y[tt]-Y[et])/xt,wt=A[et],Bt=k[et],Mt=I[et],Jt=X[et],At=255*Y[et],Vt=V[et]-V[_]
Vt=0!=Vt?Vt:1
for(var kt=(A[et]-A[_])/Vt,Yt=(k[et]-k[_])/Vt,It=(I[et]-I[_])/Vt,Xt=(X[et]-X[_])/Vt,Rt=255*(Y[et]-Y[_])/Vt,Ft=V[tt]*e,Nt=V[tt];Nt>V[_];Nt--){if(Nt>=0&&i>Nt){var Zt=~~it,Lt=rt,Ut=at,Tt=st,Pt=ot,Ht,Et,Wt,zt,Ot
if(Nt>V[et]?(Ht=~~ct,Et=pt,Wt=dt,zt=vt,Ot=gt):(Ht=~~wt,Et=Bt,Wt=Mt,zt=Jt,Ot=At),Zt>Ht){var Gt
Gt=Zt,Zt=Ht,Ht=Gt,Gt=Lt,Lt=Et,Et=Gt,Gt=Ut,Ut=Wt,Wt=Gt,Gt=Tt,Tt=zt,zt=Gt,Gt=Pt,Pt=Ot,Ot=Gt}var Kt=Zt!=Ht?(Et-Lt)/(Ht-Zt):1,qt=Zt!=Ht?(Wt-Ut)/(Ht-Zt):1,jt=Zt!=Ht?(zt-Tt)/(Ht-Zt):1,Qt=Zt!=Ht?(Ot-Pt)/(Ht-Zt):0
0>Zt&&(Lt-=Zt*Kt,Ut-=Zt*qt,Tt-=Zt*jt,Pt-=Zt*Qt,Zt=0),Ht>=e&&(Ht=e-1)
var $t=Ft+Zt
if(g)for(var _t=Zt,te=Lt,ee=Pt,ie=Ut,re=Tt;Ht>=_t;_t++,te+=Kt,ee+=Qt,ie+=qt,re+=jt){if(te>l[$t]){l[$t]=te
var ae=d[ee>0?~~ee:0],se=S[(re&b)*y+(ie&b)],oe=((16711680&ae)>>16)*((16711680&se)>>8),ne=((65280&ae)>>8)*((65280&se)>>8),he=(255&ae)*(255&se)>>8
h[$t]=4278190080|16711680&oe|65280&ne|255&he,f[$t]=m}$t++}else for(var _t=Zt,te=Lt,ee=Pt,ie=Ut,re=Tt;Ht>_t;_t++,te+=Kt,ee+=Qt,ie+=qt,re+=jt){if(te>l[$t]){var ae=d[ee>0?~~ee:0],le=S[(re&b)*y+(ie&b)],fe=h[$t],ue=(le>>24&255)*(255&x)>>8,oe=((16711680&ae)>>16)*((16711680&le)>>8),ne=((65280&ae)>>8)*((65280&le)>>8),he=(255&ae)*(255&le)>>8,me=4278190080&fe|ue<<24
if(ue>250)l[$t]=te
else{var ce=255-ue
oe=oe*ue+(16711680&fe)*ce>>8,ne=ne*ue+(65280&fe)*ce>>8,he=he*ue+(255&fe)*ce>>8}h[$t]=me|16711680&oe|65280&ne|255&he,f[$t]=m}$t++}}it-=ht,rt-=lt,at-=ft,st-=ut,ot-=mt,Nt>V[et]?(ct-=Ct,pt-=Dt,dt-=St,vt-=yt,gt-=bt):(wt-=kt,Bt-=Yt,Mt-=It,Jt-=Xt,At-=Rt),Ft-=e}}L=U,P=H,W=z,G=K}while(-1!=r[F])
F++}}}},JSC3D.Viewer.prototype.renderSolidSphereMapped=function(t){var e=this.frameWidth,i=this.frameHeight,r=t.indexBuffer,a=t.transformedVertexBuffer,s=t.transformedVertexNormalBuffer,o=t.vertexNormalIndexBuffer?t.vertexNormalIndexBuffer:t.indexBuffer,n=t.transformedFaceNormalZBuffer,h=this.colorBuffer,l=this.zBuffer,f=this.selectionBuffer,u=t.faceCount,m=a.length/3,c=t.internalId,p=t.material?t.material:this.defaultMaterial,d=p.getPalette(),v=this.sphereMap,g=v.data,x=v.width,C=x-1,D=0==p.transparency,S=~~(255*p.transparency),y=255-S,b=t.isDoubleSided||this.isCullingDisabled,w=0
if(1!=p.transparency){(!s||s.length<t.vertexNormalBuffer.length)&&(t.transformedVertexNormalBuffer=new Array(t.vertexNormalBuffer.length),s=t.transformedVertexNormalBuffer),(!n||n.length<u)&&(t.transformedFaceNormalZBuffer=new Array(u),n=t.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectors(this.rotMatrix,t.vertexNormalBuffer,s),JSC3D.Math3D.transformVectorZs(this.rotMatrix,t.faceNormalBuffer,n)
for(var B=new Array(3),M=new Array(3),J=new Array(3),A=new Array(3),V=new Array(3),k=new Array(3),Y=0,I=0;u>Y;){var X=n[Y++]
if(b&&(X=X>0?X:-X),0>X){do;while(-1!=r[I++])}else{var R,F,N,Z,L,U
R=3*r[I],Z=3*o[I],I++,F=3*r[I],L=3*o[I],I++
do{N=3*r[I],U=3*o[I],I++,B[0]=~~(a[R]+.5),M[0]=~~(a[R+1]+.5),J[0]=a[R+2],B[1]=~~(a[F]+.5),M[1]=~~(a[F+1]+.5),J[1]=a[F+2],B[2]=~~(a[N]+.5),M[2]=~~(a[N+1]+.5),J[2]=a[N+2],A[0]=s[Z],V[0]=s[Z+1],k[0]=s[Z+2],A[1]=s[L],V[1]=s[L+1],k[1]=s[L+2],A[2]=s[U],V[2]=s[U+1],k[2]=s[U+2],b&&(k[0]<0&&(k[0]=-k[0]),k[1]<0&&(k[1]=-k[1]),k[2]<0&&(k[2]=-k[2]))
var T=M[0]<M[1]?0:1
T=M[T]<M[2]?T:2
var P=M[0]>M[1]?0:1
P=M[P]>M[2]?P:2
var H=3-P-T
if(T!=P){var E=B[P],W=J[P],z=255*k[P],O=(A[P]/2+.5)*x&C,G=(.5-V[P]/2)*x&C,K=M[P]-M[T]
K=0!=K?K:1
var q=(B[P]-B[T])/K,j=(J[P]-J[T])/K,Q=255*(k[P]-k[T])/K,$=(A[P]-A[T])/2*x/K,_=(V[T]-V[P])/2*x/K,tt=B[P],et=J[P],it=255*k[P],rt=(A[P]/2+.5)*x&C,at=(.5-V[P]/2)*x&C,st=M[P]-M[H]
st=0!=st?st:1
var ot=(B[P]-B[H])/st,nt=(J[P]-J[H])/st,ht=255*(k[P]-k[H])/st,lt=(A[P]-A[H])/2*x/st,ft=(V[H]-V[P])/2*x/st,ut=B[H],mt=J[H],ct=255*k[H],pt=(A[H]/2+.5)*x&C,dt=(.5-V[H]/2)*x&C,vt=M[H]-M[T]
vt=0!=vt?vt:1
for(var gt=(B[H]-B[T])/vt,xt=(J[H]-J[T])/vt,Ct=255*(k[H]-k[T])/vt,Dt=(A[H]-A[T])/2*x/vt,St=(V[T]-V[H])/2*x/vt,yt=M[P]*e,bt=M[P];bt>M[T];bt--){if(bt>=0&&i>bt){var wt=~~E,Bt=W,Mt=z,Jt=O,At=G,Vt,kt,Yt,It,Xt
if(bt>M[H]?(Vt=~~tt,kt=et,Yt=it,It=rt,Xt=at):(Vt=~~ut,kt=mt,Yt=ct,It=pt,Xt=dt),wt>Vt){var Rt
Rt=wt,wt=Vt,Vt=Rt,Rt=Bt,Bt=kt,kt=Rt,Rt=Mt,Mt=Yt,Yt=Rt,Rt=Jt,Jt=It,It=Rt,Rt=At,At=Xt,Xt=Rt}var Ft=wt!=Vt?(kt-Bt)/(Vt-wt):1,Nt=wt!=Vt?(Yt-Mt)/(Vt-wt):1,Zt=wt!=Vt?(It-Jt)/(Vt-wt):1,Lt=wt!=Vt?(Xt-At)/(Vt-wt):1
0>wt&&(Bt-=wt*Ft,Mt-=wt*Nt,Jt-=Jt*Zt,At-=At*Lt,wt=0),Vt>=e&&(Vt=e-1)
var Ut=yt+wt
if(D)for(var Tt=wt,Pt=Bt,Ht=Mt,Et=Jt,Wt=At;Vt>=Tt;Tt++,Pt+=Ft,Ht+=Nt,Et+=Zt,Wt+=Lt){if(Pt>l[Ut]){l[Ut]=Pt
var zt=d[Ht>0?~~Ht:0],Ot=g[(Wt&C)*x+(Et&C)],Gt=((16711680&zt)>>16)*((16711680&Ot)>>8),Kt=((65280&zt)>>8)*((65280&Ot)>>8),qt=(255&zt)*(255&Ot)>>8
h[Ut]=4278190080|16711680&Gt|65280&Kt|255&qt,f[Ut]=c}Ut++}else for(var Tt=wt,Pt=Bt,Ht=Mt,Et=Jt,Wt=At;Vt>Tt;Tt++,Pt+=Ft,Ht+=Nt,Et+=Zt,Wt+=Lt){if(Pt>l[Ut]){var zt=d[Ht>0?~~Ht:0],jt=g[(Wt&C)*x+(Et&C)],Qt=h[Ut],Gt=((16711680&zt)>>16)*((16711680&jt)>>8),Kt=((65280&zt)>>8)*((65280&jt)>>8),qt=(255&zt)*(255&jt)>>8,$t=4278190080&(Qt|zt)
Gt=Gt*y+(16711680&Qt)*S>>8,Kt=Kt*y+(65280&Qt)*S>>8,qt=qt*y+(255&Qt)*S>>8,h[Ut]=$t|16711680&Gt|65280&Kt|255&qt,f[Ut]=c}Ut++}}E-=q,W-=j,z-=Q,O-=$,G-=_,bt>M[H]?(tt-=ot,et-=nt,it-=ht,rt-=lt,at-=ft):(ut-=gt,mt-=xt,ct-=Ct,pt-=Dt,dt-=St),yt-=e}}F=N,L=U}while(-1!=r[I])
I++}}}},JSC3D.Viewer.prototype.params=null,JSC3D.Viewer.prototype.canvas=null,JSC3D.Viewer.prototype.ctx2d=null,JSC3D.Viewer.prototype.canvasData=null,JSC3D.Viewer.prototype.bkgColorBuffer=null,JSC3D.Viewer.prototype.colorBuffer=null,JSC3D.Viewer.prototype.zBuffer=null,JSC3D.Viewer.prototype.selectionBuffer=null,JSC3D.Viewer.prototype.frameWidth=0,JSC3D.Viewer.prototype.frameHeight=0,JSC3D.Viewer.prototype.scene=null,JSC3D.Viewer.prototype.textures=[],JSC3D.Viewer.prototype.materials=[],JSC3D.Viewer.prototype.defaultMaterial=null,JSC3D.Viewer.prototype.sphereMap=null,JSC3D.Viewer.prototype.isLoaded=!1,JSC3D.Viewer.prototype.isFailed=!1,JSC3D.Viewer.prototype.needUpdate=!1,JSC3D.Viewer.prototype.needRepaint=!1,JSC3D.Viewer.prototype.initRotX=0,JSC3D.Viewer.prototype.initRotY=0,JSC3D.Viewer.prototype.initRotZ=0,JSC3D.Viewer.prototype.initSceneRotation=0,JSC3D.Viewer.prototype.sceneRotation=0,JSC3D.Viewer.prototype.zoomFactor=1,JSC3D.Viewer.prototype.panning=[0,0],JSC3D.Viewer.prototype.rotation=[0,0,0],JSC3D.Viewer.prototype.fps=0,JSC3D.Viewer.prototype.frameNumber=0,JSC3D.Viewer.prototype.rotMatrix=null,JSC3D.Viewer.prototype.transformMatrix=null,JSC3D.Viewer.prototype.sceneUrl="",JSC3D.Viewer.prototype.modelColor=13280792,JSC3D.Viewer.prototype.bkgColor1=16777215,JSC3D.Viewer.prototype.bkgColor2=16777088,JSC3D.Viewer.prototype.renderMode="flat",JSC3D.Viewer.prototype.definition="standard",JSC3D.Viewer.prototype.isCullingDisabled=!1,JSC3D.Viewer.prototype.isMipMappingOn=!1,JSC3D.Viewer.prototype.creaseAngle=-180,JSC3D.Viewer.prototype.sphereMapUrl="",JSC3D.Viewer.prototype.showProgressBar=!0,JSC3D.Viewer.prototype.isAutoUpdateOn=!1,JSC3D.Viewer.prototype.autoRotateSpeed=0,JSC3D.Viewer.prototype.lightingMode="standard",JSC3D.Viewer.prototype.showLights=!1,JSC3D.Viewer.prototype.buttonStates=null,JSC3D.Viewer.prototype.keyStates=null,JSC3D.Viewer.prototype.mouseX=0,JSC3D.Viewer.prototype.mouseY=0,JSC3D.Viewer.prototype.onloadingstarted=null,JSC3D.Viewer.prototype.onloadingcomplete=null,JSC3D.Viewer.prototype.onloadingprogress=null,JSC3D.Viewer.prototype.onloadingaborted=null,JSC3D.Viewer.prototype.onloadingerror=null,JSC3D.Viewer.prototype.onmousedown=null,JSC3D.Viewer.prototype.onmouseup=null,JSC3D.Viewer.prototype.onmousemove=null,JSC3D.Viewer.prototype.onmousewheel=null,JSC3D.Viewer.prototype.onmouseclick=null,JSC3D.Viewer.prototype.beforeupdate=null,JSC3D.Viewer.prototype.afterupdate=null,JSC3D.Viewer.prototype.mouseUsage="default",JSC3D.Viewer.prototype.isDefaultInputHandlerEnabled=!1,JSC3D.Viewer.prototype.isSceneRotationEnabled=!1,JSC3D.Viewer.prototype.onscenerotation=null,JSC3D.Viewer.prototype.ontick=null,JSC3D.PickInfo=function(){this.canvasX=0,this.canvasY=0,this.depth=-(1/0),this.mesh=null},JSC3D.Scene=function(t){this.name=t||"",this.srcUrl="",this.aabb=null,this.children=[],this.maxChildId=1,this.currentMesh=null,this.isLightingOn=!1,this.rotMat=new JSC3D.Matrix3x4,this.xformMat=new JSC3D.Matrix3x4,this.lights=[]},JSC3D.Scene.prototype.init=function(){if(!this.isEmpty()){this.currentMesh=null
for(var t=0;t<this.children.length;t++)this.children[t].init()
this.aabb||(this.aabb=new JSC3D.AABB,this.calcAABB())}},JSC3D.Scene.prototype.isEmpty=function(){return 0==this.children.length},JSC3D.Scene.prototype.addChild=function(t){t.internalId=this.maxChildId++,t.axis||t.setAxis(),this.children.push(t)},JSC3D.Scene.prototype.removeChild=function(t){var e=this.children.indexOf(t)
e>=0&&this.children.splice(e,1)},JSC3D.Scene.prototype.getChildren=function(){return this.children.slice(0)},JSC3D.Scene.prototype.forEachChild=function(t){if("function"==typeof t)for(var e=0;e<this.children.length&&!t.call(null,this.children[e]);e++);},JSC3D.Scene.prototype.calcAABB=function(){this.aabb.minX=this.aabb.minY=this.aabb.minZ=1/0,this.aabb.maxX=this.aabb.maxY=this.aabb.maxZ=-(1/0)
for(var t=0;t<this.children.length;t++){var e=this.children[t]
if(!e.isTrivial()){var i=e.aabb.minX,r=e.aabb.minY,a=e.aabb.minZ,s=e.aabb.maxX,o=e.aabb.maxY,n=e.aabb.maxZ
this.aabb.minX>i&&(this.aabb.minX=i),this.aabb.minY>r&&(this.aabb.minY=r),this.aabb.minZ>a&&(this.aabb.minZ=a),this.aabb.maxX<s&&(this.aabb.maxX=s),this.aabb.maxY<o&&(this.aabb.maxY=o),this.aabb.maxZ<n&&(this.aabb.maxZ=n)}}},JSC3D.Scene.prototype.name="",JSC3D.Scene.prototype.srcUrl="",JSC3D.Scene.prototype.aabb=null,JSC3D.Scene.prototype.children=null,JSC3D.Scene.prototype.maxChildId=1,JSC3D.Scene.prototype.currentMesh=null,JSC3D.Scene.prototype.isLightingOn=!1,JSC3D.Scene.prototype.xformMat=null,JSC3D.Scene.prototype.lights=[],JSC3D.Scene.prototype.getMeshes=function(t){for(var e=[],i=0,r=this.children.length;r>i;i++){var a=this.children[i]
a.name===t&&e.push(a)}return e},JSC3D.Scene.prototype.toggleMeshes=function(t,e){for(var i=this.getMeshes(t),r=0,a=i.length;a>r;r++){var s=i[r]
s.visible=e}},JSC3D.Scene.prototype.renameMeshes=function(t,e){for(var i=this.getMeshes(t),r=0,a=i.length;a>r;r++){var s=i[r]
s.setGroupName(e)}},JSC3D.Scene.prototype.rotateMeshes=function(t,e,i){for(var r=this.getMeshes(t),a=0,s=r.length;s>a;a++){var o=r[a]
o.rotate(e,i)}},JSC3D.Scene.prototype.translateMeshes=function(t,e,i){for(var r=this.getMeshes(t),a=0,s=r.length;s>a;a++){var o=r[a]
o.translate(e,i)}},JSC3D.Scene.prototype.scaleMeshes=function(t,e,i){for(var r=this.getMeshes(t),a=0,s=r.length;s>a;a++){var o=r[a]
o.scale(e,i)}},JSC3D.Scene.prototype.resizeMeshes=function(t,e,i){for(var r=this.getMeshes(t),a=0,s=r.length;s>a;a++){var o=r[a]
o.resize(e,i)}},JSC3D.Scene.prototype.transformMeshes=function(t,e,i,r,a,s,o){for(var n=this.getMeshes(t),h=0,l=n.length;l>h;h++){var f=n[h]
f.transform(e,i,r,a,s,o)}},JSC3D.Scene.prototype.cloneMeshes=function(t,e,i,r,a,s,o,n){for(var h=this.getMeshes(t),l=0,f=h.length;f>l;l++){var u=h[l],m=u.clone(e,i,r,a,s,o,n)
this.addChild(m)}},JSC3D.Scene.prototype.makeGroundPlane=function(t,e,i){var r=i||"wireframe",a=!0,s=this.aabb,o=s.center(),n=.5*Math.max(s.maxX-s.minX,s.maxZ-s.minZ),h=o[0]-n,l=o[2]-n,f=s.minY-.001*(s.maxY-s.minY),u=new JSC3D.Mesh
if(u.name="groundplane","texture"==i||"textureflat"==i||"texturesmooth"==i)u.vertexBuffer=[l,f,-h,-l,f,-h,-l,f,h,l,f,h],u.indexBuffer=[0,1,2,-1,3,0,2,-1],u.texCoordBuffer=[1,0,0,0,0,1,1,1],u.texCoordIndexBuffer=[0,1,2,-1,3,0,2,-1]
else{var m=10,c=2*n/m
u.vertexBuffer=[]
for(var p=0;m>=p;p++)for(var d=0;m>=d;d++)u.vertexBuffer.push(h+d*c,f,l+p*c)
u.indexBuffer=[]
for(var p=0;m>p;p++)for(var d=0;m>d;d++)u.indexBuffer.push(p*(m+1)+d,(p+1)*(m+1)+d,(p+1)*(m+1)+d+1,p*(m+1)+d+1,-1)}return u.isDoubleSided=!0,("point"==i||"wireframe"==i||"flat"==i||"texture"==i)&&(a=!1),e&&(u.setTexture(e),u.texture.isLightingCast=a),t&&(u.setMaterial(new JSC3D.Material("groundplane",void 0,t)),u.material.isLightingCast=a),u.setRenderMode(r),u.init(),this.addChild(u),this.children[this.children.length-1]},JSC3D.Scene.prototype.makeLightSphere=function(t,e){var i=new JSC3D.Mesh,r=this.lights.length
i.name="light",i.groupIndex=r,i.vertexBuffer=[],i.indexBuffer=[]
for(var a=1,s=(1+Math.sqrt(5))/2,o=s/Math.sqrt(1+s*s)*a,n=1/Math.sqrt(1+s*s)*a,h={points:[[o,n,0],[-o,n,0],[-o,-n,0],[o,-n,0],[n,0,o],[n,0,-o],[-n,0,-o],[-n,0,o],[0,o,n],[0,-o,n],[0,-o,-n],[0,o,-n]],faces:[[4,8,7],[4,7,9],[5,6,11],[5,10,6],[0,4,3],[0,3,5],[2,7,1],[2,1,6],[8,0,11],[8,11,1],[9,10,3],[9,2,10],[8,4,0],[11,0,5],[4,9,3],[5,3,10],[7,8,1],[6,1,11],[7,2,9],[6,10,2]]},l=0,f=h.points.length;f>l;l++)for(var u=0;3>u;u++)i.vertexBuffer.push(h.points[l][u])
for(var l=0,f=h.faces.length;f>l;l++){for(var u=0;3>u;u++)i.indexBuffer.push(h.faces[l][u])
i.indexBuffer.push(-1)}return i.creaseAngle=41,i.init(),i.setRenderMode(e),i.setMaterial(new JSC3D.Material("light-"+r,void 0,t)),this.addChild(i),this.children[this.children.length-1]},JSC3D.Scene.prototype.addLight=function(t,e,i,r,a,s,o){var n=this.aabb,h=.01*Math.max(n.maxX-n.minX,n.maxZ-n.minZ),l=this.lights.length
6==l&&JSC3D.console&&JSC3D.console.logError("Cannot add another light. Max number of lights reached!")
var f=new JSC3D.Light("light-"+(l+1),[t,e,i],r,a,s)
this.lights.push(f)
var u=this.makeLightSphere(a,"flat")
u.isPositionFixed=!0,u.resize([h,h,h],"center"),u.translate([t,e,i],"scene"),u.visible=this.isLightingOn?o:!1},JSC3D.Mesh=function(t,e,i,r,a,s,o,n,h,l,f){this.name=t||"",this.groupIndex=0,this.metadata="",this.visible=void 0!=e?e:!0,this.renderMode=null,this.aabb=null,this.axis=null,this.rotation=[0,0,0],this.translation=[0,0,0],this.scaling=[1,1,1],this.vertexBuffer=n||null,this.indexBuffer=h||null,this.vertexNormalBuffer=null,this.vertexNormalIndexBuffer=null,this.faceNormalBuffer=null,this.material=i||null,this.texture=r||null,this.faceCount=0,this.creaseAngle=a>=0?a:-180,this.isDoubleSided="boolean"==typeof s?s:!1,this.isPositionFixed="boolean"==typeof o?o:!1,this.internalId=0,this.texCoordBuffer=l||null,this.texCoordIndexBuffer=f||null,this.transformedVertexBuffer=null,this.transformedVertexNormalZBuffer=null,this.transformedFaceNormalZBuffer=null,this.transformedVertexNormalBuffer=null},JSC3D.Mesh.prototype.init=function(){this.isTrivial()||(0!=this.faceCount||(this.calcFaceCount(),0!=this.faceCount))&&(this.aabb||(this.aabb=new JSC3D.AABB,this.calcAABB()),this.faceNormalBuffer||(this.faceNormalBuffer=new Array(3*this.faceCount),this.calcFaceNormals()),this.vertexNormalBuffer||(this.creaseAngle>=0?this.calcCreasedVertexNormals():(this.vertexNormalBuffer=new Array(this.vertexBuffer.length),this.calcVertexNormals())),this.normalizeFaceNormals(),this.transformedVertexBuffer=new Array(this.vertexBuffer.length))},JSC3D.Mesh.prototype.isTrivial=function(){return!this.vertexBuffer||this.vertexBuffer.length<3||!this.indexBuffer||this.indexBuffer.length<3},JSC3D.Mesh.prototype.setMaterial=function(t){this.material=t},JSC3D.Mesh.prototype.setTexture=function(t){this.texture=t},JSC3D.Mesh.prototype.hasTexture=function(){return null!=this.texture&&this.texture.hasData()&&null!=this.texCoordBuffer&&this.texCoordBuffer.length>=2&&(null==this.texCoordIndexBuffer||this.texCoordIndexBuffer.length>=3&&this.texCoordIndexBuffer.length>=this.indexBuffer.length)},JSC3D.Mesh.prototype.setRenderMode=function(t){this.renderMode=t},JSC3D.Mesh.prototype.calcFaceCount=function(){this.faceCount=0
var t=this.indexBuffer;-1!=t[t.length-1]&&t.push(-1)
for(var e=0;e<t.length;e++)-1==t[e]&&this.faceCount++},JSC3D.Mesh.prototype.calcAABB=function(){var t,e,i,r,a,s
t=e=i=1/0,r=a=s=-(1/0)
for(var o=this.vertexBuffer,n=0;n<o.length;n+=3){var h=o[n],l=o[n+1],f=o[n+2]
t>h&&(t=h),h>r&&(r=h),e>l&&(e=l),l>a&&(a=l),i>f&&(i=f),f>s&&(s=f)}this.aabb.minX=t,this.aabb.minY=e,this.aabb.minZ=i,this.aabb.maxX=r,this.aabb.maxY=a,this.aabb.maxZ=s},JSC3D.Mesh.prototype.getSize=function(){var t=this.aabb
return[t.maxX-t.minX,t.maxY-t.minY,t.maxZ-t.minZ]},JSC3D.Mesh.prototype.setAxis=function(){this.aabb||(this.aabb=new JSC3D.AABB,this.calcAABB()),this.axis=this.aabb.center()},JSC3D.Mesh.prototype.calcFaceNormals=function(){for(var t=this.vertexBuffer,e=this.indexBuffer,i=this.faceNormalBuffer,r=0,a=0;r<e.length;){var s=3*e[r++],o=t[s],n=t[s+1],h=t[s+2]
s=3*e[r++]
var l=t[s],f=t[s+1],u=t[s+2]
s=3*e[r++]
var m=t[s],c=t[s+1],p=t[s+2],d=l-o,v=f-n,g=u-h,x=m-o,C=c-n,D=p-h,S=v*D-g*C,y=g*x-d*D,b=d*C-v*x
i[a++]=S,i[a++]=y,i[a++]=b
do;while(-1!=e[r++])}},JSC3D.Mesh.prototype.normalizeFaceNormals=function(){JSC3D.Math3D.normalizeVectors(this.faceNormalBuffer,this.faceNormalBuffer)},JSC3D.Mesh.prototype.calcVertexNormals=function(){this.faceNormalBuffer||(this.faceNormalBuffer=new Array(3*this.faceCount),this.calcFaceNormals())
for(var t=this.vertexBuffer,e=this.indexBuffer,i=this.faceNormalBuffer,r=this.vertexNormalBuffer,a=0;a<r.length;a++)r[a]=0
this.vertexNormalIndexBuffer=null
for(var s=t.length/3,a=0,o=0,n=0;a<e.length;)if(n=e[a++],-1==n)o+=3
else{var h=3*n
r[h]+=i[o],r[h+1]+=i[o+1],r[h+2]+=i[o+2]}JSC3D.Math3D.normalizeVectors(r,r)},JSC3D.Mesh.prototype.calcCreasedVertexNormals=function(){this.faceNormalBuffer||(this.faceNormalBuffer=new Array(3*this.faceCount),this.calcFaceNormals())
for(var t=this.indexBuffer,e=this.vertexBuffer.length/3,i=new Array(e),r=0,a=0,s=0,o=0;a<t.length;a++)if(o=t[a],o>=0){r+=3
var n=i[o]
n?n.push(s):i[o]=[s]}else s++
var h=this.faceNormalBuffer,l=new Array(h.length)
JSC3D.Math3D.normalizeVectors(h,l),(!this.vertexNormalBuffer||this.vertexNormalBuffer.length<r)&&(this.vertexNormalBuffer=new Array(r))
for(var f=this.vertexNormalBuffer,a=0;a<f.length;a++)f[a]=0
this.vertexNormalIndexBuffer=[]
for(var u=this.vertexNormalIndexBuffer,m=Math.cos(this.creaseAngle*Math.PI/180),a=0,o=0,c=0,p=0;a<t.length;a++)if(o=t[a],o>=0){var d=3*c,v=3*p
f[d]+=h[v],f[d+1]+=h[v+1],f[d+2]+=h[v+2]
for(var g=l[v],x=l[v+1],C=l[v+2],n=i[o],D=0;D<n.length;D++){var S=n[D]
if(p!=S){var y=3*S,b=l[y],w=l[y+1],B=l[y+2]
g*b+x*w+C*B>m&&(f[d]+=h[y],f[d+1]+=h[y+1],f[d+2]+=h[y+2])}}u.push(c++)}else p++,u.push(-1)
JSC3D.Math3D.normalizeVectors(f,f)},JSC3D.Mesh.prototype.checkValid=function(){},JSC3D.Mesh.prototype.name="",JSC3D.Mesh.prototype.groupIndex=0,JSC3D.Mesh.prototype.metadata="",JSC3D.Mesh.prototype.visible=!1,JSC3D.Mesh.prototype.renderMode="flat",JSC3D.Mesh.prototype.aabb=null,JSC3D.Mesh.prototype.axis=null,JSC3D.Mesh.prototype.rotation=null,JSC3D.Mesh.prototype.translation=null,JSC3D.Mesh.prototype.scaling=null,JSC3D.Mesh.prototype.vertexBuffer=null,JSC3D.Mesh.prototype.indexBuffer=null,JSC3D.Mesh.prototype.vertexNormalBuffer=null,JSC3D.Mesh.prototype.vertexNormalIndexBuffer=null,JSC3D.Mesh.prototype.faceNormalBuffer=null,JSC3D.Mesh.prototype.texCoordBuffer=null,JSC3D.Mesh.prototype.texCoordIndexBuffer=null,JSC3D.Mesh.prototype.material=null,JSC3D.Mesh.prototype.texture=null,JSC3D.Mesh.prototype.faceCount=0,JSC3D.Mesh.prototype.creaseAngle=-180,JSC3D.Mesh.prototype.isDoubleSided=!1,JSC3D.Mesh.prototype.isPositionFixed=!1,JSC3D.Mesh.prototype.internalId=0,JSC3D.Mesh.prototype.transformedVertexBuffer=null,JSC3D.Mesh.prototype.transformedVertexNormalZBuffer=null,JSC3D.Mesh.prototype.transformedFaceNormalZBuffer=null,JSC3D.Mesh.prototype.transformedVertexNormalBuffer=null,JSC3D.Mesh.prototype.rotate=function(t,e){var i=new JSC3D.Matrix3x4,r=new JSC3D.Matrix3x4,a=new JSC3D.Matrix3x4,s,o=this.aabb.center()
switch(e){case"axis":s=[this.translation[0],this.translation[1],this.translation[2]]
break
case"scene":break
case"center":s=this.aabb.center()}var n=360,h=180
t[0]%=n,t[1]%=n,t[2]%=n
var l=this.rotation[0]+t[0],f=this.rotation[1]+t[1],u=this.rotation[2]+t[2],m=t[0],c=t[1],p=t[2];-h>l&&(m+=n),l>=h&&(m-=n),-h>f&&(c+=n),f>=h&&(c-=n),-h>u&&(p+=n),u>=h&&(p-=n),this.rotation[0]+=m,this.rotation[1]+=c,this.rotation[2]+=p,m&&r.rotateAboutXAxis(m),c&&r.rotateAboutYAxis(c),p&&r.rotateAboutZAxis(p),s&&a.translate(-s[0],-s[1],-s[2]),m&&a.rotateAboutXAxis(m),c&&a.rotateAboutYAxis(c),p&&a.rotateAboutZAxis(p),s&&a.translate(s[0],s[1],s[2]),i.multiply(a),JSC3D.Math3D.transformVectors(i,this.vertexBuffer,this.vertexBuffer),JSC3D.Math3D.transformVectors(r,this.faceNormalBuffer,this.faceNormalBuffer),JSC3D.Math3D.transformVectors(r,this.vertexNormalBuffer,this.vertexNormalBuffer),this.calcAABB(),this.compiled=null},JSC3D.Mesh.prototype.translate=function(t,e){var i=new JSC3D.Matrix3x4
this.translation[0]+=t[0],this.translation[1]+=t[1],this.translation[2]+=t[2],i.translate(t[0],t[1],t[2]),JSC3D.Math3D.transformVectors(i,this.vertexBuffer,this.vertexBuffer),this.calcAABB(),this.compiled=null},JSC3D.Mesh.prototype.scale=function(t,e){var i=new JSC3D.Matrix3x4,r=this.aabb,a=r.center(),s=1,o=1,n=1
t[0]&&(s=t[0]/this.scaling[0],this.scaling[0]*=s),t[1]&&(o=t[1]/this.scaling[1],this.scaling[1]*=o),t[2]&&(n=t[2]/this.scaling[2],this.scaling[2]*=n),i.scale(s,o,n)
var h=0,l=0,f=0
switch(e){case"plus":h=r.minX-r.minX*s,l=r.minY-r.minY*o,f=r.minZ-r.minZ*n
break
case"minus":h=r.maxX-r.maxX*s,l=r.maxY-r.maxY*o,f=r.maxZ-r.maxZ*n
break
case"center":h=a[0]-a[0]*s,l=a[1]-a[1]*o,f=a[2]-a[2]*n}i.translate(h,l,f),JSC3D.Math3D.transformVectors(i,this.vertexBuffer,this.vertexBuffer),this.calcAABB(),this.compiled=null
var u=[r.maxX-r.minX,r.maxY-r.minY,r.maxZ-r.minZ]},JSC3D.Mesh.prototype.transform=function(t,e,i,r,a,s){var o,n=this.aabb.center()
switch(e){case"axis":o=[this.translation[0],this.translation[1],this.translation[2]]
break
case"scene":break
case"center":o=this.aabb.center()}var h=new JSC3D.Matrix3x4,l=new JSC3D.Matrix3x4,f=new JSC3D.Matrix3x4
if(t){var u=360,m=180
t[0]%=u,t[1]%=u,t[2]%=u
var c=this.rotation[0]+t[0],p=this.rotation[1]+t[1],d=this.rotation[2]+t[2],v=t[0],g=t[1],x=t[2];-m>c&&(v+=u),c>=m&&(v-=u),-m>p&&(g+=u),p>=m&&(g-=u),-m>d&&(x+=u),d>=m&&(x-=u),this.rotation[0]+=v,this.rotation[1]+=g,this.rotation[2]+=x,o&&f.translate(-o[0],-o[1],-o[2]),l.rotateAboutXAxis(t[0]),f.rotateAboutXAxis(t[0]),l.rotateAboutYAxis(t[1]),f.rotateAboutYAxis(t[1]),l.rotateAboutZAxis(t[2]),f.rotateAboutZAxis(t[2]),o&&f.translate(o[0],o[1],o[2])}if(h.multiply(f),i&&(this.translation[0]+=i[0],this.translation[1]+=i[1],this.translation[2]+=i[2],h.translate(i[0],i[1],i[2])),a){var C=1,D=1,S=1
a[0]&&(C=a[0]/this.scaling[0],this.scaling[0]*=C),a[1]&&(D=a[1]/this.scaling[1],this.scaling[1]*=D),a[2]&&(S=a[2]/this.scaling[2],this.scaling[2]*=S),h.scale(C,D,S)}JSC3D.Math3D.transformVectors(h,this.vertexBuffer,this.vertexBuffer),JSC3D.Math3D.transformVectors(l,this.faceNormalBuffer,this.faceNormalBuffer),JSC3D.Math3D.transformVectors(l,this.vertexNormalBuffer,this.vertexNormalBuffer)},JSC3D.Mesh.prototype.resize=function(t,e){var i=new JSC3D.Matrix3x4,r=this.aabb,a=[r.maxX-r.minX,r.maxY-r.minY,r.maxZ-r.minZ],s=r.center(),o=1,n=1,h=1
t[0]&&(o=t[0]/a[0],this.scaling[0]*=t[0]/a[0]),t[1]&&(n=t[1]/a[1],this.scaling[1]*=t[1]/a[1]),t[2]&&(h=t[2]/a[2],this.scaling[2]*=t[2]/a[2]),i.scale(o,n,h)
var l=0,f=0,u=0
switch(e){case"plus":l=r.minX-r.minX*o,f=r.minY-r.minY*n,u=r.minZ-r.minZ*h
break
case"minus":l=r.maxX-r.maxX*o,f=r.maxY-r.maxY*n,u=r.maxZ-r.maxZ*h
break
case"center":l=s[0]-s[0]*o,f=s[1]-s[1]*n,u=s[2]-s[2]*h}i.translate(l,f,u),JSC3D.Math3D.transformVectors(i,this.vertexBuffer,this.vertexBuffer),this.calcAABB(),this.compiled=null
var m=[r.maxX-r.minX,r.maxY-r.minY,r.maxZ-r.minZ]},JSC3D.Mesh.prototype.shiftX=function(){var t=new JSC3D.Matrix3x4,e=this.aabb.center(),i=e[0]
t.translate(-2*i,0,0),JSC3D.Math3D.transformVectors(t,this.vertexBuffer,this.vertexBuffer),this.calcAABB(),this.compiled=null},JSC3D.Mesh.prototype.shiftZ=function(){var t=new JSC3D.Matrix3x4,e=this.aabb.center(),i=e[2]
t.translate(0,0,-2*i),JSC3D.Math3D.transformVectors(t,this.vertexBuffer,this.vertexBuffer),this.calcAABB(),this.compiled=null},JSC3D.Mesh.prototype.flipX=function(){var t=new JSC3D.Matrix3x4,e=new JSC3D.Matrix3x4,i=new JSC3D.Matrix3x4,r=new JSC3D.Matrix3x4,a=this.aabb.center(),s=a[0],o=a[1],n=a[2],h=180,l=90,f=0,u,m,c=this.rotation[1]
f>c&&c>=-l&&(u=-h-2*c,m=u),c>=f&&l>c&&(u=-h-2*c,m=u),c>=l&&h>c&&(u=2*(h-c)-h,m=u),-l>c&&c>=-h&&(u=h-2*(h+c),m=u),this.rotation[1]+=m,i.rotateAboutYAxis(u),r.translate(-s,-o,-n),r.rotateAboutYAxis(u),r.translate(s,o,n),t.multiply(r),JSC3D.Math3D.transformVectors(t,this.vertexBuffer,this.vertexBuffer),JSC3D.Math3D.transformVectors(i,this.faceNormalBuffer,this.faceNormalBuffer),JSC3D.Math3D.transformVectors(i,this.vertexNormalBuffer,this.vertexNormalBuffer),this.calcAABB()
var p=this.aabb.center(),d=p[0]
e.translate(-2*d,0,0),JSC3D.Math3D.transformVectors(e,this.vertexBuffer,this.vertexBuffer),this.calcAABB(),this.compiled=null},JSC3D.Mesh.prototype.flipZ=function(){var t=new JSC3D.Matrix3x4,e=new JSC3D.Matrix3x4,i=new JSC3D.Matrix3x4,r=new JSC3D.Matrix3x4,a=this.aabb.center(),s=a[0],o=a[1],n=a[2],h=360,l=180,f=90,u=0,m,c,p=this.rotation[1]
u>p&&p>=-f&&(m=-2*p,c=m),p>=u&&f>p&&(m=-2*p,c=m),p>=f&&l>p&&(m=h-2*p,c=m-h),-f>p&&p>-l&&(m=-h-2*p,c=m+h),p==-l&&(m=u,c=u),this.rotation[1]+=c,i.rotateAboutYAxis(m),r.translate(-s,-o,-n),r.rotateAboutYAxis(m),r.translate(s,o,n),t.multiply(r),JSC3D.Math3D.transformVectors(t,this.vertexBuffer,this.vertexBuffer),JSC3D.Math3D.transformVectors(i,this.faceNormalBuffer,this.faceNormalBuffer),JSC3D.Math3D.transformVectors(i,this.vertexNormalBuffer,this.vertexNormalBuffer),this.calcAABB()
var d=this.aabb.center(),v=d[2]
e.translate(0,0,-2*v),JSC3D.Math3D.transformVectors(e,this.vertexBuffer,this.vertexBuffer),this.calcAABB(),this.compiled=null},JSC3D.Mesh.prototype.clone=function(t,e,i,r,a,s,o){var n=new JSC3D.Mesh
n.name=t||this.name,n.groupIndex=this.groupIndex,n.visible=this.visible,n.creaseAngle=this.creaseAngle,n.isDoubleSided=this.isDoubleSided,n.renderMode=this.renderMode,n.axis=[this.axis[0],this.axis[1],this.axis[2]],n.mtllib=this.mtllib,n.mtl=this.mtl,n.setMaterial(this.material),n.setTexture(this.texture)
var h=new JSC3D.Matrix3x4,l=new JSC3D.Matrix3x4,f=new JSC3D.Matrix3x4,u,m=this.aabb.center()
switch(i){case"axis":u=[this.translation[0],this.translation[1],this.translation[2]]
break
case"scene":break
case"center":u=this.aabb.center()}if(e){var c=360,p=180
e[0]%=c,e[1]%=c,e[2]%=c
var d=this.rotation[0]+e[0],v=this.rotation[1]+e[1],g=this.rotation[2]+e[2],x=e[0],C=e[1],D=e[2];-p>d&&(x+=c),d>=p&&(x-=c),-p>v&&(C+=c),v>=p&&(C-=c),-p>g&&(D+=c),g>=p&&(D-=c),n.rotation[0]=x,n.rotation[1]=C,n.rotation[2]=D,u&&f.translate(-u[0],-u[1],-u[2]),l.rotateAboutXAxis(e[0]),f.rotateAboutXAxis(e[0]),l.rotateAboutYAxis(e[1]),f.rotateAboutYAxis(e[1]),l.rotateAboutZAxis(e[2]),f.rotateAboutZAxis(e[2]),u&&f.translate(u[0],u[1],u[2])}if(h.multiply(f),r){var S=this.translation[0]+r[0],y=this.translation[1]+r[1],b=this.translation[2]+r[2]
n.translation[0]=S,n.translation[1]=y,n.translation[2]=b,h.translate(r[0],r[1],r[2])}if(s){var w=1,B=1,M=1
s[0]&&(w=s[0]/this.scaling[0],this.scaling[0]*=w),s[1]&&(B=s[1]/this.scaling[1],this.scaling[1]*=B),s[2]&&(M=s[2]/this.scaling[2],this.scaling[2]*=M),h.scale(w,B,M)}return n.indexBuffer=this.indexBuffer,n.vertexBuffer=new Array(this.vertexBuffer.length),n.faceNormalBuffer=new Array(this.faceNormalBuffer.length),JSC3D.Math3D.transformVectors(h,this.vertexBuffer,n.vertexBuffer),JSC3D.Math3D.transformVectors(l,this.faceNormalBuffer,n.faceNormalBuffer),n.texCoordBuffer=[],n.texCoordIndexBuffer=[],n.init(),n},JSC3D.Mesh.prototype.getGroupName=function(){return this.name},JSC3D.Mesh.prototype.getGroupIndex=function(){return this.groupIndex},JSC3D.Mesh.prototype.setGroupName=function(t,e){var i=this.getGroupName(),r=this.getGroupIndex()
this.name=t?t:i,this.groupIndex=e?e:r},JSC3D.Material=function(t,e,i,r,a,s,o,n,h,l,f){this.name=t||"",this.diffuseColor=i||8355711,this.ambientColor="number"==typeof e?e:(16711680&this.diffuseColor)>>3&16711680|(65280&this.diffuseColor)>>3&65280|(255&this.diffuseColor)>>3,this.specularColor="number"==typeof r?r:i,this.ambientReflection="number"==typeof a?a:.2,this.diffuseReflection="number"==typeof s?s:1,this.specularReflection="number"==typeof o?o:0,this.shininess="number"==typeof n?n:1,this.simulateSpecular=this.specularReflection>0?!0:!1,this.transparency="number"==typeof h?h:0,this.isEnvironmentCast="boolean"==typeof l?l:!1,this.isLightingCast="boolean"==typeof f?f:!0,this.palette=null},JSC3D.Material.prototype.getPalette=function(){return this.palette||(this.palette=new Array(256),this.generatePalette()),this.palette},JSC3D.Material.prototype.generatePalette=function(){var t=(16711680&this.ambientColor)>>16,e=(65280&this.ambientColor)>>8,i=255&this.ambientColor,r=(16711680&this.diffuseColor)>>16,a=(65280&this.diffuseColor)>>8,s=255&this.diffuseColor
if(this.simulateSpecular){for(var o=0;204>o;){var n=Math.max(t,o*r/204),h=Math.max(e,o*a/204),l=Math.max(i,o*s/204)
n>255&&(n=255),h>255&&(h=255),l>255&&(l=255),this.palette[o++]=n<<16|h<<8|l}for(;256>o;){var n=Math.max(t,r+(o-204)*(255-r)/82),h=Math.max(e,a+(o-204)*(255-a)/82),l=Math.max(i,s+(o-204)*(255-s)/82)
n>255&&(n=255),h>255&&(h=255),l>255&&(l=255),this.palette[o++]=n<<16|h<<8|l}}else for(var o=0;256>o;){var n=Math.max(t,o*r/256),h=Math.max(e,o*a/256),l=Math.max(i,o*s/256),f=o/256,u=0,m=1,c=1+Math.exp(-Math.pow(2*f-u,2))*m
n*=c,h*=c,l*=c,n>255&&(n=255),h>255&&(h=255),l>255&&(l=255),this.palette[o++]=n<<16|h<<8|l}},JSC3D.Material.prototype.name="",JSC3D.Material.prototype.ambientColor=0,JSC3D.Material.prototype.diffuseColor=8355711,JSC3D.Material.prototype.specularColor=8355711,JSC3D.Material.prototype.ambientReflection=.2,JSC3D.Material.prototype.diffuseReflection=1,JSC3D.Material.prototype.specularReflection=0,JSC3D.Material.prototype.shininess=50,JSC3D.Material.prototype.transparency=0,JSC3D.Material.prototype.isLightingCast=!0,JSC3D.Material.prototype.isEnvironmentCast=!1,JSC3D.Material.prototype.simulateSpecular=!1,JSC3D.Material.prototype.palette=null,JSC3D.Texture=function(t,e){this.name=t||"",this.width=0,this.height=0,this.data=null,this.mipmaps=null,this.mipentries=null,this.hasTransparency=!1,this.isLightingCast=!0,this.isEnvironmentCast=!1,this.srcUrl="",this.onready=e&&"function"==typeof e?e:null},JSC3D.Texture.prototype.createFromUrl=function(t,e){var i=this,r=new Image
r.onload=function(){i.data=null,i.mipmaps=null,i.mipentries=null,i.width=0,i.height=0,i.hasTransparency=!1,i.srcUrl="",i.createFromImage(this,e),JSC3D.console&&JSC3D.console.logInfo('Finished loading texture image file "'+this.src+'".')},r.onerror=function(){i.data=null,i.mipmaps=null,i.mipentries=null,i.width=0,i.height=0,i.hasTransparency=!1,i.srcUrl="",JSC3D.console&&JSC3D.console.logWarning('Failed to load texture image file "'+this.src+'". This texture will be discarded.')},r.crossOrigin="anonymous",r.src=encodeURI(t)},JSC3D.Texture.prototype.createFromImage=function(t,e){if(!(t.width<=0||t.height<=0)){var i=!1,r=JSC3D.Texture.cv
if(!r)try{r=document.createElement("canvas"),JSC3D.Texture.cv=r,i=!0}catch(a){return}var s=t.width>t.height?t.width:t.height
s=16>=s?16:32>=s?32:64>=s?64:128>=s?128:256>=s?256:512>=s?512:1024,(r.width!=s||r.height!=s)&&(r.width=r.height=s,i=!0)
var o
try{var n=r.getContext("2d")
i||n.clearRect(0,0,s,s),n.drawImage(t,0,0,s,s)
var h=n.getImageData(0,0,s,s)
o=h.data}catch(a){return}var l=o.length/4
this.data=new Array(l)
for(var f,u=0,m=0;l>u;u++,m+=4)f=o[m+3],this.data[u]=f<<24|o[m]<<16|o[m+1]<<8|o[m+2],255>f&&(this.hasTransparency=!0)
this.width=s,this.height=s,this.mipmaps=null,e&&this.generateMipmaps(),this.srcUrl=t.src,null!=this.onready&&"function"==typeof this.onready&&this.onready()}},JSC3D.Texture.prototype.hasData=function(){return null!=this.data},JSC3D.Texture.prototype.generateMipmaps=function(){if(!(this.width<=1||null==this.data||null!=this.mipmaps)){this.mipmaps=[this.data],this.mipentries=[1]
for(var t=1+~~(.1+Math.log(this.width)*Math.LOG2E),e=this.width>>1,i=1;t>i;i++){for(var r=new Array(e*e),a=this.mipmaps[i-1],s=e<<1,o=0,n=0,h=0;e>h;h++){for(var l=0;e>l;l++){var f=a[o],u=a[o+1],m=a[o+s],c=a[o+s+1],p=((4278190080&f)>>>2)+((4278190080&u)>>>2)+((4278190080&m)>>>2)+((4278190080&c)>>>2)&4278190080,d=(16711680&f)+(16711680&u)+(16711680&m)+(16711680&c)>>2&16711680,v=(65280&f)+(65280&u)+(65280&m)+(65280&c)>>2&65280,g=(255&f)+(255&u)+(255&m)+(255&c)>>2&255
r[n]=p+d+v+g,o+=2,n++}o+=s}this.mipmaps.push(r),this.mipentries.push(Math.pow(4,i)),e>>=1}}},JSC3D.Texture.prototype.hasMipmap=function(){return null!=this.mipmaps},JSC3D.Texture.prototype.name="",JSC3D.Texture.prototype.data=null,JSC3D.Texture.prototype.mipmaps=null,JSC3D.Texture.prototype.mipentries=null,JSC3D.Texture.prototype.isLightingCast=!0,JSC3D.Texture.prototype.isEnvironmentCast=!1,JSC3D.Texture.prototype.width=0,JSC3D.Texture.prototype.height=0,JSC3D.Texture.prototype.hasTransparency=!1,JSC3D.Texture.prototype.srcUrl="",JSC3D.Texture.prototype.onready=null,JSC3D.Texture.cv=null,JSC3D.Light=function(t,e,i,r,a){var s=(16711680&r)>>16,o=(65280&r)>>8,n=255&r,h="number"==typeof i?i:s>>3&16711680|o>>3&65280|n>>3
this.name=t||"light",this.position=e||[0,0,0],this.transformedPosition=[0,0,0],this.ambientColor=h,this.diffuseColor=r,this.enabled=a},JSC3D.AABB=function(){this.minX=0,this.minY=0,this.minZ=0,this.maxX=0,this.maxY=0,this.maxZ=0},JSC3D.AABB.prototype.center=function(t){return t?(t[0]=.5*(this.minX+this.maxX),t[1]=.5*(this.minY+this.maxY),t[2]=.5*(this.minZ+this.maxZ)):t=[.5*(this.minX+this.maxX),.5*(this.minY+this.maxY),.5*(this.minZ+this.maxZ)],t},JSC3D.AABB.prototype.lengthOfDiagonal=function(){var t=this.maxX-this.minX,e=this.maxY-this.minY,i=this.maxZ-this.minZ
return Math.sqrt(t*t+e*e+i*i)},JSC3D.Matrix3x4=function(){this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m10=0,this.m11=1,this.m12=0,this.m13=0,this.m20=0,this.m21=0,this.m22=1,this.m23=0},JSC3D.Matrix3x4.prototype.identity=function(){this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m10=0,this.m11=1,this.m12=0,this.m13=0,this.m20=0,this.m21=0,this.m22=1,this.m23=0},JSC3D.Matrix3x4.prototype.scale=function(t,e,i){this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m10*=e,this.m11*=e,this.m12*=e,this.m13*=e,this.m20*=i,this.m21*=i,this.m22*=i,this.m23*=i},JSC3D.Matrix3x4.prototype.translate=function(t,e,i){this.m03+=t,this.m13+=e,this.m23+=i},JSC3D.Matrix3x4.prototype.rotateAboutXAxis=function(t){if(0!=t){t*=Math.PI/180
var e=Math.cos(t),i=Math.sin(t),r=e*this.m10-i*this.m20,a=e*this.m11-i*this.m21,s=e*this.m12-i*this.m22,o=e*this.m13-i*this.m23,n=e*this.m20+i*this.m10,h=e*this.m21+i*this.m11,l=e*this.m22+i*this.m12,f=e*this.m23+i*this.m13
this.m10=r,this.m11=a,this.m12=s,this.m13=o,this.m20=n,this.m21=h,this.m22=l,this.m23=f}},JSC3D.Matrix3x4.prototype.rotateAboutYAxis=function(t){if(0!=t){t*=Math.PI/180
var e=Math.cos(t),i=Math.sin(t),r=e*this.m00+i*this.m20,a=e*this.m01+i*this.m21,s=e*this.m02+i*this.m22,o=e*this.m03+i*this.m23,n=e*this.m20-i*this.m00,h=e*this.m21-i*this.m01,l=e*this.m22-i*this.m02,f=e*this.m23-i*this.m03
this.m00=r,this.m01=a,this.m02=s,this.m03=o,this.m20=n,this.m21=h,this.m22=l,this.m23=f}},JSC3D.Matrix3x4.prototype.rotateAboutZAxis=function(t){if(0!=t){t*=Math.PI/180
var e=Math.cos(t),i=Math.sin(t),r=e*this.m10+i*this.m00,a=e*this.m11+i*this.m01,s=e*this.m12+i*this.m02,o=e*this.m13+i*this.m03,n=e*this.m00-i*this.m10,h=e*this.m01-i*this.m11,l=e*this.m02-i*this.m12,f=e*this.m03-i*this.m13
this.m00=n,this.m01=h,this.m02=l,this.m03=f,this.m10=r,this.m11=a,this.m12=s,this.m13=o}},JSC3D.Matrix3x4.prototype.multiply=function(t){var e=t.m00*this.m00+t.m01*this.m10+t.m02*this.m20,i=t.m00*this.m01+t.m01*this.m11+t.m02*this.m21,r=t.m00*this.m02+t.m01*this.m12+t.m02*this.m22,a=t.m00*this.m03+t.m01*this.m13+t.m02*this.m23+t.m03,s=t.m10*this.m00+t.m11*this.m10+t.m12*this.m20,o=t.m10*this.m01+t.m11*this.m11+t.m12*this.m21,n=t.m10*this.m02+t.m11*this.m12+t.m12*this.m22,h=t.m10*this.m03+t.m11*this.m13+t.m12*this.m23+t.m13,l=t.m20*this.m00+t.m21*this.m10+t.m22*this.m20,f=t.m20*this.m01+t.m21*this.m11+t.m22*this.m21,u=t.m20*this.m02+t.m21*this.m12+t.m22*this.m22,m=t.m20*this.m03+t.m21*this.m13+t.m22*this.m23+t.m23
this.m00=e,this.m01=i,this.m02=r,this.m03=a,this.m10=s,this.m11=o,this.m12=n,this.m13=h,this.m20=l,this.m21=f,this.m22=u,this.m23=m},JSC3D.Matrix3x4.prototype.copy=function(t){var e=t.m00,i=t.m01,r=t.m02,a=t.m03,s=t.m10,o=t.m11,n=t.m12,h=t.m13,l=t.m20,f=t.m21,u=t.m22,m=t.m23
this.m00=e,this.m01=i,this.m02=r,this.m03=a,this.m10=s,this.m11=o,this.m12=n,this.m13=h,this.m20=l,this.m21=f,this.m22=u,this.m23=m},JSC3D.Math3D={transformVectors:function(t,e,i){for(var r=0;r<e.length;r+=3){var a=e[r],s=e[r+1],o=e[r+2]
i[r]=t.m00*a+t.m01*s+t.m02*o+t.m03,i[r+1]=t.m10*a+t.m11*s+t.m12*o+t.m13,i[r+2]=t.m20*a+t.m21*s+t.m22*o+t.m23}},transformVectorZs:function(t,e,i){for(var r=e.length/3,a=0,s=0;r>a;)i[a]=t.m20*e[s]+t.m21*e[s+1]+t.m22*e[s+2]+t.m23,a++,s+=3},normalizeVectors:function(t,e){for(var i=t.length,r=0;i>r;r+=3){var a=t[r],s=t[r+1],o=t[r+2],n=Math.sqrt(a*a+s*s+o*o)
n>0&&(n=1/n,a*=n,s*=n,o*=n),e[r]=a,e[r+1]=s,e[r+2]=o}}},JSC3D.LoaderSelector={registerLoader:function(t,e){"function"==typeof e&&(JSC3D.LoaderSelector.loaderTable[t]=e)},getLoader:function(t){var e=JSC3D.LoaderSelector.loaderTable[t.toLowerCase()]
if(!e)return null
var i
try{i=new e}catch(r){i=null}return i},loaderTable:{}},JSC3D.Util={ieXHRResponseBodyToString:function(t){for(var e=new VBArray(t).toArray(),i="",r=0;r<e.length-65536;r+=65536)i+=String.fromCharCode.apply(null,e.slice(r,r+65536))
return i+String.fromCharCode.apply(null,e.slice(r))},debounce:function(t,e){var i,r,a,s
return function(){a=this,r=[].slice.call(arguments,0),s=new Date
var o=function(){var n=new Date-s
e>n?i=setTimeout(o,e-n):(i=null,t.apply(a,r))}
i||(i=setTimeout(o,e))}}},JSC3D.PlatformInfo=function(){for(var t={browser:"other",version:"n/a",profile:"default",isTouchDevice:void 0!=document.createTouch,supportTypedArrays:void 0!=window.Uint32Array,supportWebGL:void 0!=window.WebGLRenderingContext},e=[["firefox",/Firefox[\/\s](\d+(?:\.\d+)*)/],["chrome",/Chrome[\/\s](\d+(?:\.\d+)*)/],["opera",/Opera[\/\s](\d+(?:\.\d+)*)/],["safari",/Safari[\/\s](\d+(?:\.\d+)*)/],["webkit",/AppleWebKit[\/\s](\d+(?:\.\d+)*)/],["ie",/MSIE[\/\s](\d+(?:\.\d+)*)/],["ie",/Trident\/\d+\.\d+;\s.*rv:(\d+(?:\.\d+)*)/]],i,r=0;r<e.length;r++)if(i=e[r][1].exec(window.navigator.userAgent)){t.browser=e[r][0],t.version=i[1]
break}for(var a=0,s=new Date,o=200;(new Date).getTime()-s<o;){for(var n=new Array,h=-180;180>h;h++)n.push(Math.cos(h*Math.PI/180))
n=null,a++}return a/=o,3>a&&(t.profile="low"),a>30&&(t.profile="high"),t}()