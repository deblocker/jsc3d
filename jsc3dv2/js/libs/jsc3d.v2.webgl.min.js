function throwOnGLError(e,r,i){JSC3D.console&&JSC3D.console.logError(WebGLDebugUtils.glEnumToString(e)+" in : "+r)}function logGLCall(e,r){JSC3D.console&&JSC3D.console.logInfo("gl."+e+"("+WebGLDebugUtils.glFunctionArgsToString(e,r)+")")}function validateNoneOfTheArgsAreUndefined(e,r){for(var i=0;i<r.length;++i)void 0===r[i]&&JSC3D.console&&JSC3D.console.logError("undefined passed to gl."+e+"("+WebGLDebugUtils.glFunctionArgsToString(e,r)+")")}function logAndValidate(e,r){validateNoneOfTheArgsAreUndefined(e,r)}var JSC3D=JSC3D||{}
JSC3D.WebGLRenderBackend=function(e,r){function i(e,r,i){var t=e.createShader(e.VERTEX_SHADER)
if(e.shaderSource(t,r),e.compileShader(t),!e.getShaderParameter(t,e.COMPILE_STATUS))return JSC3D.console&&JSC3D.console.logWarning("Error occured in shader compilation: "+e.getShaderInfoLog(t)+" The corresponding program will be ignored."),null
var o=e.createShader(e.FRAGMENT_SHADER)
if(e.shaderSource(o,i),e.compileShader(o),!e.getShaderParameter(o,e.COMPILE_STATUS))return JSC3D.console&&JSC3D.console.logWarning("Error occured in shader compilation: "+e.getShaderInfoLog(o)+" The corresponding program will be ignored."),null
var n=e.createProgram()
if(e.attachShader(n,t),e.attachShader(n,o),e.linkProgram(n),!e.getProgramParameter(n,e.LINK_STATUS))return JSC3D.console&&JSC3D.console.logWarning("Error occured when generating program: "+e.getProgramInfoLog(n)+" This program will be ignored."),null
n.attributes={}
for(var a=e.getProgramParameter(n,e.ACTIVE_ATTRIBUTES),s=0;a>s;s++){var l=e.getActiveAttrib(n,s)
n.attributes[l.name]=e.getAttribLocation(n,l.name)}n.uniforms={}
for(var f=e.getProgramParameter(n,e.ACTIVE_UNIFORMS),s=0;f>s;s++){var u=e.getActiveUniform(n,s)
n.uniforms[u.name]=e.getUniformLocation(n,u.name)}return n}if(this.canvas=e,this.isIE11="ie"==JSC3D.PlatformInfo.browser&&parseInt(JSC3D.PlatformInfo.version)>=11,this.gl=e.getContext("experimental-webgl",{preserveDrawingBuffer:!0})||e.getContext("webgl"),!this.gl)throw JSC3D.console&&JSC3D.console.logError("WebGLRenderBackend constructor failed: Cannot get WebGL context!"),"JSC3D.WebGLRenderBackend constructor failed: Cannot get WebGL context!"
"undefined"!=typeof WebGLDebugUtils&&(this.gl=WebGLDebugUtils.makeDebugContext(this.gl,throwOnGLError,logAndValidate)),this.definition="standard",this.isLightingOn=!1,this.bkgColors=[0,0],this.bkgTexture=null,this.frameWidth=this.canvas.width||0,this.frameHeight=this.canvas.height||0,this.backFB=null,this.pickingFB=null,this.pickingResult=new Uint8Array(4),this.releaseLocalBuffers=r||!1,this.screen_vs="#ifdef GL_ES \n  precision mediump float; \n#endif \n\nattribute vec2 a_position; \nvarying vec2 v_texCoord; \n\nvoid main(void) { \n   v_texCoord = vec2(0.5, 0.5) * a_position + vec2(0.5, 0.5); \n   gl_Position = vec4(a_position, 1.0, 1.0); \n}",this.screen_fs="#ifdef GL_ES \n  precision mediump float; \n#endif \n\nuniform sampler2D s_screenTexture; \nvarying vec2 v_texCoord; \n\nvoid main(void) { \n  gl_FragColor = texture2D(s_screenTexture, v_texCoord); \n}",this.gradient_background_vs="#ifdef GL_ES \n  precision mediump float; \n#endif \n\nuniform vec3 u_color1; \nuniform vec3 u_color2; \nattribute vec2 a_position; \nvarying vec4 v_color; \n\nvoid main(void) { \n  v_color = vec4(a_position.y > 0.0 ? u_color1 : u_color2, 1.0); \n  gl_Position = vec4(a_position, 1.0, 1.0); \n}",this.gradient_background_fs="#ifdef GL_ES \n  precision mediump float; \n#endif \n\nvarying vec4 v_color; \n\nvoid main(void) { \n  gl_FragColor = v_color;}",this.frame_vs="#ifdef GL_ES \n  precision mediump float; \n#endif \n\nuniform bool u_isPoint; \nuniform mat4 u_transformMatrix; \nattribute vec3 a_position; \n\nvoid main(void) { \n  if(u_isPoint) { \n    gl_PointSize = 2.0; \n  } \n  gl_Position = u_transformMatrix * vec4(a_position, 1.0); \n}",this.frame_fs="#ifdef GL_ES \n  precision mediump float; \n#endif \n\nuniform vec3 u_materialColor; \n\nvoid main(void) { \n  gl_FragColor = vec4(u_materialColor, 1.0); \n}",this.solid_vs="#ifdef GL_ES \n  precision mediump float; \n#endif \n\nuniform bool u_isLit; \nuniform bool u_isEnvCast; \nuniform bool u_hasTexture; \nuniform mat3 u_rotationMatrix; \nuniform mat4 u_transformMatrix; \nattribute vec3 a_position; \nattribute vec3 a_normal; \nattribute vec2 a_texCoord; \nvarying vec3 v_normal; \nvarying vec2 v_texCoord; \nvarying vec3 v_viewCoords; \n\nvoid main(void) { \n  vec4 tcoords = u_transformMatrix * vec4(a_position, 1.0); \n  v_viewCoords = tcoords.xyz; \n  if(u_isLit) { \n    v_normal = u_rotationMatrix * a_normal; \n  } \n  if(u_hasTexture) { \n    v_texCoord = a_texCoord; \n  } \n  gl_Position = tcoords; \n}",this.solid_fs="#ifdef GL_ES \n  precision mediump float; \n#endif \n\nstruct materialProperties { \n  vec3 ambient; \n  vec3 diffuse; \n  vec3 specular; \n  float ka; \n  float kd; \n  float ks; \n  float shininess; \n}; \nstruct lightProperties { \n  vec4 position; \n  vec3 ambient; \n  vec3 diffuse; \n  bool enabled; \n}; \nuniform bool u_isLit; \nuniform bool u_isLitCast; \nuniform vec3 u_globalAmbient; \nuniform bool u_isEnvCast; \nuniform bool u_hasTexture; \nuniform float u_opacity; \nuniform materialProperties material; \nuniform lightProperties light[10]; \nuniform sampler2D s_palette; \nuniform sampler2D s_texture; \nuniform sampler2D s_sphereTexture; \nvarying vec3 v_normal; \nvarying vec2 v_texCoord; \nvarying vec3 v_viewCoords; \n\nvec3 lighting(vec3 vertex, vec3 V, vec3 N) { \n  vec3 color = material.ambient + u_globalAmbient; \n  for (int i = 0; i < 6; i++) { \n    if (light[i].enabled) { \n      vec3 L = normalize(light[i].position.xyz - vertex); \n      float lambertian = max(dot(N, L), 0.0); \n      float specular = 0.0; \n      if(lambertian > 0.0) { \n        vec3 R = reflect(-L, N); \n        float specAngle = max(dot(R, V), 0.0); \n        specular = pow(specAngle, material.shininess); \n      } \n      color += material.ka * material.ambient * light[i].ambient + material.kd * lambertian * material.diffuse * light[i].diffuse + material.ks * specular * material.specular; \n    } \n  } \n  return color; \n} \n\nvoid main(void) { \n  vec4 materialColor = u_isLit ? u_isLitCast ? vec4(lighting(v_viewCoords, normalize(-v_viewCoords),v_normal), u_opacity) : vec4(texture2D(s_palette, vec2(abs(v_normal.z), 0.0)).rgb, u_opacity) : vec4(1.0, 1.0, 1.0, u_opacity); \n  if(u_isEnvCast) { \n    gl_FragColor = materialColor * texture2D(s_sphereTexture, vec2(0.5, -0.5) * v_normal.xy + vec2(0.5, 0.5)); \n  } \n  else { \n    gl_FragColor = u_hasTexture ? (materialColor * texture2D(s_texture, v_texCoord)) : materialColor; \n  } \n}",this.picking_vs="#ifdef GL_ES \n  precision mediump float; \n#endif \n\nuniform mat4 u_transformMatrix; \nattribute vec3 a_position; \n\nvoid main(void) { \n  gl_Position = u_transformMatrix * vec4(a_position, 1.0); \n}",this.picking_fs="#ifdef GL_ES \n  precision mediump float; \n#endif \n\nuniform vec3 u_pickingId; \n\nvoid main(void) { \n  gl_FragColor = vec4(u_pickingId, 1.0); \n}",this.programs={screen:i(this.gl,this.screen_vs,this.screen_fs),gradient_background:i(this.gl,this.gradient_background_vs,this.gradient_background_fs),frame:i(this.gl,this.frame_vs,this.frame_fs),solid:i(this.gl,this.solid_vs,this.solid_fs),picking:i(this.gl,this.picking_vs,this.picking_fs)},this.canvasBoard=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.canvasBoard),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,1,1,1,1,-1,1,-1,-1]),this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)},JSC3D.WebGLRenderBackend.prototype.setBackgroundColors=function(e,r){this.bkgColors=[new Float32Array([(16711680&e)/16777216,(65280&e)/65536,(255&e)/256])],e!=r&&this.bkgColors.push(new Float32Array([(16711680&r)/16777216,(65280&r)/65536,(255&r)/256]))},JSC3D.WebGLRenderBackend.prototype.setBackgroundImage=function(e){var r=this.gl
this.bkgTexture=r.createTexture(),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0),r.bindTexture(r.TEXTURE_2D,this.bkgTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindTexture(r.TEXTURE_2D,null),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!1)},JSC3D.WebGLRenderBackend.prototype.beginFrame=function(e,r,i,t){function o(e,r,i,t){e.bindFramebuffer(e.FRAMEBUFFER,r)
var o=e.createRenderbuffer()
e.bindRenderbuffer(e.RENDERBUFFER,o),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,i,t),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,o),e.bindRenderbuffer(e.RENDERBUFFER,null)
var n=e.createTexture()
e.bindTexture(e.TEXTURE_2D,n),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,i,t,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),r.width=i,r.height=t,r.texture=n,r.depthRB=o}function n(e,r){e.deleteRenderbuffer(r.depthRB),e.deleteTexture(r.texture),e.deleteFramebuffer(r)}var a=this.gl;(i!=this.frameWidth||t!=this.frameHeight)&&(JSC3D.console&&(JSC3D.console.logInfo("frameWidth: "+i+" - oldFrameWidth: "+this.frameWidth),JSC3D.console.logInfo("frameHeight: "+t+" - oldFrameHeight: "+this.frameHeight)),this.backFB&&(n(a,this.backFB),this.backFB=null),this.pickingFB&&(n(a,this.pickingFB),this.pickingFB=null)),this.frameWidth=i,this.frameHeight=t,this.pickingFB||(this.pickingFB=a.createFramebuffer(),o(a,this.pickingFB,this.canvas.width,this.canvas.height),a.bindFramebuffer(a.FRAMEBUFFER,null))
var s=this.canvas.width,l=this.canvas.height
switch(e){case"low":s>>=1,l>>=1
break
case"high":s*=2,l*=2
break
case"standard":}if(s!=this.canvas.width||l!=this.canvas.height?this.backFB?this.definition!=e?o(a,this.backFB,s,l):a.bindFramebuffer(a.FRAMEBUFFER,this.backFB):(this.backFB=a.createFramebuffer(),o(a,this.backFB,s,l)):this.backFB&&(n(a,this.backFB),this.backFB=null),this.definition=e,a.viewport(0,0,s,l),r)if(this.bkgTexture)a.frontFace(a.CCW),a.disable(a.DEPTH_TEST),a.clear(a.DEPTH_BUFFER_BIT),a.useProgram(this.programs.screen),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this.bkgTexture),a.uniform1i(this.programs.screen.uniforms.s_screenTexture,0),a.enableVertexAttribArray(0),a.bindBuffer(a.ARRAY_BUFFER,this.canvasBoard),a.vertexAttribPointer(0,2,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,6),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindTexture(a.TEXTURE_2D,null)
else if(this.bkgColors.length>1)a.frontFace(a.CCW),a.disable(a.DEPTH_TEST),a.clear(a.DEPTH_BUFFER_BIT),a.useProgram(this.programs.gradient_background),a.uniform3fv(this.programs.gradient_background.uniforms.u_color1,this.bkgColors[0]),a.uniform3fv(this.programs.gradient_background.uniforms.u_color2,this.bkgColors[1]),a.enableVertexAttribArray(0),a.bindBuffer(a.ARRAY_BUFFER,this.canvasBoard),a.vertexAttribPointer(0,2,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,6),a.bindBuffer(a.ARRAY_BUFFER,null)
else{var f=this.bkgColors[0]
a.clearColor(f[0],f[1],f[2],1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)}else a.clearColor(0,0,0,0),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)},JSC3D.WebGLRenderBackend.prototype.endFrame=function(){var e=this.gl
switch(e.bindFramebuffer(e.FRAMEBUFFER,null),this.definition){case"low":case"high":this.backFB&&(e.viewport(0,0,this.canvas.width,this.canvas.height),e.frontFace(e.CCW),e.disable(e.DEPTH_TEST),e.useProgram(this.programs.screen),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.backFB.texture),e.uniform1i(this.programs.screen.uniforms.s_screenTexture,0),e.enableVertexAttribArray(0),e.bindBuffer(e.ARRAY_BUFFER,this.canvasBoard),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLES,0,6),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindTexture(e.TEXTURE_2D,null))
break
case"standard":}e.flush()},JSC3D.WebGLRenderBackend.prototype.resizeFrame=function(e,r){(e!=this.frameWidth||r!=this.frameHeight)&&(this.endFrame(),this.canvas.width=e,this.canvas.height=r)},JSC3D.WebGLRenderBackend.prototype.render=function(e,r,i,t,o,n,a,s,l,f){function u(e){for(var r=[],i=[],t=0;t<e.length;t++){var n=e[t];(n.material||s).transparency>0||n.hasTexture()&&n.texture.hasTransparency?(n.c?n.aabb.center(n.c):n.c=n.aabb.center(),JSC3D.Math3D.transformVectors(o,n.c,n.c),i.push(n)):r.push(n)}return i.sort(function(e,r){return e.c[2]-r.c[2]}),i.length>0?r.concat(i):r}var m=this.gl,d=new Float32Array([o.m00,o.m10,o.m20,0,o.m01,o.m11,o.m21,0,o.m02,o.m12,o.m22,0,o.m03,o.m13,o.m23,1]),c=new Float32Array([n.m00,n.m10,n.m20,n.m01,n.m11,n.m21,n.m02,n.m12,n.m22]),_=new Float32Array([i.m00,i.m10,i.m20,0,i.m01,i.m11,i.m21,0,i.m02,i.m12,i.m22,0,i.m03,i.m13,i.m23,1]),E=new Float32Array([t.m00,t.m10,t.m20,t.m01,t.m11,t.m21,t.m02,t.m12,t.m22])
e=u(e),this.renderColorPass(e,r,_,E,d,c,a,s,l,f),this.pickingFB&&(m.bindFramebuffer(m.FRAMEBUFFER,this.pickingFB),this.renderPickingPass(e,_,d,s,f),m.bindFramebuffer(m.FRAMEBUFFER,null))},JSC3D.WebGLRenderBackend.prototype.pick=function(e,r){if(!this.pickingFB)return 0
var i=this.gl
return i.bindFramebuffer(i.FRAMEBUFFER,this.pickingFB),i.readPixels(e,this.pickingFB.height-r,1,1,i.RGBA,i.UNSIGNED_BYTE,this.pickingResult),i.bindFramebuffer(i.FRAMEBUFFER,null),this.pickingResult[0]<<16|this.pickingResult[1]<<8|this.pickingResult[2]},JSC3D.WebGLRenderBackend.prototype.renderColorPass=function(e,r,i,t,o,n,a,s,l,f){l&&l.hasData()&&!l.compiled&&this.compileTexture(l)
var u=this.gl
u.disable(u.BLEND),u.enable(u.DEPTH_TEST),u.depthMask(!0),u.frontFace(u.CCW)
for(var m=null,d=!1,c=0,_=r.length;_>c;c++){var E=r[c]
this.compileLight(E)}for(var b=0,h=e.length;h>b;b++){var T=e[b]
if(!T.isTrivial()&&T.visible){var R=T.material||s,p=T.hasTexture()?T.texture:null,g=R.transparency>0||p&&p.hasTransparency,A=1-R.transparency
R.compiled||this.compileMaterial(R),p&&!p.compiled&&this.compileTexture(p),f||T.isDoubleSided?u.disable(u.CULL_FACE):u.enable(u.CULL_FACE),g!=d&&(g?(u.depthMask(!1),u.enable(u.BLEND),u.blendFuncSeparate(u.SRC_ALPHA,u.ONE_MINUS_SRC_ALPHA,u.ONE,u.ONE)):(u.depthMask(!0),u.disable(u.BLEND)),d=g)
var v=T.material?T.material.isEnvironmentCast:!1,F=T.texture?T.texture.isEnvironmentCast:!1,x=v||F,B=x&&null!=l,C=T.renderMode||a,U
switch(C){case"point":case"wireframe":U=this.programs.frame
break
case"flat":case"smooth":U=this.programs.solid
break
case"texture":case"textureflat":p||(C="flat"),U=this.programs.solid
break
case"texturesmooth":p||B||(C="smooth"),U=this.programs.solid
break
default:C="flat",U=this.programs.solid}if(T.isPositionFixed&&(n=t,o=i),T.compiled&&T.compiled.remderMode==C||this.compileMesh(T,C),m!=U&&(u.useProgram(U),m=U),"undefined"!=typeof U.uniforms.u_isLitCast){u.uniform1i(U.uniforms.u_isLitCast,R.compiled.isLitCast),u.uniform3f(U.uniforms.u_globalAmbient,.1,.1,.1)
for(var c=0,_=r.length;_>c;c++){var E=r[c]
u.uniform1i(U.uniforms["light["+c+"].enabled"],E.enabled),u.uniform3fv(U.uniforms["light["+c+"].ambient"],E.compiled.ambient),u.uniform3fv(U.uniforms["light["+c+"].diffuse"],E.compiled.diffuse),u.uniform4fv(U.uniforms["light["+c+"].position"],E.compiled.position)}u.uniform3fv(U.uniforms["material.ambient"],R.compiled.ambColor),u.uniform3fv(U.uniforms["material.diffuse"],R.compiled.diffColor),u.uniform3fv(U.uniforms["material.specular"],R.compiled.specColor),u.uniform1f(U.uniforms["material.ka"],R.ambientReflection),u.uniform1f(U.uniforms["material.kd"],R.diffuseReflection),u.uniform1f(U.uniforms["material.ks"],R.specularReflection),u.uniform1f(U.uniforms["material.shininess"],R.shininess)}switch(C){case"point":u.uniform1i(U.uniforms.u_isPoint,!0),u.uniform3fv(U.uniforms.u_materialColor,R.compiled.diffColor),u.uniformMatrix4fv(U.uniforms.u_transformMatrix,!1,o),u.enableVertexAttribArray(U.attributes.a_position),u.bindBuffer(u.ARRAY_BUFFER,T.compiled.coords),u.vertexAttribPointer(U.attributes.a_position,3,u.FLOAT,!1,0,0),u.drawArrays(u.POINTS,0,T.compiled.coordCount)
break
case"wireframe":u.uniform1i(U.uniforms.u_isPoint,!1),u.uniform3fv(U.uniforms.u_materialColor,R.compiled.diffColor),u.uniformMatrix4fv(U.uniforms.u_transformMatrix,!1,o),u.enableVertexAttribArray(U.attributes.a_position),u.bindBuffer(u.ARRAY_BUFFER,T.compiled.edges),u.vertexAttribPointer(U.attributes.a_position,3,u.FLOAT,!1,0,0),u.drawArrays(u.LINES,0,T.compiled.edgeCount)
break
case"flat":case"smooth":u.uniform1i(U.uniforms.u_isLit,!0),u.uniform1i(U.uniforms.u_isEnvCast,!1),u.uniform1i(U.uniforms.u_hasTexture,!1),u.uniform1f(U.uniforms.u_opacity,A),u.uniformMatrix3fv(U.uniforms.u_rotationMatrix,!1,n),u.uniformMatrix4fv(U.uniforms.u_transformMatrix,!1,o),u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,R.compiled.palette),u.uniform1i(U.uniforms.s_palette,0),u.enableVertexAttribArray(U.attributes.a_position),u.bindBuffer(u.ARRAY_BUFFER,T.compiled.coords),u.vertexAttribPointer(U.attributes.a_position,3,u.FLOAT,!1,0,0),u.enableVertexAttribArray(U.attributes.a_normal),u.bindBuffer(u.ARRAY_BUFFER,T.compiled.normals),u.vertexAttribPointer(U.attributes.a_normal,3,u.FLOAT,!1,0,0),u.disableVertexAttribArray(U.attributes.a_texCoord),u.drawArrays(u.TRIANGLES,0,T.compiled.coordCount)
break
case"texture":u.uniform1i(U.uniforms.u_isLit,!1),u.uniform1i(U.uniforms.u_isEnvCast,!1),u.uniform1i(U.uniforms.u_hasTexture,!0),u.uniform1f(U.uniforms.u_opacity,A),u.uniformMatrix3fv(U.uniforms.u_rotationMatrix,!1,n),u.uniformMatrix4fv(U.uniforms.u_transformMatrix,!1,o),u.activeTexture(u.TEXTURE1),u.bindTexture(u.TEXTURE_2D,p.compiled.tex),u.uniform1i(U.uniforms.s_texture,1),u.enableVertexAttribArray(U.attributes.a_position),u.bindBuffer(u.ARRAY_BUFFER,T.compiled.coords),u.vertexAttribPointer(U.attributes.a_position,3,u.FLOAT,!1,0,0),u.disableVertexAttribArray(U.attributes.a_normal),u.enableVertexAttribArray(U.attributes.a_texCoord),u.bindBuffer(u.ARRAY_BUFFER,T.compiled.texcoords),u.vertexAttribPointer(U.attributes.a_texCoord,2,u.FLOAT,!1,0,0),u.drawArrays(u.TRIANGLES,0,T.compiled.coordCount)
break
case"textureflat":u.uniform1i(U.uniforms.u_isLit,!0),u.uniform1i(U.uniforms.u_isEnvCast,!1),u.uniform1i(U.uniforms.u_hasTexture,!0),u.uniform1f(U.uniforms.u_opacity,A),u.uniformMatrix3fv(U.uniforms.u_rotationMatrix,!1,n),u.uniformMatrix4fv(U.uniforms.u_transformMatrix,!1,o),u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,R.compiled.palette),u.uniform1i(U.uniforms.s_palette,0),u.activeTexture(u.TEXTURE1),u.bindTexture(u.TEXTURE_2D,p.compiled.tex),u.uniform1i(U.uniforms.s_texture,1),u.enableVertexAttribArray(U.attributes.a_position),u.bindBuffer(u.ARRAY_BUFFER,T.compiled.coords),u.vertexAttribPointer(U.attributes.a_position,3,u.FLOAT,!1,0,0),u.enableVertexAttribArray(U.attributes.a_normal),u.bindBuffer(u.ARRAY_BUFFER,T.compiled.normals),u.vertexAttribPointer(U.attributes.a_normal,3,u.FLOAT,!1,0,0),u.enableVertexAttribArray(U.attributes.a_texCoord),u.bindBuffer(u.ARRAY_BUFFER,T.compiled.texcoords),u.vertexAttribPointer(U.attributes.a_texCoord,2,u.FLOAT,!1,0,0),u.drawArrays(u.TRIANGLES,0,T.compiled.coordCount)
break
case"texturesmooth":u.uniform1i(U.uniforms.u_isLit,!0),u.uniform1i(U.uniforms.u_isEnvCast,B),u.uniform1i(U.uniforms.u_hasTexture,!B),u.uniform1f(U.uniforms.u_opacity,A),u.uniformMatrix3fv(U.uniforms.u_rotationMatrix,!1,n),u.uniformMatrix4fv(U.uniforms.u_transformMatrix,!1,o),u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,R.compiled.palette),u.uniform1i(U.uniforms.s_palette,0),B?(u.activeTexture(u.TEXTURE2),u.bindTexture(u.TEXTURE_2D,l.compiled.tex),u.uniform1i(U.uniforms.s_sphereTexture,2)):(u.activeTexture(u.TEXTURE1),u.bindTexture(u.TEXTURE_2D,p.compiled.tex),u.uniform1i(U.uniforms.s_texture,1)),u.enableVertexAttribArray(U.attributes.a_position),u.bindBuffer(u.ARRAY_BUFFER,T.compiled.coords),u.vertexAttribPointer(U.attributes.a_position,3,u.FLOAT,!1,0,0),u.enableVertexAttribArray(U.attributes.a_normal),u.bindBuffer(u.ARRAY_BUFFER,T.compiled.normals),u.vertexAttribPointer(U.attributes.a_normal,3,u.FLOAT,!1,0,0),B?u.disableVertexAttribArray(U.attributes.a_texCoord):(u.enableVertexAttribArray(U.attributes.a_texCoord),u.bindBuffer(u.ARRAY_BUFFER,T.compiled.texcoords),u.vertexAttribPointer(U.attributes.a_texCoord,2,u.FLOAT,!1,0,0)),u.drawArrays(u.TRIANGLES,0,T.compiled.coordCount)}}}},JSC3D.WebGLRenderBackend.prototype.renderPickingPass=function(e,r,i,t,o){var n=this.gl
n.disable(n.BLEND),n.enable(n.DEPTH_TEST),n.depthMask(!0),n.frontFace(n.CCW),n.viewport(0,0,this.pickingFB.width,this.pickingFB.height),n.clearColor(0,0,0,1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.useProgram(this.programs.picking)
for(var a=0;a<e.length;a++){var s=e[a]
if(!s.isTrivial()&&s.visible){var l=s.material||t
if(!(l.transparency>.99))switch(o||s.isDoubleSided?n.disable(n.CULL_FACE):n.enable(n.CULL_FACE),s.isPositionFixed&&(i=r),n.uniformMatrix4fv(this.programs.picking.uniforms.u_transformMatrix,!1,i),n.uniform3fv(this.programs.picking.uniforms.u_pickingId,s.compiled.pickingId),n.enableVertexAttribArray(this.programs.picking.attributes.a_position),s.compiled.remderMode){case"point":n.bindBuffer(n.ARRAY_BUFFER,s.compiled.coords),n.vertexAttribPointer(this.programs.picking.attributes.a_position,3,n.FLOAT,!1,0,0),n.drawArrays(n.POINTS,0,s.compiled.coordCount)
break
case"wireframe":n.bindBuffer(n.ARRAY_BUFFER,s.compiled.edges),n.vertexAttribPointer(this.programs.picking.attributes.a_position,3,n.FLOAT,!1,0,0),n.drawArrays(n.LINES,0,s.compiled.edgeCount)
break
case"flat":case"smooth":case"texture":case"textureflat":case"texturesmooth":default:n.bindBuffer(n.ARRAY_BUFFER,s.compiled.coords),n.vertexAttribPointer(this.programs.picking.attributes.a_position,3,n.FLOAT,!1,0,0),n.drawArrays(n.TRIANGLES,0,s.compiled.coordCount)}}}},JSC3D.WebGLRenderBackend.prototype.compileMesh=function(e,r){function i(e,r,i,t){var o,n,a,s
if(t){o=new Float32Array(18*i)
for(var l=0,f=0;l<e.length;l+=4,f+=18)n=3*e[l],a=3*e[l+1],s=3*e[l+2],o[f]=r[n],o[f+1]=r[n+1],o[f+2]=r[n+2],o[f+3]=r[a],o[f+4]=r[a+1],o[f+5]=r[a+2],o[f+6]=r[a],o[f+7]=r[a+1],o[f+8]=r[a+2],o[f+9]=r[s],o[f+10]=r[s+1],o[f+11]=r[s+2],o[f+12]=r[s],o[f+13]=r[s+1],o[f+14]=r[s+2],o[f+15]=r[n],o[f+16]=r[n+1],o[f+17]=r[n+2]}else{o=[]
for(var l=0,u=0;i>l;l++){for(n=3*e[u++],a=n;e[u]>0;)s=3*e[u++],o.push(r[a],r[a+1],r[a+2],r[s],r[s+1],r[s+2]),a=s
u++,o.push(r[a],r[a+1],r[a+2],r[n],r[n+1],r[n+2])}o=new Float32Array(o)}return o}if(e.isTrivial())return!1
r=e.renderMode||r
var t=this.gl,o="flat"==r||"textureflat"==r,n=e.indexBuffer.length==4*e.faceCount,a=e.texCoordBuffer&&e.texCoordBuffer.length>=2,s=e.indexBuffer,l=e.vertexBuffer,f=e.texCoordBuffer,u=e.texCoordIndexBuffer||s,m=e.vertexNormalBuffer,d=e.vertexNormalIndexBuffer||s,c=e.faceNormalBuffer,_=e.faceCount
if(e.compiled){var E="flat"==e.compiled.remderMode||"textureflat"==e.compiled.remderMode
if(E!=o){var b
if(n){b=new Float32Array(9*_)
for(var h,T,R,p=0,g=0,A=0;p<s.length;p+=4,g+=9,A++)o?(h=3*A,b[g]=b[g+3]=b[g+6]=c[h],b[g+1]=b[g+4]=b[g+7]=c[h+1],b[g+2]=b[g+5]=b[g+8]=c[h+2]):(h=3*d[p],T=3*d[p+1],R=3*d[p+2],b[g]=m[h],b[g+1]=m[h+1],b[g+2]=m[h+2],b[g+3]=m[T],b[g+4]=m[T+1],b[g+5]=m[T+2],b[g+6]=m[R],b[g+7]=m[R+1],b[g+8]=m[R+2])}else{b=[]
for(var h,T,R,p=0,g=0;_>p;p++){for(h=3*d[g++],T=3*d[g++];s[g]>=0;)o?(h=3*p,b.push(c[h],c[h+1],c[h+2],c[h],c[h+1],c[h+2],c[h],c[h+1],c[h+2])):(R=3*d[g],b.push(m[h],m[h+1],m[h+2],m[T],m[T+1],m[T+2],m[R],m[R+1],m[R+2]),T=R),g++
g++}b=new Float32Array(b)}this.isIE11?(t.deleteBuffer(e.compiled.normals),e.compiled.normals=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.compiled.normals),t.bufferData(t.ARRAY_BUFFER,b,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null)):(t.bindBuffer(t.ARRAY_BUFFER,e.compiled.normals),t.bufferSubData(t.ARRAY_BUFFER,0,b),t.bindBuffer(t.ARRAY_BUFFER,null))}}else{e.compiled={isIndexed:!1},e.compiled.pickingId=new Float32Array([(16711680&e.internalId)/16777216,(65280&e.internalId)/65536,(255&e.internalId)/256])
var v,F,x,b,B
if(n){x=new Float32Array(9*_),b=new Float32Array(9*_),a&&(B=new Float32Array(6*_))
for(var C,U,D,h,T,R,L,k,S,p=0,g=0,P=0,A=0;p<s.length;p+=4,g+=9,P+=6,A++)C=3*s[p],U=3*s[p+1],D=3*s[p+2],x[g]=l[C],x[g+1]=l[C+1],x[g+2]=l[C+2],x[g+3]=l[U],x[g+4]=l[U+1],x[g+5]=l[U+2],x[g+6]=l[D],x[g+7]=l[D+1],x[g+8]=l[D+2],o?(h=3*A,b[g]=b[g+3]=b[g+6]=c[h],b[g+1]=b[g+4]=b[g+7]=c[h+1],b[g+2]=b[g+5]=b[g+8]=c[h+2]):(h=3*d[p],T=3*d[p+1],R=3*d[p+2],b[g]=m[h],b[g+1]=m[h+1],b[g+2]=m[h+2],b[g+3]=m[T],b[g+4]=m[T+1],b[g+5]=m[T+2],b[g+6]=m[R],b[g+7]=m[R+1],b[g+8]=m[R+2]),a&&(L=2*u[p],k=2*u[p+1],S=2*u[p+2],B[P]=f[L],B[P+1]=f[L+1],B[P+2]=f[k],B[P+3]=f[k+1],B[P+4]=f[S],B[P+5]=f[S+1])}else{x=[],b=[],a&&(B=[])
for(var C,U,D,h,T,R,L,k,S,p=0,g=0;_>p;p++){for(C=3*s[g],U=3*s[g+1],h=3*d[g],T=3*d[g+1],a&&(L=2*u[g],k=2*u[g+1]),g+=2;s[g]>=0;)D=3*s[g],x.push(l[C],l[C+1],l[C+2],l[U],l[U+1],l[U+2],l[D],l[D+1],l[D+2]),U=D,o?(h=3*p,b.push(c[h],c[h+1],c[h+2],c[h],c[h+1],c[h+2],c[h],c[h+1],c[h+2])):(R=3*d[g],b.push(m[h],m[h+1],m[h+2],m[T],m[T+1],m[T+2],m[R],m[R+1],m[R+2]),T=R),a&&(S=2*u[g],B.push(f[L],f[L+1],f[k],f[k+1],f[S],f[S+1]),k=S),g++
g++}x=new Float32Array(x),b=new Float32Array(b),a&&(B=new Float32Array(B))}e.compiled.coords=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.compiled.coords),t.bufferData(t.ARRAY_BUFFER,x,t.STATIC_DRAW),e.compiled.normals=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.compiled.normals),t.bufferData(t.ARRAY_BUFFER,b,t.STATIC_DRAW),a&&(e.compiled.texcoords=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.compiled.texcoords),t.bufferData(t.ARRAY_BUFFER,B,t.STATIC_DRAW)),t.bindBuffer(t.ARRAY_BUFFER,null),e.compiled.faceCount=_,e.compiled.coordCount=x.length/3}if("wireframe"==r&&!e.compiled.edges){var F=i(s,l,_,n)
e.compiled.edges=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.compiled.edges),t.bufferData(t.ARRAY_BUFFER,F,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),e.compiled.edgeCount=F.length/3}return e.compiled.remderMode=r,!0},JSC3D.WebGLRenderBackend.prototype.compileMaterial=function(e){var r=this.gl
e.compiled={ambColor:new Float32Array([(16711680&e.ambientColor)/16777216,(65280&e.ambientColor)/65536,(255&e.ambientColor)/256]),diffColor:new Float32Array([(16711680&e.diffuseColor)/16777216,(65280&e.diffuseColor)/65536,(255&e.diffuseColor)/256]),specColor:new Float32Array([(16711680&e.specularColor)/16777216,(65280&e.specularColor)/65536,(255&e.specularColor)/256])}
for(var i=new Uint8Array(new Uint32Array(e.getPalette()).buffer),t=0;t<i.length;t+=4){var o=i[t]
i[t]=i[t+2],i[t+2]=o}return e.compiled.isLitCast=this.isLightingOn?e.isLightingCast:!1,e.compiled.palette=r.createTexture(),r.bindTexture(r.TEXTURE_2D,e.compiled.palette),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,256,1,0,r.RGBA,r.UNSIGNED_BYTE,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindTexture(r.TEXTURE_2D,null),!0},JSC3D.WebGLRenderBackend.prototype.compileTexture=function(e,r){if(!e.hasData())return!1
r=r||e.hasMipmap()
var i=this.gl
e.compiled={width:e.width,height:e.height,hasMipmap:r}
for(var t=new Uint8Array(new Uint32Array(e.data).buffer),o=0;o<t.length;o+=4){var n=t[o]
t[o]=t[o+2],t[o+2]=n}return e.compiled.tex=i.createTexture(),i.bindTexture(i.TEXTURE_2D,e.compiled.tex),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e.width,e.height,0,i.RGBA,i.UNSIGNED_BYTE,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,r?i.LINEAR_MIPMAP_NEAREST:i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT),r&&i.generateMipmap(i.TEXTURE_2D),i.bindTexture(i.TEXTURE_2D,null),!0},JSC3D.WebGLRenderBackend.prototype.compileLight=function(e){return e.compiled={diffuse:new Float32Array([(16711680&e.diffuseColor)/16777216,(65280&e.diffuseColor)/65536,(255&e.diffuseColor)/256]),ambient:new Float32Array([(16711680&e.ambientColor)/16777216,(65280&e.ambientColor)/65536,(255&e.ambientColor)/256]),position:new Float32Array([e.transformedPosition[0],e.transformedPosition[1],-e.transformedPosition[2],0])},!0},JSC3D.WebGLRenderBackend.prototype.isLightingOn=!1