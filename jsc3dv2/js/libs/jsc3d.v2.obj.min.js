var JSC3D=JSC3D||{}
JSC3D.ObjLoader=function(e,r,t,o){this.onload=e&&"function"==typeof e?e:null,this.onerror=r&&"function"==typeof r?r:null,this.onprogress=t&&"function"==typeof t?t:null,this.onresource=o&&"function"==typeof o?o:null,this.requestCount=0,this.requests=[]},JSC3D.ObjLoader.prototype.loadFromUrl=function(e){var r="",t=e,o="",n=e.indexOf("?")
n>=0&&(o=e.substring(n),t=e=e.substring(0,n))
var s=e.lastIndexOf("/");-1==s&&(s=e.lastIndexOf("\\")),-1!=s&&(r=e.substring(0,s+1),t=e.substring(s+1)),this.requestCount=0,this.loadObjFile(r,t,o)},JSC3D.ObjLoader.prototype.abort=function(){for(var e=0;e<this.requests.length;e++)this.requests[e].abort()
this.requests=[],this.requestCount=0},JSC3D.ObjLoader.prototype.loadObjFile=function(e,r,t){var o=e+r+t,n=this,s=new XMLHttpRequest
s.open("GET",encodeURI(o),!0),s.onreadystatechange=function(){if(4==this.readyState)if(200==this.status||0==this.status){if(n.onload){n.onprogress&&n.onprogress("Loading obj file ...",1),JSC3D.console&&JSC3D.console.logInfo('Finished loading obj file "'+o+'".')
var t=new JSC3D.Scene
t.srcUrl=o
var s=r.replace(/^.*(\\|\/|\:)/,"")
t.name=s.substr(0,s.lastIndexOf("."))||s+""
var a=n.parseObj(t,this.responseText)
if(a.length>0)for(var l=0;l<a.length;l++)n.loadMtlFile(t,e,a[l])
n.requests.splice(n.requests.indexOf(this),1),0==--n.requestCount&&n.onload(t)}}else n.requests.splice(n.requests.indexOf(this),1),n.requestCount--,JSC3D.console&&JSC3D.console.logError('Failed to load obj file "'+o+'".'),n.onerror&&n.onerror('Failed to load obj file "'+o+'".')},this.onprogress&&(this.onprogress("Loading obj file ...",0),s.onprogress=function(e){n.onprogress("Loading obj file ...",e.loaded/e.total)}),this.requests.push(s),this.requestCount++,s.send()},JSC3D.ObjLoader.prototype.loadMtlFile=function(e,r,t){var o=r+t,n=this,s=new XMLHttpRequest
s.open("GET",encodeURI(o),!0),s.onreadystatechange=function(){if(4==this.readyState){if(200==this.status||0==this.status){n.onprogress&&n.onprogress("Loading mtl file ...",1),JSC3D.console&&JSC3D.console.logInfo('Finished loading mtl file "'+o+'".')
for(var s=n.parseMtl(this.responseText),a={},l=e.getChildren(),i=0;i<l.length;i++){var u=l[i]
if(null!=u.mtl&&null!=u.mtllib&&u.mtllib==t){var f=s[u.mtl]
null!=f&&(null!=f.material&&u.setMaterial(f.material),""!=f.textureFileName&&(a[f.textureFileName]?a[f.textureFileName].push(u):a[f.textureFileName]=[u]))}}for(var d in a)n.setupTexture(a[d],r+d)}else JSC3D.console&&JSC3D.console.logWarning('Failed to load mtl file "'+o+'". A default material will be applied.')
n.requests.splice(n.requests.indexOf(this),1),0==--n.requestCount&&n.onload(e)}},this.onprogress&&(this.onprogress("Loading mtl file ...",0),s.onprogress=function(e){n.onprogress("Loading mtl file ...",e.loaded/e.total)}),this.requests.push(s),this.requestCount++,s.send()},JSC3D.ObjLoader.prototype.parseObj=function(e,r){var t={},o=[],n=e.name||"obj",s=0,a=null,l="",i="",u=[],f=[],d=new JSC3D.Mesh
d.name=n,d.groupIndex=s++,d.indexBuffer=[],t.nomtl=d,a=d
for(var h=r.split(/[ \t]*\r?\n[ \t]*/),p=0;p<h.length;p++){var g=h[p],x=g.split(/[ \t]+/)
if(x.length>0){var c=x[0]
switch(c){case"v":if(x.length>3)for(var C=1;4>C;C++)u.push(parseFloat(x[C]))
break
case"vn":break
case"vt":x.length>2&&(f.push(parseFloat(x[1])),f.push(1-parseFloat(x[2])))
break
case"f":if(x.length>3){for(var C=1;C<x.length;C++){var b=x[C].split("/"),v=parseInt(b[0])-1
a.indexBuffer.push(v),b.length>1&&(""!=b[1]?(a.texCoordIndexBuffer||(a.texCoordIndexBuffer=[]),a.texCoordIndexBuffer.push(parseInt(b[1])-1)):(b.length<3||""==b[2])&&(a.texCoordIndexBuffer||(a.texCoordIndexBuffer=[]),a.texCoordIndexBuffer.push(v)))}a.indexBuffer.push(-1),a.texCoordIndexBuffer&&a.texCoordIndexBuffer.push(-1)}break
case"g":if(x.length>1&&""!=x[1])var m=x[1]
break
case"mtllib":x.length>1?(l=x[1],o.push(l)):l=""
break
case"usemtl":if(x.length>1&&""!=x[1]){i=x[1]
var S=l+"-"+i,B=t[S]
B||(B=new JSC3D.Mesh,B.name=n,B.groupIndex=s++,B.indexBuffer=[],B.mtllib=l,B.mtl=i,t[S]=B),a=B}else i="",a=d
break
case"#":}}}var D=u.length>=3?new Array(u.length/3):null,J=f.length>=2?new Array(f.length/2):null
for(var I in t){var B=t[I]
if(u.length>=3&&B.indexBuffer.length>0){for(var p=0;p<D.length;p++)D[p]=-1
B.vertexBuffer=[]
for(var j=0,y=0,p=0;p<B.indexBuffer.length;p++)if(j=B.indexBuffer[p],-1!=j)if(-1==D[j]){var F=3*j
B.vertexBuffer.push(u[F]),B.vertexBuffer.push(u[F+1]),B.vertexBuffer.push(u[F+2]),B.indexBuffer[p]=y,D[j]=y,y++}else B.indexBuffer[p]=D[j]}if(f.length>=2&&null!=B.texCoordIndexBuffer&&B.texCoordIndexBuffer.length>0){for(var p=0;p<J.length;p++)J[p]=-1
B.texCoordBuffer=[]
for(var O=0,q=0,p=0;p<B.texCoordIndexBuffer.length;p++)if(O=B.texCoordIndexBuffer[p],-1!=O)if(-1==J[O]){var L=2*O
B.texCoordBuffer.push(f[L]),B.texCoordBuffer.push(f[L+1]),B.texCoordIndexBuffer[p]=q,J[O]=q,q++}else B.texCoordIndexBuffer[p]=J[O]}B.isTrivial()||e.addChild(B)}return o},JSC3D.ObjLoader.prototype.parseMtl=function(e){for(var r={},t="",o=e.split(/[ \t]*\r?\n[ \t]*/),n=0;n<o.length;n++){var s=o[n],a=s.split(/[ \t]+/)
if(a.length>0){var l=a[0]
switch(l){case"newmtl":t=a[1]
var i={}
i.material=new JSC3D.Material,i.material.name=t,i.textureFileName="",r[t]=i
break
case"Ka":case"ka":break
case"Kd":case"kd":if(4==a.length&&!isNaN(a[1])){var u=255*parseFloat(a[1])&255,f=255*parseFloat(a[2])&255,d=255*parseFloat(a[3])&255,i=r[t]
null!=i&&(i.material.diffuseColor=u<<16|f<<8|d)}break
case"Ks":case"ks":break
case"d":if(2==a.length&&!isNaN(a[1])){var h=parseFloat(a[1]),i=r[t]
null!=i&&(i.material.transparency=1-h)}break
case"illum":break
case"map_Kd":case"map_kd":if(2==a.length){var p=a[1],i=r[t]
null!=i&&(i.textureFileName=p)}break
case"#":}}}return r},JSC3D.ObjLoader.prototype.setupTexture=function(e,r){var t=this,o=new JSC3D.Texture
o.onready=function(){for(var r=0;r<e.length;r++)e[r].setTexture(this)
t.onresource&&t.onresource(this)},o.createFromUrl(r)},JSC3D.ObjLoader.prototype.onload=null,JSC3D.ObjLoader.prototype.onerror=null,JSC3D.ObjLoader.prototype.onprogress=null,JSC3D.ObjLoader.prototype.onresource=null,JSC3D.ObjLoader.prototype.requestCount=0