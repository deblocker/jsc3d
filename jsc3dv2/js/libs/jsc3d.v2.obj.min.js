var JSC3D=JSC3D||{}
JSC3D.ObjLoader=function(e,t,r,o){this.onload=e&&"function"==typeof e?e:null,this.onerror=t&&"function"==typeof t?t:null,this.onprogress=r&&"function"==typeof r?r:null,this.onresource=o&&"function"==typeof o?o:null,this.requestCount=0,this.requests=[],this.resourceRequestCount=0},JSC3D.ObjLoader.prototype.loadFromUrl=function(e){var t="",r=e,o="",s=e.indexOf("?")
s>=0&&(o=e.substring(s),r=e=e.substring(0,s))
var n=e.lastIndexOf("/");-1==n&&(n=e.lastIndexOf("\\")),-1!=n&&(t=e.substring(0,n+1),r=e.substring(n+1)),this.requestCount=0,this.resourceRequestCount=0,this.loadObjFile(t,r,o)},JSC3D.ObjLoader.prototype.abort=function(){for(var e=0;e<this.requests.length;e++)this.requests[e].abort()
this.requests=[],this.requestCount=0
for(var e=0;e<this.textureRequests.length;e++)this.textureRequests[e].abort()
this.resourceRequestCount=0},JSC3D.ObjLoader.prototype.loadObjFile=function(e,t,r){var o=e+t+r,s=this,n=new XMLHttpRequest
n.open("GET",encodeURI(o),!0),n.onreadystatechange=function(){if(4==this.readyState)if(200==this.status||0==this.status){if(s.onload){s.onprogress&&s.onprogress("Loading obj file ...",1),JSC3D.console&&JSC3D.console.logInfo('Finished loading obj file "'+o+'".')
var r=new JSC3D.Scene
r.srcUrl=o
var n=t.replace(/^.*(\\|\/|\:)/,"")
r.name=n.substr(0,n.lastIndexOf("."))||n+""
var a=s.parseObj(r,this.responseText)
if(a.length>0)for(var l=0;l<a.length;l++)s.loadMtlFile(r,e,a[l])
s.requests.splice(s.requests.indexOf(this),1),0==--s.requestCount&&s.onload(r)}}else s.requests.splice(s.requests.indexOf(this),1),s.requestCount--,JSC3D.console&&JSC3D.console.logError('Failed to load obj file "'+o+'".'),s.onerror&&s.onerror('Failed to load obj file "'+o+'".')},this.onprogress&&(this.onprogress("Loading obj file ...",0),n.onprogress=function(e){s.onprogress("Loading obj file ...",e.loaded/e.total)}),this.requests.push(n),this.requestCount++,n.send()},JSC3D.ObjLoader.prototype.loadMtlFile=function(e,t,r){var o=t+r,s=this,n=new XMLHttpRequest
n.open("GET",encodeURI(o),!0),n.onreadystatechange=function(){if(4==this.readyState){if(200==this.status||0==this.status){s.onprogress&&s.onprogress("Loading mtl file ...",1),JSC3D.console&&JSC3D.console.logInfo('Finished loading mtl file "'+o+'".')
for(var n=s.parseMtl(this.responseText),a={},l=e.getChildren(),u=0;u<l.length;u++){var i=l[u]
if(null!=i.mtl&&null!=i.mtllib&&i.mtllib==r){var f=n[i.mtl]
null!=f&&(null!=f.material&&i.setMaterial(f.material),""!=f.textureFileName&&(a[f.textureFileName]?a[f.textureFileName].push(i):a[f.textureFileName]=[i]))}}for(var d in a)s.textureRequestCount++
for(var d in a)s.setupTexture(a[d],t+d)}else JSC3D.console&&JSC3D.console.logWarning('Failed to load mtl file "'+o+'". A default material will be applied.')
s.requests.splice(s.requests.indexOf(this),1),0==--s.requestCount&&s.onload(e)}},this.onprogress&&(this.onprogress("Loading mtl file ...",0),n.onprogress=function(e){s.onprogress("Loading mtl file ...",e.loaded/e.total)}),this.requests.push(n),this.requestCount++,n.send()},JSC3D.ObjLoader.prototype.parseObj=function(e,t){var r={},o=[],s=e.name||"obj",n=0,a=null,l="",u="",i=[],f=[],d=new JSC3D.Mesh
d.name=s,d.groupIndex=n++,d.indexBuffer=[],r.nomtl=d,a=d
for(var h=t.split(/[ \t]*\r?\n[ \t]*/),p=0;p<h.length;p++){var c=h[p],g=c.split(/[ \t]+/)
if(g.length>0){var x=g[0]
switch(x){case"v":if(g.length>3)for(var C=1;4>C;C++)i.push(parseFloat(g[C]))
break
case"vn":break
case"vt":g.length>2&&(f.push(parseFloat(g[1])),f.push(1-parseFloat(g[2])))
break
case"f":if(g.length>3){for(var C=1;C<g.length;C++){var b=g[C].split("/"),v=parseInt(b[0])-1
a.indexBuffer.push(v),b.length>1&&(""!=b[1]?(a.texCoordIndexBuffer||(a.texCoordIndexBuffer=[]),a.texCoordIndexBuffer.push(parseInt(b[1])-1)):(b.length<3||""==b[2])&&(a.texCoordIndexBuffer||(a.texCoordIndexBuffer=[]),a.texCoordIndexBuffer.push(v)))}a.indexBuffer.push(-1),a.texCoordIndexBuffer&&a.texCoordIndexBuffer.push(-1)}break
case"g":if(g.length>1&&""!=g[1]){g[1]}break
case"mtllib":g.length>1?(l=g[1],o.push(l)):l=""
break
case"usemtl":if(g.length>1&&""!=g[1]){u=g[1]
var m=l+"-"+u,q=r[m]
q||(q=new JSC3D.Mesh,q.name=s,q.groupIndex=n++,q.indexBuffer=[],q.mtllib=l,q.mtl=u,r[m]=q),a=q}else u="",a=d
break
case"#":}}}var S=i.length>=3?Array(i.length/3):null,B=f.length>=2?Array(f.length/2):null
for(var D in r){var q=r[D]
if(i.length>=3&&q.indexBuffer.length>0){for(var p=0;p<S.length;p++)S[p]=-1
q.vertexBuffer=[]
for(var J=0,j=0,p=0;p<q.indexBuffer.length;p++)if(J=q.indexBuffer[p],-1!=J)if(-1==S[J]){var y=3*J
q.vertexBuffer.push(i[y]),q.vertexBuffer.push(i[y+1]),q.vertexBuffer.push(i[y+2]),q.indexBuffer[p]=j,S[J]=j,j++}else q.indexBuffer[p]=S[J]}if(f.length>=2&&null!=q.texCoordIndexBuffer&&q.texCoordIndexBuffer.length>0){for(var p=0;p<B.length;p++)B[p]=-1
q.texCoordBuffer=[]
for(var I=0,O=0,p=0;p<q.texCoordIndexBuffer.length;p++)if(I=q.texCoordIndexBuffer[p],-1!=I)if(-1==B[I]){var F=2*I
q.texCoordBuffer.push(f[F]),q.texCoordBuffer.push(f[F+1]),q.texCoordIndexBuffer[p]=O,B[I]=O,O++}else q.texCoordIndexBuffer[p]=B[I]}q.isTrivial()||e.addChild(q)}return o},JSC3D.ObjLoader.prototype.parseMtl=function(e){for(var t={},r="",o=e.split(/[ \t]*\r?\n[ \t]*/),s=0;s<o.length;s++){var n=o[s],a=n.split(/[ \t]+/)
if(a.length>0){var l=a[0]
switch(l){case"newmtl":r=a[1]
var u={}
u.material=new JSC3D.Material,u.material.name=r,u.textureFileName="",t[r]=u
break
case"Ka":case"ka":break
case"Kd":case"kd":if(4==a.length&&!isNaN(a[1])){var i=255*parseFloat(a[1])&255,f=255*parseFloat(a[2])&255,d=255*parseFloat(a[3])&255,u=t[r]
null!=u&&(u.material.diffuseColor=i<<16|f<<8|d)}break
case"Ks":case"ks":break
case"d":if(2==a.length&&!isNaN(a[1])){var h=parseFloat(a[1]),u=t[r]
null!=u&&(u.material.transparency=1-h)}break
case"illum":break
case"map_Kd":case"map_kd":if(2==a.length){var p=a[1],u=t[r]
null!=u&&(u.textureFileName=p)}break
case"#":}}}return t},JSC3D.ObjLoader.prototype.setupTexture=function(e,t){var r=this,o=new JSC3D.Texture
this.resourceRequestCount++,o.onready=function(){for(var t=0;t<e.length;t++)e[t].setTexture(this)
r.onresource&&r.onresource(this),0==--r.resourceRequestCount&&r.onresourcecomplete()},o.createFromUrl(t)},JSC3D.ObjLoader.prototype.onload=null,JSC3D.ObjLoader.prototype.onerror=null,JSC3D.ObjLoader.prototype.onprogress=null,JSC3D.ObjLoader.prototype.onresource=null,JSC3D.ObjLoader.prototype.requestCount=0,JSC3D.ObjLoader.prototype.resourceRequestCount=0