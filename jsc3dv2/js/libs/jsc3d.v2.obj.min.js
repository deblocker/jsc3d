var JSC3D=JSC3D||{}
JSC3D.ObjLoader=function(e,r,t,o){this.onload=e&&"function"==typeof e?e:null,this.onerror=r&&"function"==typeof r?r:null,this.onprogress=t&&"function"==typeof t?t:null,this.onresource=o&&"function"==typeof o?o:null,this.requestCount=0,this.requests=[],this.resourceRequestCount=0},JSC3D.ObjLoader.prototype.loadFromUrl=function(e){var r="",t=e,o="",s=e.indexOf("?")
s>=0&&(o=e.substring(s),t=e=e.substring(0,s))
var n=e.lastIndexOf("/");-1==n&&(n=e.lastIndexOf("\\")),-1!=n&&(r=e.substring(0,n+1),t=e.substring(n+1)),this.requestCount=0,this.resourceRequestCount=0,this.loadObjFile(r,t,o)},JSC3D.ObjLoader.prototype.abort=function(){for(var e=0;e<this.requests.length;e++)this.requests[e].abort()
this.requests=[],this.requestCount=0,this.resourceRequestCount=0},JSC3D.ObjLoader.prototype.loadObjFile=function(e,r,t){var o=e+r+t,s=this,n=new XMLHttpRequest
n.open("GET",encodeURI(o),!0),n.onreadystatechange=function(){if(4==this.readyState)if(200==this.status||0==this.status){if(s.onload){s.onprogress&&s.onprogress("Loading obj file ...",1),JSC3D.console&&JSC3D.console.logInfo('Finished loading obj file "'+o+'".')
var t=new JSC3D.Scene
t.srcUrl=o
var n=r.replace(/^.*(\\|\/|\:)/,"")
t.name=n.substr(0,n.lastIndexOf("."))||n+""
var a=s.parseObj(t,this.responseText)
if(a.length>0)for(var l=0;l<a.length;l++)s.loadMtlFile(t,e,a[l])
s.requests.splice(s.requests.indexOf(this),1),0==--s.requestCount&&s.onload(t)}}else s.requests.splice(s.requests.indexOf(this),1),s.requestCount--,JSC3D.console&&JSC3D.console.logError('Failed to load obj file "'+o+'".'),s.onerror&&s.onerror('Failed to load obj file "'+o+'".')},this.onprogress&&(this.onprogress("Loading obj file ...",0),n.onprogress=function(e){s.onprogress("Loading obj file ...",e.loaded/e.total)}),this.requests.push(n),this.requestCount++,n.send()},JSC3D.ObjLoader.prototype.loadMtlFile=function(e,r,t){var o=r+t,s=this,n=new XMLHttpRequest
n.open("GET",encodeURI(o),!0),n.onreadystatechange=function(){if(4==this.readyState){if(200==this.status||0==this.status){s.onprogress&&s.onprogress("Loading mtl file ...",1),JSC3D.console&&JSC3D.console.logInfo('Finished loading mtl file "'+o+'".')
for(var n=s.parseMtl(this.responseText),a={},l=e.getChildren(),i=0;i<l.length;i++){var u=l[i]
if(null!=u.mtl&&null!=u.mtllib&&u.mtllib==t){var f=n[u.mtl]
null!=f&&(null!=f.material&&u.setMaterial(f.material),""!=f.textureFileName&&(a[f.textureFileName]?a[f.textureFileName].push(u):a[f.textureFileName]=[u]))}}for(var d in a)s.resourceRequestCount++
for(var d in a)s.setupTexture(a[d],r+d)}else JSC3D.console&&JSC3D.console.logWarning('Failed to load mtl file "'+o+'". A default material will be applied.')
s.requests.splice(s.requests.indexOf(this),1),0==--s.requestCount&&s.onload(e)}},this.onprogress&&(this.onprogress("Loading mtl file ...",0),n.onprogress=function(e){s.onprogress("Loading mtl file ...",e.loaded/e.total)}),this.requests.push(n),this.requestCount++,n.send()},JSC3D.ObjLoader.prototype.parseObj=function(e,r){var t={},o=[],s=e.name||"obj",n=0,a=null,l="",i="",u=[],f=[],d=new JSC3D.Mesh
d.name=s,d.groupIndex=n++,d.indexBuffer=[],t.nomtl=d,a=d
for(var h=r.split(/[ \t]*\r?\n[ \t]*/),p=0;p<h.length;p++){var c=h[p],g=c.split(/[ \t]+/)
if(g.length>0){var x=g[0]
switch(x){case"v":if(g.length>3)for(var C=1;4>C;C++)u.push(parseFloat(g[C]))
break
case"vn":break
case"vt":g.length>2&&(f.push(parseFloat(g[1])),f.push(1-parseFloat(g[2])))
break
case"f":if(g.length>3){for(var C=1;C<g.length;C++){var b=g[C].split("/"),v=parseInt(b[0])-1
a.indexBuffer.push(v),b.length>1&&(""!=b[1]?(a.texCoordIndexBuffer||(a.texCoordIndexBuffer=[]),a.texCoordIndexBuffer.push(parseInt(b[1])-1)):(b.length<3||""==b[2])&&(a.texCoordIndexBuffer||(a.texCoordIndexBuffer=[]),a.texCoordIndexBuffer.push(v)))}a.indexBuffer.push(-1),a.texCoordIndexBuffer&&a.texCoordIndexBuffer.push(-1)}break
case"g":if(g.length>1&&""!=g[1]){g[1]}break
case"mtllib":g.length>1?(l=g[1],o.push(l)):l=""
break
case"usemtl":if(g.length>1&&""!=g[1]){i=g[1]
var m=l+"-"+i,S=t[m]
S||(S=new JSC3D.Mesh,S.name=s,S.groupIndex=n++,S.indexBuffer=[],S.mtllib=l,S.mtl=i,t[m]=S),a=S}else i="",a=d
break
case"#":}}}var q=u.length>=3?Array(u.length/3):null,B=f.length>=2?Array(f.length/2):null
for(var D in t){var S=t[D]
if(u.length>=3&&S.indexBuffer.length>0){for(var p=0;p<q.length;p++)q[p]=-1
S.vertexBuffer=[]
for(var J=0,j=0,p=0;p<S.indexBuffer.length;p++)if(J=S.indexBuffer[p],-1!=J)if(-1==q[J]){var y=3*J
S.vertexBuffer.push(u[y]),S.vertexBuffer.push(u[y+1]),S.vertexBuffer.push(u[y+2]),S.indexBuffer[p]=j,q[J]=j,j++}else S.indexBuffer[p]=q[J]}if(f.length>=2&&null!=S.texCoordIndexBuffer&&S.texCoordIndexBuffer.length>0){for(var p=0;p<B.length;p++)B[p]=-1
S.texCoordBuffer=[]
for(var I=0,O=0,p=0;p<S.texCoordIndexBuffer.length;p++)if(I=S.texCoordIndexBuffer[p],-1!=I)if(-1==B[I]){var F=2*I
S.texCoordBuffer.push(f[F]),S.texCoordBuffer.push(f[F+1]),S.texCoordIndexBuffer[p]=O,B[I]=O,O++}else S.texCoordIndexBuffer[p]=B[I]}S.isTrivial()||e.addChild(S)}return o},JSC3D.ObjLoader.prototype.parseMtl=function(e){for(var r={},t="",o=e.split(/[ \t]*\r?\n[ \t]*/),s=0;s<o.length;s++){var n=o[s],a=n.split(/[ \t]+/)
if(a.length>0){var l=a[0]
switch(l){case"newmtl":t=a[1]
var i={}
i.material=new JSC3D.Material,i.material.name=t,i.textureFileName="",r[t]=i
break
case"Ka":case"ka":break
case"Kd":case"kd":if(4==a.length&&!isNaN(a[1])){var u=255*parseFloat(a[1])&255,f=255*parseFloat(a[2])&255,d=255*parseFloat(a[3])&255,i=r[t]
null!=i&&(i.material.diffuseColor=u<<16|f<<8|d)}break
case"Ks":case"ks":break
case"d":if(2==a.length&&!isNaN(a[1])){var h=parseFloat(a[1]),i=r[t]
null!=i&&(i.material.transparency=1-h)}break
case"illum":break
case"map_Kd":case"map_kd":if(2==a.length){var p=a[1],i=r[t]
null!=i&&(i.textureFileName=p)}break
case"#":}}}return r},JSC3D.ObjLoader.prototype.setupTexture=function(e,r){var t=this,o=new JSC3D.Texture
this.resourceRequestCount++,o.onready=function(){for(var r=0;r<e.length;r++)e[r].setTexture(this)
t.onresource&&t.onresource(this),0==--t.resourceRequestCount&&t.onresourcecomplete()},o.createFromUrl(r)},JSC3D.ObjLoader.prototype.onload=null,JSC3D.ObjLoader.prototype.onerror=null,JSC3D.ObjLoader.prototype.onprogress=null,JSC3D.ObjLoader.prototype.onresource=null,JSC3D.ObjLoader.prototype.requestCount=0,JSC3D.ObjLoader.prototype.resourceRequestCount=0