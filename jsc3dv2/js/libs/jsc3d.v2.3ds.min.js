var JSC3D=JSC3D||{}
JSC3D.Autodesk3DSLoader=function(e,r,t,o){this.onload=e&&"function"==typeof e?e:null,this.onerror=r&&"function"==typeof r?r:null,this.onprogress=t&&"function"==typeof t?t:null,this.onresource=o&&"function"==typeof o?o:null,this.request=null,this._materials={},this._unfinalized_objects={},this._textures={},this._cur_obj_end=0,this._cur_obj=null,this._cur_mat_end=0,this._cur_mat=null,this.totalFaces=0},JSC3D.Autodesk3DSLoader.prototype.loadFromUrl=function(e){var r=this,t=new XMLHttpRequest
t.open("GET",encodeURI(e),!0),"ie"==JSC3D.PlatformInfo.browser?t.setRequestHeader("Accept-Charset","x-user-defined"):t.overrideMimeType("text/plain; charset=x-user-defined"),t.onreadystatechange=function(){if(4==this.readyState){if(200==this.status||0==this.status){if(JSC3D.console&&JSC3D.console.logInfo('Finished loading 3DS file "'+e+'".'),r.onload)if(r.onprogress&&r.onprogress("Loading 3DS file ...",1),"ie"==JSC3D.PlatformInfo.browser){var t=new JSC3D.Scene
t.srcUrl=e,r.parse3DS(t,JSC3D.Util.ieXHRResponseBodyToString(this.responseBody)),r.onload(t)}else{var t=new JSC3D.Scene
t.srcUrl=e,r.parse3DS(t,this.responseText),r.onload(t)}}else JSC3D.console&&JSC3D.console.logError('Failed to load 3DS file "'+e+'".'),r.onerror&&r.onerror('Failed to load 3DS file "'+e+'".')
r.request=null}},this.onprogress&&(this.onprogress("Loading 3DS file ...",0),t.onprogress=function(e){r.onprogress("Loading 3DS file ...",e.loaded/e.total)}),this.request=t,t.send()},JSC3D.Autodesk3DSLoader.prototype.abort=function(){this.request&&(this.request.abort(),this.request=null)},JSC3D.Autodesk3DSLoader.prototype.parseMaterial=function(e,r){for(var t={};e.tell()<r;){var o,a,s
switch(o=e.readUInt16(),a=e.readUInt32(),s=e.tell()+(a-6),o){case 40960:t.name=this.readNulTermString(e)
break
case 40976:t.ambientColor=this.readColor(e)
break
case 40992:t.diffuseColor=this.readColor(e)
break
case 41008:t.specularColor=this.readColor(e)
break
case 41040:t.transparency=this.readAmount(e,s)
break
case 41089:t.twoSided=!0
break
case 41472:t.colorMap=this.parseTexture(e,s)
break
case 41476:t.specularMap=this.parseTexture(e,s)
break
default:e.seek(s)}}return t},JSC3D.Autodesk3DSLoader.prototype.readAmount=function(e,r){var t,o,a=0
switch(t=e.readUInt16(),o=e.readUInt32(),t){case 48:a=e.readUInt16()}return e.seek(r),a},JSC3D.Autodesk3DSLoader.prototype.readColor=function(e){var r,t,o,a,s
switch(r=e.readUInt16(),t=e.readUInt32(),r){case 16:o=255*e.readFloat32(),a=255*e.readFloat32(),s=255*e.readFloat32()
break
case 17:o=e.readUInt8(),a=e.readUInt8(),s=e.readUInt8()
break
default:e.skip(t-6)}return o<<16|a<<8|s},JSC3D.Autodesk3DSLoader.prototype.parseTexture=function(e,r){for(var t={};e.tell()<r;){var o,a
switch(o=e.readUInt16(),a=e.readUInt32(),o){case 41728:t.url=this.readNulTermString(e)
break
default:e.skip(a-6)}}return this._textures[t.url]=t,t},JSC3D.Autodesk3DSLoader.prototype.readNulTermString=function(e){for(var r,t="";(r=e.readUInt8())>0;)t+=String.fromCharCode(r)
return t},JSC3D.Autodesk3DSLoader.prototype.parseVertexList=function(e){var r,t,o
for(o=e.readUInt16(),this._cur_obj.verts=new Array(3*o),r=0,t=this._cur_obj.verts.length;t>r;){var a,s,i
a=e.readFloat32(),s=e.readFloat32(),i=e.readFloat32(),this._cur_obj.verts[r++]=a,this._cur_obj.verts[r++]=i,this._cur_obj.verts[r++]=-s}},JSC3D.Autodesk3DSLoader.prototype.parseFaceList=function(e){var r,t,o
for(o=e.readUInt16(),this._cur_obj.facesCount=o,this._cur_obj.indices=[],this._cur_obj.uvsIndexes=[],r=0,t=3*o;t>r;){var a,s,i
a=e.readUInt16(),s=e.readUInt16(),i=e.readUInt16(),r+=3,this._cur_obj.indices.push(a),this._cur_obj.indices.push(i),this._cur_obj.indices.push(s),this._cur_obj.indices.push(-1),this._cur_obj.uvsIndexes.push(a),this._cur_obj.uvsIndexes.push(i),this._cur_obj.uvsIndexes.push(s),this._cur_obj.uvsIndexes.push(-1),e.skip(2)}this._cur_obj.smoothingGroups=[]
for(var n=0;n<this._cur_obj.facesCount;n++)this._cur_obj.smoothingGroups[n]=0},JSC3D.Autodesk3DSLoader.prototype.parseUVList=function(e){var r,t,o
for(o=e.readUInt16(),this._cur_obj.uvs=[],r=0,t=o;t>r;)this._cur_obj.uvs.push(e.readFloat32()),this._cur_obj.uvs.push(1-e.readFloat32()),r+=1},JSC3D.Autodesk3DSLoader.prototype.parseFaceMaterialList=function(e){var r,t,o,a=[]
r=this.readNulTermString(e),t=e.readUInt16()
for(var s=0;t>s;s++)a[s]=0
for(o=0;o<a.length;)a[o++]=e.readUInt16()
this._cur_obj.materials.push(r),this._cur_obj.materialFaces[r]=a},JSC3D.Autodesk3DSLoader.prototype.readTransform=function(e){for(var r=[],t=0;16>t;t++)r[t]=0
return r[0]=e.readFloat32(),r[2]=e.readFloat32(),r[1]=e.readFloat32(),r[3]=0,r[8]=e.readFloat32(),r[10]=e.readFloat32(),r[9]=e.readFloat32(),r[11]=0,r[4]=e.readFloat32(),r[6]=e.readFloat32(),r[5]=e.readFloat32(),r[7]=0,r[12]=e.readFloat32(),r[14]=e.readFloat32(),r[13]=e.readFloat32(),r[15]=1,r},JSC3D.Autodesk3DSLoader.prototype.parseObjectAnimation=function(e,r){var t,o,a,s,i
for(a={};e.tell()<r;){var n,u
switch(n=e.readUInt16(),u=e.readUInt32(),n){case 45072:s=this.readNulTermString(e),e.skip(4),i=e.readInt16()
break
case 45075:a.x=e.readFloat32(),a.z=e.readFloat32(),a.y=e.readFloat32()
break
default:e.skip(u-6)}}"$$$DUMMY"!=s&&this._unfinalized_objects.hasOwnProperty(s)&&(t=this._unfinalized_objects[s],JSC3D.console&&JSC3D.console.logInfo("Construct object "+t.name),o=null,o&&JSC3D.console&&JSC3D.console.logInfo("finished loading the object "+t.name),delete this._unfinalized_objects[s])},JSC3D.Autodesk3DSLoader.prototype.parseSmoothingGroups=function(e){for(var r=this._cur_obj.facesCount,t=0;r>t;)this._cur_obj.smoothingGroups[t]=e.readUInt32(),t++},JSC3D.Autodesk3DSLoader.prototype.finalizeCurrentMaterial=function(){var e=new JSC3D.Material
this._cur_mat.colorMap?e.textureFileName=this._cur_mat.colorMap.texture:e.diffuseColor=this._cur_mat.diffuseColor,e.ambientColor=this._cur_mat.ambientColor,e.specularColor=this._cur_mat.specularColor,e.bothSides=this._cur_mat.twoSided,this._materials[this._cur_mat.name]=this._cur_mat,this._cur_mat.material=e,this._cur_mat=null},JSC3D.Autodesk3DSLoader.prototype.setupTexture=function(e,r){var t=this,o=new JSC3D.Texture
o.onready=function(){for(var r=0;r<e.length;r++)e[r].setTexture(this)
t.onresource&&t.onresource(this)},o.createFromUrl(r)},JSC3D.Autodesk3DSLoader.prototype.parse3DS=function(e,r){var t=new JSC3D.Mesh
t.vertexBuffer=[],t.indexBuffer=[],t.faceNormalBuffer=[]
var o=new JSC3D.BinaryStream(r)
for(o.reset();!o.eof();){if(this._cur_mat&&o.tell()>=this._cur_mat_end)this.finalizeCurrentMaterial()
else if(this._cur_obj&&o.tell()>=this._cur_obj_end){JSC3D.console&&JSC3D.console.logInfo("Optimize the mesh and add it to the scene. "),t=new JSC3D.Mesh,t.faceCount=this._cur_obj.facesCount,t.name=this._cur_obj.name,t.vertexBuffer=this._cur_obj.verts,t.indexBuffer=this._cur_obj.indices,t.texCoordBuffer=this._cur_obj.uvs,t.texCoordIndexBuffer=this._cur_obj.uvsIndexes,t.material=new JSC3D.Material
var a=this._cur_obj.materialFaces,s=null
for(var i in a)s=this._materials[i],s.colorMap?(JSC3D.console&&JSC3D.console.logInfo("set texture: "+s.colorMap.url),this.setupTexture([t],s.colorMap.url)):t.material.diffuseColor=s.diffuseColor,t.isDoubleSided=!0,t.material.transparency=s.transparency>0?s.transparency/100:0
t.isTrivial()||(e.addChild(t),this.totalFaces+=t.faceCount),this._unfinalized_objects[this._cur_obj.name]=this._cur_obj,this._cur_obj_end=Number.MAX_VALUE,this._cur_obj=null}var n,u,l
switch(n=o.readUInt16(),u=o.readUInt32(),l=o.tell()+(u-6),n){case 19789:case 15677:case 45056:continue
case 45055:this._cur_mat_end=l,this._cur_mat=this.parseMaterial(o,l)
break
case 16384:this._cur_obj_end=l,this._cur_obj={},this._cur_obj.name=this.readNulTermString(o),this._cur_obj.materials=[],this._cur_obj.materialFaces=[]
break
case 16640:this._cur_obj.type="mesh"
break
case 16656:this.parseVertexList(o)
break
case 16672:this.parseFaceList(o)
break
case 16704:this.parseUVList(o)
break
case 16688:this.parseFaceMaterialList(o)
break
case 16736:this._cur_obj.transform=this.readTransform(o)
break
case 45058:this.parseObjectAnimation(o,l)
break
case 16720:this.parseSmoothingGroups(o)
break
default:o.skip(u-6)}}JSC3D.console&&(JSC3D.console.logInfo("3DS object was loaded !"),JSC3D.console.logInfo(" totalFaces="+this.totalFaces))},JSC3D.Autodesk3DSLoader.prototype.onload=null,JSC3D.Autodesk3DSLoader.prototype.onerror=null,JSC3D.Autodesk3DSLoader.prototype.onprogress=null,JSC3D.Autodesk3DSLoader.prototype.onresource=null,JSC3D.LoaderSelector.registerLoader("3ds",JSC3D.Autodesk3DSLoader)