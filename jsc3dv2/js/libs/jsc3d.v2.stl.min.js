var JSC3D=JSC3D||{}
JSC3D.StlLoader=function(e,r,o,t){this.onload=e&&"function"==typeof e?e:null,this.onerror=r&&"function"==typeof r?r:null,this.onprogress=o&&"function"==typeof o?o:null,this.onresource=t&&"function"==typeof t?t:null,this.decimalPrecision=3,this.request=null},JSC3D.StlLoader.prototype.loadFromUrl=function(e){var r=this,o="ie"==JSC3D.PlatformInfo.browser,t=!1,s=new XMLHttpRequest
s.open("GET",encodeURI(e),!0),t?s.responseType="blob":o?s.setRequestHeader("Accept-Charset","x-user-defined"):s.overrideMimeType("text/plain; charset=x-user-defined"),s.onreadystatechange=function(){if(4==this.readyState){if(200==this.status||0==this.status){if(JSC3D.console&&JSC3D.console.logInfo('Finished loading STL file "'+e+'".'),r.onload)if(r.onprogress&&r.onprogress("Loading STL file ...",1),t){var s=new FileReader
s.onload=function(o){var t=new JSC3D.Scene
t.srcUrl=e,r.parseStl(t,o.target.result),r.onload(t)},s.readAsText(this.response,"x-user-defined")}else if(o){var a=new JSC3D.Scene
a.srcUrl=e
try{r.parseStl(a,JSC3D.Util.ieXHRResponseBodyToString(this.responseBody))}catch(n){}r.onload(a)}else{var a=new JSC3D.Scene
a.srcUrl=e,r.parseStl(a,this.responseText),r.onload(a)}}else JSC3D.console&&JSC3D.console.logError('Failed to load STL file "'+e+'".'),r.onerror&&r.onerror('Failed to load STL file "'+e+'".')
r.request=null}},this.onprogress&&(this.onprogress("Loading STL file ...",0),s.onprogress=function(e){r.onprogress("Loading STL file ...",e.loaded/e.total)}),this.request=s,s.send()},JSC3D.StlLoader.prototype.abort=function(){this.request&&(this.request.abort(),this.request=null)},JSC3D.StlLoader.prototype.setDecimalPrecision=function(e){this.decimalPrecision=e},JSC3D.StlLoader.prototype.parseStl=function(e,r){var o=3,t=80,s=4,a=12,n=12,i=2,l=new JSC3D.Mesh
l.vertexBuffer=[],l.indexBuffer=[],l.faceNormalBuffer=[]
var f=!1,d=new JSC3D.BinaryStream(r)
d.skip(t+s)
for(var u=0;256>u&&!d.eof();u++)if(d.readUInt8()>127){f=!0
break}if(JSC3D.console&&JSC3D.console.logInfo("This is recognised as "+(f?"a binary":"an ASCII")+" STL file."),f){d.reset(),d.skip(t)
var c=d.readUInt32(),p=t+s+(a+n*o+i)*c
if(d.size()<p)return void(JSC3D.console&&JSC3D.console.logError("Failed to parse contents of the file. It seems not complete."))
l.faceCount=c
for(var h={},u=0;c>u;u++){l.faceNormalBuffer.push(d.readFloat32()),l.faceNormalBuffer.push(d.readFloat32()),l.faceNormalBuffer.push(d.readFloat32())
for(var S=0;o>S;S++){var v,b,x
v=d.readFloat32(),b=d.readFloat32(),x=d.readFloat32()
var C=v.toFixed(this.decimalPrecision)+"-"+b.toFixed(this.decimalPrecision)+"-"+x.toFixed(this.decimalPrecision),D=h[C]
void 0!=D?l.indexBuffer.push(D):(D=l.vertexBuffer.length/3,h[C]=D,l.vertexBuffer.push(v),l.vertexBuffer.push(b),l.vertexBuffer.push(x),l.indexBuffer.push(D))}l.indexBuffer.push(-1),d.skip(i)}}else{var m="facet\\s+normal\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+outer\\s+loop\\s+vertex\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+vertex\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+vertex\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+endloop\\s+endfacet",B=new RegExp(m,"ig"),J=r.match(B)
if(J){var c=J.length
l.faceCount=c
var h={}
B.lastIndex=0,B.global=!1
for(var g=B.exec(r);null!=g;g=B.exec(r)){l.faceNormalBuffer.push(parseFloat(g[1]),parseFloat(g[2]),parseFloat(g[3]))
for(var u=0;o>u;u++){var v=parseFloat(g[4+3*u]),b=parseFloat(g[5+3*u]),x=parseFloat(g[6+3*u]),C=v.toFixed(this.decimalPrecision)+"-"+b.toFixed(this.decimalPrecision)+"-"+x.toFixed(this.decimalPrecision),D=h[C]
void 0===D&&(D=l.vertexBuffer.length/3,h[C]=D,l.vertexBuffer.push(v),l.vertexBuffer.push(b),l.vertexBuffer.push(x)),l.indexBuffer.push(D)}l.indexBuffer.push(-1)}}}l.isTrivial()||(Math.abs(l.faceNormalBuffer[0])<1e-6&&Math.abs(l.faceNormalBuffer[1])<1e-6&&Math.abs(l.faceNormalBuffer[2])<1e-6&&(l.faceNormalBuffer=null),e.addChild(l))},JSC3D.StlLoader.prototype.onload=null,JSC3D.StlLoader.prototype.onerror=null,JSC3D.StlLoader.prototype.onprogress=null,JSC3D.StlLoader.prototype.onresource=null,JSC3D.StlLoader.prototype.decimalPrecision=3